---
order: 3
title: 3.ESæŸ¥è¯¢å¸¸ç”¨å®ä¾‹æ¼”ç¤º
tag: 
  - ElasticSearch
category: 
  - SpringBoot
  - æœç´¢ç³»åˆ—
  - ElasticSearch
date: 2022-04-18 19:43:19
keywords: 
  - SpringBoot
  - ElasticSearch
  - ES
---

æœ¬æ–‡å°†ä½œä¸ºesç³»åˆ—ç¬¬ä¸‰ç¯‡ï¼Œç»“åˆå¸¸è§çš„å®ä¾‹ï¼Œæ¥æ¼”ç¤ºä¸‹å¦‚ä½•é€šè¿‡`RestHighLevelClient`æ¥å®ç°esçš„å„ç§æŸ¥è¯¢æ”¯æŒ

<!-- more -->

## I. é¡¹ç›®æ­å»º

### 1. é¡¹ç›®ä¾èµ–

æœ¬é¡¹ç›®å€ŸåŠ©`SpringBoot 2.2.1.RELEASE` + `maven 3.5.3` + `IDEA`è¿›è¡Œå¼€å‘

å¼€ä¸€ä¸ªwebæœåŠ¡ç”¨äºæµ‹è¯•

```xml
<dependencies>
    <dependency>
        <groupId>org.elasticsearch.client</groupId>
        <artifactId>elasticsearch-rest-high-level-client</artifactId>
    </dependency>
</dependencies>
```

### 2. é…ç½®ä¿¡æ¯

é…ç½®æ–‡ä»¶application.ymlï¼Œæ³¨æ„ä¸‹é¢çš„é…ç½®ä¿¡æ¯ï¼Œä¸‹é¢é‡‡ç”¨çš„æ˜¯ç”±æˆ‘ä»¬è‡ªå·±æ¥è§£æé…ç½®çš„æ–¹å¼

```yaml
elasticsearch:
  host: localhost
  port: 9200
  user: elastic
  pwd: test123
  connTimeout: 3000
  socketTimeout: 5000
  connectionRequestTimeout: 500
```

## II. å®ä¾‹æ¼”ç¤º

### 0. å‡†å¤‡

åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆå‡†å¤‡æ’å…¥å‡ æ¡æ•°æ®ï¼Œè¿™é‡Œä¼šå€ŸåŠ©ä¸Šä¸€ç¯‡CURDåšæ–‡ä¸­çš„æ’å…¥æ¥å£

> * [ã€æœç´¢ç³»åˆ—ã€‘ESæ–‡æ¡£åŸºæœ¬æ“ä½œCURDå®ä¾‹æ¼”ç¤º | ä¸€ç°ç°Blog](https://spring.hhui.top/spring-blog/2022/03/31/220331-SpringBoot%E7%B3%BB%E5%88%97%E4%B9%8BES%E6%96%87%E6%A1%A3%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9CCURD%E5%AE%9E%E4%BE%8B%E6%BC%94%E7%A4%BA/)

åœ¨å¼€å§‹ä¹‹å‰å°±å‡†å¤‡ä¸¤æ¡æ•°æ®

```java
@Component
public class TermQueryDemo {
    private BasicCurdDemo basicCurdDemo;
    @Autowired
    private RestHighLevelClient client;
    @Autowired
    private RequestOptions requestOptions;

    private String TEST_ID = "11123-33345-66543-55231";
    private String TEST_ID_2 = "11123-33345-66543-55232";

    private String index = "term-demo";

    public TermQueryDemo(BasicCurdDemo basicCurdDemo) throws IOException {
        this.basicCurdDemo = basicCurdDemo;
        Map<String, Object> doc = newMap("name", "ä¸€ç°ç°", "age", 10, "skills", Arrays.asList("java", "python"), "site", "blog.hhui.top");
        basicCurdDemo.addDoc(index, doc, TEST_ID);
        doc = newMap("name", "äºŒç°ç°", "age", 16, "skills", Arrays.asList("js", "html"));
        basicCurdDemo.addDoc(index, doc, TEST_ID_2);
    }

    @PreDestroy
    public void remove() throws IOException {
        basicCurdDemo.delete(index, TEST_ID);
        basicCurdDemo.delete(index, TEST_ID_2);
    }
}
```

### 1. å…¨é‡æŸ¥è¯¢

å³æŸ¥è¯¢æ‰€æœ‰çš„æ–‡æ¡£ï¼Œå¦‚å€ŸåŠ©kibanançš„æ§åˆ¶å°ï¼Œå‘èµ·çš„è¯·æ±‚å½¢å¦‚

```json
GET index/_search
{
  "query": {
    "match_all": {}
  }
}
```

äºæ­¤å¯¹åº”çš„javaå®ç°å¦‚ä¸‹

```java
/**
 * å…¨é‡æŸ¥è¯¢
 *
 * @throws IOException
 */
private void queryAll() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    // æŸ¥è¯¢æ‰€æœ‰çš„æ–‡æ¡£
    searchSourceBuilder.query(QueryBuilders.matchAllQuery());
    searchRequest.source(searchSourceBuilder);

    SearchResponse searchResponse = client.search(searchRequest, requestOptions);
    System.out.println("mathAll: " + searchResponse.toString());
}
```

æ³¨æ„ä¸Šé¢çš„å®ç°ï¼š

- åˆå§‹åŒ–`SearchRequest`å®ä¾‹ï¼Œç”¨äºæ„å»ºè¯·æ±‚ç›¸å…³æ•°æ®
- `SearchSourceBuilder` æ¥å¡«å……æŸ¥è¯¢æ¡ä»¶
- `client.search(searchRequest, requestOptions)` æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¯·æ±‚å‚æ•°ï¼Œè¿™é‡Œä¸»è¦æ˜¯è®¾ç½®è¯·æ±‚æ—¶çš„æƒé™éªŒè¯ä¿¡æ¯

é€šå¸¸æ¥è¯´ï¼Œå®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸å¤ªå¯èƒ½å‡ºç°ä¸Šé¢è¿™ç§æ²¡æœ‰ä»»ä½•é™åˆ¶çš„æŸ¥å…¨é‡æ•°æ®ï¼Œå³ä¾¿çœŸçš„æœ‰æŸ¥å…¨é‡æ•°æ®çš„caseï¼Œæ›´å¸¸è§çš„æ˜¯åˆ†é¡µæŸ¥è¯¢ï¼Œå¦‚ä¸‹

```java
private void queryAll() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    int page = 1;
    //æ¯é¡µè®°å½•æ•°
    int size = 2;
    //è®¡ç®—å‡ºè®°å½•èµ·å§‹ä¸‹æ ‡
    int from = (page - 1) * size;
    //èµ·å§‹è®°å½•ä¸‹æ ‡ï¼Œä»0å¼€å§‹
    searchSourceBuilder.from(from);
    //æ¯é¡µæ˜¾ç¤ºçš„è®°å½•æ•°
    searchSourceBuilder.size(size);
    // æ ¹æ®ageå­—æ®µè¿›è¡Œå€’æ’
    searchSourceBuilder.sort(new FieldSortBuilder("age").order(SortOrder.DESC));
    // æŸ¥è¯¢æ‰€æœ‰çš„æ–‡æ¡£
    searchSourceBuilder.query(QueryBuilders.matchAllQuery());
    searchRequest.source(searchSourceBuilder);

    SearchResponse searchResponse = client.search(searchRequest, requestOptions);
    System.out.println("mathAll: " + searchResponse.toString());
}
```

### 2. æ ¹æ®Fieldå€¼ç²¾ç¡®æŸ¥è¯¢

å³esä¸­å¸¸è¯´çš„termæŸ¥è¯¢ï¼Œå…·ä½“å®ç°å¦‚ä¸‹

```java
/**
 * termç²¾ç¡®æŸ¥è¯¢
 *
 * @throws IOException
 */
private void term() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    // termQuery: ç²¾ç¡®æŸ¥è¯¢
    // SpanTermQuery: è¯è·æŸ¥è¯¢
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.termQuery("site", "blog.hhui.top"));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("term: " + response.toString());
}
```

ä»ä¸Šé¢çš„å®ç°ä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒæŸ¥è¯¢çš„å¥—è·¯æ²¡å•¥åŒºåˆ«ï¼Œæ— éå°±æ˜¯`SearchSourceBuilder`ä¸­çš„å‚æ•°æ„é€ ä¸ä¸€æ ·ï¼›ä¸Šé¢ä¸»è¦é€šè¿‡

- `QueryBuilders.termQuery("site", "blog.hhui.top")` æ¥æ„å»º termçš„æŸ¥è¯¢æ¡ä»¶ï¼Œè¡¨æ˜æŸ¥è¯¢ `site=blog.hhui.top` çš„æ–‡æ¡£

**ä¸­æ–‡æŸ¥è¯¢ä¸åˆ°é—®é¢˜**

åœ¨æˆ‘ä»¬å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¦‚æœvalueä¸ºä¸­æ–‡ï¼Œåœ¨æŸ¥è¯¢æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å‘½åæœ‰å¯¹åº”çš„æ•°æ®ï¼Œä½†æ˜¯å°±æŸ¥ä¸åˆ°ï¼Œä¸»è¦åŸå› å°±åœ¨äºåˆ†è¯ï¼Œå¦‚å¯¹äºä¸­æ–‡çš„æŸ¥è¯¢ï¼Œå¯ä»¥è€ƒè™‘ä¸‹é¢è¿™ç§æ–¹å¼

```java
private void term2() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    // å¯¹äºä¸­æ–‡æŸ¥è¯¢ï¼Œéœ€è¦æ³¨æ„åˆ†è¯çš„åœºæ™¯, å¦‚æœç›´æ¥ä½¿ç”¨ "name : ä¸€ç°ç°" çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢ï¼Œåˆ™å•¥ä¹Ÿä¸ä¼šè¿”å›
    // elasticsearch é‡Œé»˜è®¤çš„IKåˆ†è¯å™¨æ˜¯ä¼šå°†æ¯ä¸€ä¸ªä¸­æ–‡éƒ½è¿›è¡Œäº†åˆ†è¯çš„åˆ‡å‰²ï¼Œæ‰€ä»¥ä½ ç›´æ¥æƒ³æŸ¥ä¸€æ•´ä¸ªè¯ï¼Œæˆ–è€…ä¸€æ•´å¥è¯æ˜¯æ— è¿”å›ç»“æœçš„ã€‚
    // åœ¨æ­¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š keyword çš„æ–¹å¼æ¥å¤„ç†, è®¾ç½®å…³é”®è¯æœç´¢ï¼ˆä¸è¿›è¡Œåˆ†è¯ï¼‰
    searchSourceBuilder.query(QueryBuilders.termQuery("name.keyword", "ä¸€ç°ç°"));

    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("term2: " + response.toString());
}
```

### 3. Fieldå€¼inæŸ¥è¯¢

å¦å¤–ä¸€ä¸ªå¸¸è§çš„å°±æ˜¯å¤šå€¼æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ `field in (val1, val2...)`ï¼Œè¿™ä¸ªå¯¹åº”çš„å°±æ˜¯esä¸­çš„`terms`æŸ¥è¯¢

```java
/**
 * ç›¸å½“äºinæŸ¥è¯¢
 * {"terms": { "name": ["ä¸€ç°ç°", "äºŒç°ç°] }}
 *
 * @throws IOException
 */
private void multTerm() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.termsQuery("name.keyword", "ä¸€ç°ç°", "äºŒç°ç°"));

    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("term: " + response.toString());
}
```

### 4. èŒƒå›´æŸ¥è¯¢

å¯¹äºæ•°å€¼ç±»å‹çš„Fieldï¼ŒåŒæ ·æ˜¯æ”¯æŒæ¯”è¾ƒã€èŒƒå›´æŸ¥è¯¢çš„ï¼Œå¯¹åº”çš„æ˜¯esä¸­ `range`

```java
/**
 * èŒƒå›´æŸ¥è¯¢
 * { "range": { "age": { "gt":8, "lt": 12 } }}
 *
 * @throws IOException
 */
private void range() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.rangeQuery("age").gt(8).lt(12));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("range: " + response.toString());
}
```

æ³¨æ„ä¸Šé¢çš„æŸ¥è¯¢æœ‰æ¡ä»¶

- `QueryBuilders.rangeQuery("age").gt(8).lt(12)`
- è¡¨ç¤ºæŸ¥è¯¢ `age > 8 && age < 12`
- gte: è¡¨ç¤º >=
- lte: è¡¨ç¤º <=

### 5. Fieldæ˜¯å¦å­˜åœ¨æŸ¥è¯¢

esä¸åŒäºmysqlçš„åœ¨äºå®ƒçš„fieldå¯ä»¥åŠ¨æ€æ–°å¢ï¼Œå½“æˆ‘ä»¬å¸Œæœ›æŸ¥è¯¢åŒ…å«æŸä¸ªå­—æ®µçš„æ–‡æ¡£æ—¶ï¼Œå¯ä»¥è€ƒè™‘ `exists`

```java
/**
 * æ ¹æ®å­—æ®µæ˜¯å¦å­˜åœ¨æŸ¥è¯¢
 *
 * @throws IOException
 */
private void exists() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.existsQuery("site"));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("exists: " + response.toString());
}
```

### 6. æ¨¡ç³ŠæŸ¥è¯¢

esä½œä¸ºæœç´¢å¼•æ“ï¼Œæ›´å¸¸è§çš„æ˜¯æ¨¡ç³ŠåŒ¹é…ï¼Œæ¯”å¦‚matchæŸ¥è¯¢

```java
/**
   * æ ¹æ®å­—æ®µåŒ¹é…æŸ¥è¯¢
   *
   * @throws IOException
   */
  private void match() throws IOException {
      SearchRequest searchRequest = new SearchRequest(index);
      searchRequest.types("_doc");

      SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
      searchSourceBuilder.query(QueryBuilders.matchQuery("name", "ç°"));
      searchRequest.source(searchSourceBuilder);
      SearchResponse response = client.search(searchRequest, requestOptions);
      System.out.println("matchQuery: " + response.toString());
  }
```

å¤šFieldä¸­è¿›è¡ŒæŸ¥è¯¢

```java
/**
 * å¤šå­—æ®µä¸­æŸ¥è¯¢
 *
 * @throws IOException
 */
private void multiMatch() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.multiMatchQuery("ç°", "name", "site"));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("multiMatchQuery: " + response.toString());
}
```

åœ¨esçš„è¯­æ³•æ”¯æŒä¸­ï¼Œé™¤äº†matchï¼Œè¿˜æœ‰ä¸€ä¸ª`wildcard`ï¼Œå¯ä»¥ä½¿ç”¨`?`æ¥ä»£æŒ‡å•å­—ç¬¦ï¼Œ`*`æ¥ä»£æŒ‡0..nå­—ç¬¦

```java
/**
 * æ¨¡ç³ŠæŸ¥è¯¢ ? å•å­—ç¬¦  * 0..nå­—ç¬¦
 *
 * @throws IOException
 */
private void wild() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.wildcardQuery("site", "*top"));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("wildcard: " + response.toString());
}
```

### 7. æ­£åˆ™åŒ¹é…

```java
private void regexp() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.regexpQuery("site", ".*hhui.*"));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("regexpQuery: " + response.toString());
}
```

### 8. å‰ç¼€æŸ¥è¯¢

```java
private void prefix() throws IOException {
    SearchRequest searchRequest = new SearchRequest(index);
    searchRequest.types("_doc");

    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
    searchSourceBuilder.query(QueryBuilders.prefixQuery("site", "blog"));
    searchRequest.source(searchSourceBuilder);
    SearchResponse response = client.search(searchRequest, requestOptions);
    System.out.println("prefixQuery: " + response.toString());
}
```

### 9.å°ç»“

æœ¬æ–‡è™½ç„¶ä»‹ç»äº†ä¸€äº›å¸¸è§çš„æŸ¥è¯¢caseï¼Œä½†æ³¨æ„å¹¶ä¸ä»…ä»…åªæœ‰è¿™äº›ï¼Œæ¯”å¦‚

- æŸ¥è¯¢æŒ‡å®šFeildçš„å†…å®¹
- æ’åº
- åˆ†ç»„èšåˆ
- å¤šæŸ¥è¯¢æ¡ä»¶ç»„åˆï¼šand/or
- é«˜äº®
- ...

æ›´å¤šçš„ä½¿ç”¨å®ä¾‹ï¼Œæ•¬è¯·æœŸå¾…...ï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„å°ä¼™ä¼´ï¼Œç‚¹èµæ”¶è—è¯„è®ºä¸€æ³¢ğŸ˜

## III. ä¸èƒ½é”™è¿‡çš„æºç å’Œç›¸å…³çŸ¥è¯†ç‚¹

### 0. é¡¹ç›®

**ç³»åˆ—åšæ–‡**

* [SpringBootç³»åˆ—ä¹‹ESåŸºæœ¬é¡¹ç›®æ­å»º](https://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247487412&idx=1&sn=9d8afecd4dc4dcc2a016a89709a4cf34&chksm=fce71418cb909d0e59e4599a4460642614104c3d254b691165f0f3630f198458073e908714a3&token=1796894300&lang=zh_CN#rd)
* [SpringBootä¹‹ESæ–‡æ¡£åŸºæœ¬æ“ä½œCURDå®ä¾‹æ¼”ç¤º](https://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247487420&idx=1&sn=3d64361be03a95631e1c50f6d84ab5f3&chksm=fce71410cb909d069d43a59541933284b231a694620d31b8ba46065bd43c15c049e2b2c1bdb1&token=623887797&lang=zh_CN#rd)


**æºç **


- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç ï¼š[https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/142-search-es](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/142-search-es)

### 1. å¾®ä¿¡å…¬ä¼—å·: ä¸€ç°ç°Blog

å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œä»¥ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œéš¾å…æœ‰ç–æ¼å’Œé”™è¯¯ä¹‹å¤„ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œä¸åæ„Ÿæ¿€

ä¸‹é¢ä¸€ç°ç°çš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€›

- ä¸€ç°ç°Blogä¸ªäººåšå®¢ [https://blog.hhui.top](https://blog.hhui.top)
- ä¸€ç°ç°Blog-Springä¸“é¢˜åšå®¢ [http://spring.hhui.top](http://spring.hhui.top)


![ä¸€ç°ç°blog](https://spring.hhui.top/spring-blog/imgs/info/info.png)

