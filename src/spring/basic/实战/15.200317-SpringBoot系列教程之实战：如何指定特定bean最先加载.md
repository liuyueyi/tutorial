---
order: 15
title: 4.å¦‚ä½•æŒ‡å®šbeanæœ€å…ˆåŠ è½½(åº”ç”¨ç¯‡)
banner: /imgs/200317/logo.jpg
tag: 
  - Bean
  - Order
category: 
  - SpringBoot
  - åŸºç¡€ç³»åˆ—
  - Bean
  - åº”ç”¨ç¯‡
date: 2020-03-17 16:32:10
keywords: bean order ä¼˜å…ˆçº§ InstantiationAwareBeanPostProcessorAdapter @Import
---

åœ¨æ—¥å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œç»å¤§å¤šæ•°æˆ‘ä»¬éƒ½æ˜¯ä¸å…³æ³¨beançš„åŠ è½½é¡ºåºï¼Œç„¶è€Œå¦‚æœåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå½“æˆ‘ä»¬å¸Œæœ›æŸä¸ªbeanä¼˜äºå…¶ä»–çš„beanè¢«å®ä¾‹åŒ–æ—¶ï¼Œå¾€å¾€å¹¶æ²¡æœ‰æˆ‘ä»¬æƒ³è±¡ä¸­çš„é‚£ä¹ˆç®€å•

<!-- more -->

## I. å¯åŠ¨ç±»æŒ‡å®šæ–¹å¼

åœ¨å®é™…çš„SpringBootå¼€å‘ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“éƒ½ä¼šæœ‰ä¸€ä¸ªå¯åŠ¨ç±»ï¼Œå¦‚æœå¸Œæœ›æŸä¸ªç±»è¢«ä¼˜å…ˆåŠ è½½ï¼Œä¸€ä¸ªæˆæœ¬æœ€ä½çš„ç®€å•å®ç°ï¼Œå°±æ˜¯åœ¨å¯åŠ¨ç±»é‡Œæ·»åŠ ä¸Šä¾èµ–

```java
@SpringBootApplication
public class Application {

    public Application(DemoBean demoBean) {
        demoBean.print();
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

è¯·æ³¨æ„ä¸Šé¢çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨åº”ç”¨å¯åŠ¨ä¹‹å‰ï¼Œ`demoBean`å°±å·²ç»è¢«åŠ è½½äº†ï¼Œé‚£å°±è®©Applicationå¼ºåˆ¶ä¾èµ–å®ƒï¼Œæ‰€ä»¥å†Applicationçš„beanåˆå§‹åŒ–ä¹‹å‰ï¼Œè‚¯å®šä¼šä¼˜å…ˆå®ä¾‹åŒ–`demoBean`

ç›¸ä¿¡ä¸Šé¢è¿™ç§å†™æ³•ï¼Œå¤§å®¶å¹¶ä¸ä¼šé™Œç”Ÿï¼Œç‰¹åˆ«æ˜¯å½“æˆ‘ä»¬åº”ç”¨å¯åŠ¨ä¹‹åï¼Œå‘ç°æŸä¸ªä¾èµ–çš„beanï¼ˆä¸€èˆ¬æ¥è®²æ˜¯ç¬¬ä¸‰æ–¹åº“æä¾›çš„beanï¼‰è¿˜æ²¡æœ‰åˆå§‹åŒ–å¯¼è‡´npeæ—¶ï¼Œç”¨è¿™ç§æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒå¤šçš„

**case1**

æˆ‘ä»¬ä¸”ä¸è°ˆè¿™ç§å®ç°æ–¹å¼æ˜¯å¦ä¼˜é›…ï¼Œå½“æˆ‘ä»¬å¸Œæœ›`targetBean`åœ¨æ‰€æœ‰çš„beanå®ä¾‹åŒ–ä¹‹å‰è¢«å®ä¾‹æ—¶ï¼Œä¸Šé¢è¿™ç§å†™æ³•æ˜¯å¦ä¸€å®šä¼šç”Ÿæ•ˆå‘¢ï¼Ÿ

**case2**

ä¸­é—´ä»¶åŒå­¦ï¼šå­å“§å­å“§çš„å¼€å‘äº†ä¸€ä¸ªğŸ‚ğŸºjaråŒ…ï¼Œåªè¦æ¥å…¥äº†ä¿è¯ä½ çš„åº”ç”¨æ°¸è¿œä¸ä¼šå®•æœºï¼ˆè¯·æ— è§†å¤¸å¼ çš„è¨€è¯­ï¼‰,å”¯ä¸€çš„è¦æ±‚æ˜¯æ¥å…¥æ—¶ï¼Œéœ€è¦ä¼˜å…ˆåŠ è½½jaråŒ…é‡Œé¢çš„`firstBean`... 

æ¥å…¥æ–¹ï¼šä½ çš„beanè¦æ±‚è¢«é¦–å…ˆåŠ è½½è¿™ä¸ªå¾—ä½ è‡ªå·±ä¿è¯å•Šï¼Œæˆ‘å†™äº›if/elseä»£ç å·²ç»å¾ˆè¾›è‹¦äº†ï¼Œå“ªæœ‰ç²¾åŠ›ä¿è¯ä½ çš„è¿™ä¸ªä¼˜å…ˆåŠ è½½ï¼ï¼ï¼ä½ è‡ªå·±éƒ½æ²¡æ³•ä¿è¯ï¼Œé‚£æˆ‘ä¹Ÿæ²¡åŠæ³•ä¿è¯...

ä¸­é—´ä»¶åŒå­¦ï¼šè¿˜èƒ½ä¸èƒ½æ„‰å¿«çš„ç©è€äº†....

## II. `InstantiationAwareBeanPostProcessorAdapter`æ–¹å¼

> åœ¨çœ‹ä¸‹æ–‡çš„å®ç°ä¹‹å‰ï¼Œå¢™è£‚æ¨èå…ˆçœ‹ä¸€ä¸‹åšæ–‡: [ã€SpringBootåŸºç¡€ç³»åˆ—ã€‘æŒ‡å®šBeanåˆå§‹åŒ–é¡ºåºçš„è‹¥å¹²å§¿åŠ¿](http://spring.hhui.top/spring-blog/2019/10/29/191029-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8BBean%E4%B9%8B%E6%8C%87%E5%AE%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F%E7%9A%84%E8%8B%A5%E5%B9%B2%E5%A7%BF%E5%8A%BF/)

æ¥ä¸‹æ¥ä»‹ç»å¦å¤–ä¸€ç§ä½¿ç”¨å§¿åŠ¿ï¼Œå€ŸåŠ©`InstantiationAwareBeanPostProcessorAdapter`æ¥å®ç°åœ¨beanå®ä¾‹åŒ–ä¹‹å‰ä¼˜å…ˆåŠ è½½ç›®æ ‡bean

**å£°æ˜**

- æˆ‘ä¸ªäººè®¤ä¸ºä¸‹é¢è¿™ç§ä½¿ç”¨æ–¹å¼ï¼Œä¾ç„¶å¾ˆä¸ä¼˜é›…ï¼Œå¦‚æœ‰æ›´å¥½æ–¹å¼ï¼Œæ³è¯·å¤§ä½¬ç•™è¨€å‘ŠçŸ¥
- æˆ‘ä¸ªäººè®¤ä¸ºä¸‹é¢è¿™ç§ä½¿ç”¨æ–¹å¼ï¼Œä¾ç„¶å¾ˆä¸ä¼˜é›…ï¼Œå¦‚æœ‰æ›´å¥½æ–¹å¼ï¼Œæ³è¯·å¤§ä½¬ç•™è¨€å‘ŠçŸ¥
- æˆ‘ä¸ªäººè®¤ä¸ºä¸‹é¢è¿™ç§ä½¿ç”¨æ–¹å¼ï¼Œä¾ç„¶å¾ˆä¸ä¼˜é›…ï¼Œå¦‚æœ‰æ›´å¥½æ–¹å¼ï¼Œæ³è¯·å¤§ä½¬ç•™è¨€å‘ŠçŸ¥

### 1. åœºæ™¯åˆ†æ

å‡è®¾æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªé…ç½®è¯»å–çš„å·¥å…·åŒ…ï¼Œä½†æ˜¯ä¸åŒçš„åº”ç”¨å¯èƒ½å¯¹é…ç½®çš„å­˜å‚¨æœ‰ä¸åŒçš„è¦æ±‚ï¼Œæ¯”å¦‚æœ‰çš„é…ç½®å­˜åœ¨æœ¬åœ°ï¼Œæœ‰çš„å­˜åœ¨dbï¼Œæœ‰çš„é€šè¿‡httpæ–¹å¼è¿œç¨‹è·å–ï¼›è€Œè¿™äº›å­˜å‚¨æ–¹å¼å‘¢ï¼Œé€šè¿‡`application.yml`é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®å‚æ•°`config.save.mode`æ¥æŒ‡å®š

è¿™ä¸ªå·¥å…·åŒ…å‘¢ï¼Œä¼šåšä¸€ä»¶äº‹æƒ…ï¼Œæ‰«æåº”ç”¨ç¨‹åºçš„æ‰€æœ‰ç±»ï¼Œå¹¶æ³¨å…¥é…ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨ä¹‹å‰ï¼Œè¿™ä¸ªå·¥å…·åŒ…å°±å·²ç»ä»æ•°æ®æºè·å–åˆ°äº†é…ç½®ä¿¡æ¯ï¼Œè€Œè¿™åˆè¦æ±‚å…ˆè·å–åº”ç”¨åˆ°åº•æ˜¯ç”¨çš„å“ªä¸ªæ•°æ®æº

ç®€å•æ¥è®²ï¼Œå°±æ˜¯å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºå·¥ä½œä¹‹å‰ï¼Œ`DatasourceLoader`è¿™ä¸ªbeanå·²ç»è¢«å®ä¾‹åŒ–äº†

-- æ’æ’­ä¸€å¥ï¼Œä¸Šé¢è¿™ä¸ªcaseï¼Œæ­£æ˜¯æˆ‘åœ¨ç­¹å¤‡çš„`SpringBootå®æˆ˜æ•™ç¨‹--ä»0åˆ°1åˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„é…ç½®ä¸­å¿ƒ`çš„å…·ä½“åº”ç”¨åœºæ™¯

### 2. å¸¸è§„æµç¨‹

æ–°å»ºä¸€ä¸ªSpringBooté¡¹ç›®å·¥ç¨‹ï¼Œæºç ä¸­springbootç‰ˆæœ¬ä¸º`2.2.1.RELEASE`

é¦–å…ˆæˆ‘ä»¬æ¥å®šä¹‰è¿™ä¸ªç›®æ ‡bean: `DatasourceLoader`

```java
public class DatasourceLoader {

    @Getter
    private String mode;

    public DatasourceLoader(Environment environment) {
        this.mode = environment.getProperty("config.save.mode");
        System.out.println("init DatasourceLoader for:" + mode);
    }

    @PostConstruct
    public void loadResourcres() {
        System.out.println("å¼€å§‹åˆå§‹åŒ–èµ„æº");
    }
}
```

å› ä¸ºè¿™ä¸ªå·¥ç¨‹ä¸»è¦æ˜¯ä¾›ç¬¬ä¸‰æ–¹ä½¿ç”¨ï¼Œæ‰€ä»¥æŒ‰ç…§SpringBootçš„é€šå¸¸ç©æ³•ï¼Œå£°æ˜ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»

```java
@Configuration
public class ClientAutoConfiguration {
    @Bean
    public DatasourceLoader propertyLoader(Environment environment) {
        return new DatasourceLoader(environment);
    }
}
```

ç„¶ååœ¨èµ„æºç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ `META-INF`ï¼Œåˆ›å»ºæ–‡ä»¶`spring.factories`ï¼Œå†…å®¹å¦‚ä¸‹

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.git.hui.boot.client.ClientAutoConfiguration
```

ç„¶åä½¿ç”¨æ–¹æ·»åŠ ä¾èµ–ï¼Œå°±å®Œäº†ï¼Ÿï¼Ÿï¼Ÿ


ä¸Šé¢è¿™å¥—æµç¨‹ï¼Œå±äºä¸€èˆ¬çš„å·¥å…·åŒ…å†™æ³•äº†ï¼Œè¯·æ³¨æ„ï¼Œè¿™ç§æ–¹å¼ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åº”ç”¨ç¨‹åºå†…å£°æ˜çš„beanåŠ è½½å®Œæ¯•ä¹‹åï¼Œæ‰ä¼šåŠ è½½ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ä¸­å£°æ˜çš„beanï¼›ä¹Ÿå°±æ˜¯è¯´é€šè¿‡ä¸Šé¢çš„å†™æ³•ï¼Œ`DatasourceLoader`å¹¶ä¸ä¼šè¢«ä¼˜å…ˆåŠ è½½ï¼Œä¹Ÿè¾¾ä¸åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼ˆåº”ç”¨éƒ½å¼€å§‹æœåŠ¡äº†ï¼Œç»“æœæ‰€æœ‰çš„é…ç½®éƒ½æ˜¯null)

### 3. ç‰¹æ®Šå†™æ³•

æ¥ä¸‹æ¥æˆ‘ä»¬å€ŸåŠ©æ‰€æœ‰çš„beanåœ¨å®ä¾‹åŒ–ä¹‹å‰ï¼Œä¼šä¼˜å…ˆæ£€æµ‹æ˜¯å¦å­˜åœ¨`InstantiationAwareBeanPostProcessor`æ¥å£è¿™ä¸ªç‰¹ç‚¹ï¼Œæ¥å®ç°`DatasourceLoader`çš„ä¼˜å…ˆåŠ è½½

```java
public class ClientBeanProcessor extends InstantiationAwareBeanPostProcessorAdapter implements BeanFactoryAware {

    private ConfigurableListableBeanFactory beanFactory;

    @Override
    public void setBeanFactory(BeanFactory beanFactory) {
        if (!(beanFactory instanceof ConfigurableListableBeanFactory)) {
            throw new IllegalArgumentException(
                    "AutowiredAnnotationBeanPostProcessor requires a ConfigurableListableBeanFactory: " + beanFactory);
        }

        this.beanFactory = (ConfigurableListableBeanFactory) beanFactory;
        // é€šè¿‡ä¸»åŠ¨è°ƒç”¨beanFactory#getBeanæ¥æ˜¾ç¤ºå®ä¾‹åŒ–ç›®æ ‡bean
        DatasourceLoader propertyLoader = this.beanFactory.getBean(DatasourceLoader.class);
        System.out.println(propertyLoader);
    }
}
```

ä¸Šé¢çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå€ŸåŠ©`beanFactory#getBean`æ¥æ‰‹åŠ¨è§¦å‘beançš„å®ä¾‹ï¼Œé€šè¿‡å®ç°`BeanFactoryAware`æ¥å£æ¥è·å–`BeanFactory`ï¼Œå› ä¸ºå®ç°`InstantiationAwareBeanPostProcessor`æ¥å£çš„ç±»ä¼šä¼˜å…ˆäºBeanè¢«å®ä¾‹ï¼Œä»¥æ­¤æ¥é—´æ¥çš„è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„

> å…³äºä¸Šé¢è¿™ä¸€å¥—æµç¨‹åˆ†æ, è¯·å…³æ³¨å¾®ä¿¡å…¬ä¼—å·/ä¸ªäººåšå®¢ç«™ç‚¹ï¼Œé™å¾…æºç åˆ†æç¯‡


æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è®©å®ƒç”Ÿæ•ˆäº†ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨Importæ³¨è§£æ¥å®ç°

```java
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@Import({ClientAutoConfiguration.class, ClientBeanProcessor.class})
public @interface EnableOrderClient {
}
```

è¯·æ³¨æ„ä¸Šé¢çš„æ³¨è§£ä¸­ï¼Œå¯¼å…¥ä¸Šé¢çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œå’Œ`ClientBeanProcessor`ï¼Œæ‰€ä»¥ä¸Šä¸€èŠ‚ä¸­çš„`spring.factories`æ–‡ä»¶å¯ä»¥ä¸éœ€è¦å“¦


### 4. æµ‹è¯•

ä¸Šé¢çš„ä¸»è¦æµç¨‹å°±å®Œäº‹äº†ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦è¿›å…¥æµ‹è¯•ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œæ·»åŠ ä¾èµ–

å…ˆåŠ ä¸€ä¸ªdemoBean

```java
@Component
public class DemoBean {

    public DemoBean() {
        System.out.println("demo bean init!");
    }

    public void print() {
        System.out.println("print demo bean ");
    }
}
```

ç„¶åæ˜¯å¯åŠ¨ç±»ï¼Œ `@EnableOrderClient`è¿™ä¸ªæ³¨è§£å¿…é¡»å¾—æœ‰å“¦

```java
@EnableOrderClient
@SpringBootApplication
public class Application {

    public Application(DemoBean demoBean) {
        demoBean.print();
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

åœ¨æˆ‘ä»¬å¯åŠ¨ä¹‹å‰ï¼Œè¯·çŒœæµ‹ä¸€ä¸‹ï¼Œ`DemoBean`å’Œ`DatasourceLoader`è¿™é‡Œè¿™ä¸¤ä¸ªbeanï¼Œè°ä¼šä¼˜å…ˆè¢«å®ä¾‹åŒ–ï¼Ÿ

ä¸‹é¢æ˜¯è¾“å‡ºç»“æœ

![](/imgs/200317/00.jpg)

ä»ä¸Šé¢çš„ä¸¤ä¸ªçº¢æ¡†è¾“å‡ºï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬çš„å¯åŠ¨ç±»æŒ‡å®šæ–¹å¼ä¾èµ–çš„beanï¼Œå¹¶ä¸ä¸€å®šä¼šæœ€å…ˆè¢«åŠ è½½å“¦


### 5. å°ç»“

æœ€åå°ç»“ä¸€ä¸‹ï¼Œæœ¬æ–‡æå‡ºäº†ä¸¤ç§è®©beanä¼˜å…ˆåŠ è½½çš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯åœ¨å¯åŠ¨ç±»çš„æ„é€ æ–¹æ³•ä¸­æ·»åŠ ä¾èµ–ï¼Œä¸€ä¸ªæ˜¯å€ŸåŠ©`InstantiationAwareBeanPostProcessorAdapter`åœ¨beanå®ä¾‹åŒ–ä¹‹å‰è¢«åˆ›å»ºçš„ç‰¹ç‚¹ï¼Œç»“åˆ`BeanFactory`æ¥æ‰‹åŠ¨è§¦å‘ç›®æ ‡beançš„åˆ›å»º

æœ€åé€šè¿‡`@Import`æ³¨è§£è®©æˆ‘ä»¬çš„`BeanPostProcessorAdapter`ç”Ÿæ•ˆ


**æœ‰çŸ¥é“å…¶ä»–æ–¹å¼çš„å¤§ä½¬ï¼Œè¯·ä¸åèµæ•™å•Š**


## II. å…¶ä»–

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç ï¼š
	- [https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-case/008-bean-order/](https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-case/008-bean-order/)
	- [https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-case/008-bean-order-client](https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-case/008-bean-order-client)

