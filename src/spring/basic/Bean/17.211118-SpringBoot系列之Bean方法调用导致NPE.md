---
order: 17
title: 17.SpringContext.getBean()æ–¹æ³•è°ƒç”¨å¯¼è‡´NPE?
tag: 
  - Bean
category: 
  - SpringBoot
  - åŸºç¡€ç³»åˆ—
  - è¸©å‘è®°å½•
date: 2021-11-18 19:36:17
keywords: 
  - Bean
  - SpringUtil
  - SpringBoot
---

åœ¨å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿è·å–Springå®¹å™¨ä¸­çš„Beanå¯¹è±¡ï¼Œä¸€ä¸ªå¸¸è§çš„caseå°±æ˜¯åˆ›å»ºä¸€ä¸ªSpringUtilç±»ï¼Œå†…éƒ¨æŒæœ‰SpringContextä¸Šä¸‹æ–‡ï¼Œç„¶åæä¾›ä¸€ä¸ªé™æ€çš„æ–¹å¼è·å–beanå¯¹è±¡ï¼Œç„¶è€Œè¿™ç§ä½¿ç”¨å§¿åŠ¿ï¼Œä¸€ä¸ªä¸å°å¿ƒå¯èƒ½å¯¼è‡´npe

ä»Šå¤©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåœºæ™¯

<!-- more -->

## åœºæ™¯å¤ç°

### 1. åŸºç¡€å·¥ç¨‹æ­å»º

æ­å»ºä¸€ä¸ªåŸºç¡€çš„SpringBooté¡¹ç›®ï¼Œå…·ä½“çš„è¿‡ç¨‹è¿™é‡Œçœç•¥ï¼Œä¸‹é¢æ ‡æ³¨å…³é”®çš„ä¿¡æ¯

æœ¬é¡¹ç›®å€ŸåŠ©`SpringBoot 2.2.1.RELEASE` +  `maven 3.5.3` + `IDEA`è¿›è¡Œå¼€å‘

å¼€ä¸€ä¸ªwebæœåŠ¡ç”¨äºæµ‹è¯•

```xml
<dependencies>
    <!-- é‚®ä»¶å‘é€çš„æ ¸å¿ƒä¾èµ– -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

### 2. SpringUtil

æ„å»ºä¸€ä¸ªåŸºç¡€çš„SpringUtilå·¥å…·ç±»ï¼Œå€ŸåŠ©SpringContextAwareæ¥æŒæœ‰ä¸Šä¸‹æ–‡

```java
@Component
public class SpringUtil implements ApplicationContextAware, EnvironmentAware {
    private static ApplicationContext applicationContext;
    private static Environment environment;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        SpringUtil.applicationContext = applicationContext;
    }

    @Override
    public void setEnvironment(Environment environment) {
        SpringUtil.environment = environment;
    }

    public static <T> T getBean(Class<T> clz) {
        return applicationContext.getBean(clz);
    }

    public static String getProperty(String key) {
        return environment.getProperty(key);
    }
}
```

### 3. ä½¿ç”¨å®ä¾‹

é¦–å…ˆæ„å»ºä¸€ä¸ªç®€å•çš„beanå¯¹è±¡

```java
@Component
public class TestDemo {
    public String showCase() {
        return UUID.randomUUID().toString();
    }

    public String testCase() {
        return "test-" + Math.random();
    }
}
```

æ¥ç€æ˜¯å¦å¤–ä¸€ä¸ªå¯¹è±¡ï¼Œä¾èµ–ä¸Šé¢è¿™ä¸ªå¯¹è±¡ï¼Œå¯¹å¤–æä¾›çš„ä¸»è¦æ¥å£æ˜¯ `process`ï¼Œå…¶å†…éƒ¨å®ç°æ˜¯æ ¹æ®æšä¸¾ç±»ï¼Œæ¥åšçš„ä¸€ä¸ªç­–ç•¥é€‰æ‹©ï¼›

```java
@Component
public class BasicDemo {
    @Autowired
    private TestDemo testDemo;

    public String process(String data) {
        return Data.process(data);
    }

    private String show() {
        return testDemo.showCase();
    }

    String test() {
        return testDemo.testCase();
    }

    public enum Data {
        SHOW("show") {
            @Override
            String doProcess() {
                return SpringUtil.getBean(BasicDemo.class).show();
            }
        },
        CASE("test") {
            @Override
            String doProcess() {
                return SpringUtil.getBean(BasicDemo.class).test();
            }
        };

        private String data;

        Data(String data) {
            this.data = data;
        }

        abstract String doProcess();

        static String process(String data) {
            for (Data d: values()) {
                if (d.data.equalsIgnoreCase(data)) {
                    return d.doProcess();
                }
            }
            return null;
        }
    }
}
```

é‡ç‚¹å…³æ³¨ä¸Šé¢å®ç°ä¸­çš„æšä¸¾ç±»ï¼Œåœ¨æšä¸¾ç±»ä¸­ï¼Œæ ¹æ®SpringUtilè·å–åˆ°`BasicDemo`å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œå®ƒçš„ç§æœ‰æ–¹æ³•`show()`åŠåŒ…å†…æ–¹æ³•`test()`

è¿™ç§ç”¨æ³•ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ä¹ˆï¼Ÿ

### 4. æµ‹è¯•case

æ¥ä¸‹æ¥å†™ä¸ªç®€å•æ¥å£æµ‹è¯•ä¸€ä¸‹

```java
@Aspect
@RestController
@SpringBootApplication
public class Application implements WebMvcConfigurer {
    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }

    @Autowired
    private BasicDemo basicDemo;

    @GetMapping(path = "show")
    public String show(String data) {
        return basicDemo.process(data);
    }
}
```

æ¥ä¸‹æ¥è®¿é—®çœ‹çœ‹ä¼šæ˜¯æ€æ ·

![](/imgs/211118/00.jpg)

what? ä¸æ˜¯è¯´ä¼šnpeä¹ˆï¼Ÿè¿™ä¸æ˜¯å¾ˆæ­£å¸¸çš„è¿”å›äº†ä¹ˆï¼ï¼ï¼

æ¥ä¸‹æ¥å°±æ˜¯è§è¯bugçš„æ—¶åˆ»äº†ï¼ŒåŒæ ·æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œå°±è®©å®ƒå‡ºç°npe

### 5. bugå¤ç°

æ¥ä¸‹æ¥æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåˆ‡é¢ï¼Œç›®çš„å°±æ˜¯è®©é€šè¿‡`SpringUtil.getBean`è·å–åˆ°çš„å¯¹è±¡æ˜¯ä»£ç†ç±»

```java
// æ³¨æ„åœ¨è¿™ä¸ªæ–¹æ³•æ‰€åœ¨ç±»ä¸Šï¼Œæ·»åŠ æ³¨è§£ @Aspect
@Around("execution(public * com.git.hui.boot.web.interceptor.server.BasicDemo.*(..))")
public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
    return joinPoint.proceed();
}
```

ç„¶åå†é‡æ–°è¯·æ±‚ä¸€ä¸‹ä¸Šé¢çš„è®¿é—®


![](/imgs/211118/01.jpg)

åœ¨è®¿é—®ç§æœ‰æ–¹æ³• `show()`è¿™é‡ŒæŠ›äº†å¼‚å¸¸ï¼Œä»æœåŠ¡ç«¯çš„å †æ ˆå¯ä»¥çœ‹åˆ°å¼‚å¸¸ç±»å‹ä¸ºNPEï¼Œä¸»è¦åŸå› å°±æ˜¯ `testDemo` ä¸ºnull

ç®€å•æ¥è®²å°±æ˜¯è®¿é—®ä»£ç†ç±»çš„ç§æœ‰æ–¹æ³•æ—¶ï¼Œå†…éƒ¨è‹¥æœ‰æ³¨å…¥beanå¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™æ‹¿åˆ°çš„æ˜¯null

è¿™ä¸ªå°±æœ‰ç‚¹ç¥å¥‡äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†å˜ä¸€ä¸‹ï¼Œç§æœ‰æ–¹æ³•å†…éƒ¨ä¸ç›´æ¥ä½¿ç”¨æ³¨å…¥çš„beanå¯¹è±¡ï¼Œæ”¹è°ƒç”¨ä¸€ä¸ªbeanå¯¹è±¡çš„å…±æœ‰æ–¹æ³•ï¼Œä¼šæ€æ ·

**å°†ä¸Šé¢çš„show()æ–¹æ³•é‡å†™ä¸€ä¸‹**

```java
private String show() {
    return show2();
}

public String show2() {
    return testDemo.showCase();
}
```

å†æ¬¡æµ‹è¯•ï¼Œè¾“å‡ºå¦‚

![](/imgs/211118/02.jpg)

å±…ç„¶æ²¡æœ‰é—®é¢˜ï¼ï¼ï¼

å°±è¿™ä¹ˆç¥å¥‡æœ‰æœ¨æœ‰ï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ

- å…³é”®çŸ¥è¯†ç‚¹ï¼šSpringä»£ç†ç±»çš„ç”Ÿæˆé€»è¾‘

### 6. å°ç»“

å¥½åƒåˆšè¿›å…¥ä¸»ä½“ï¼Œç»“æœåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼ŒçœŸæ˜¯è¿‡åˆ†ğŸ˜¡ï¼Œè¿™é‡Œå…ˆå°ç»“ä¸€ä¸‹è¿™ä¸ªé—®é¢˜å‡ºç°çš„åœºæ™¯ï¼Œè‡³äºå…·ä½“åŸå› æœ‰å¾…ä¸‹ç‰‡åšæ–‡ä»‹ç»

å½“æˆ‘ä»¬é€šè¿‡SpringContextè·å–åˆ°çš„beanå¯¹è±¡æ—¶ï¼Œä¸è¦ç›´æ¥è®¿é—®å®ƒçš„ç§æœ‰æ–¹æ³•ï¼Œå¯èƒ½å¯¼è‡´npe

**100%å¿…å…ˆçš„åœºæ™¯**

- è¿™ä¸ªbeanå¯¹è±¡æœ‰ä»£ç†ç±»ï¼ˆå¦‚æœ‰åˆ‡é¢æ‹¦æˆªäº†å®ƒï¼Œå¦‚ç±»å†…éƒ¨æœ‰ä¸€äº›ç‰¹å®šæ³¨è§£ï¼‰
- ç§æœ‰æ–¹æ³•å†…ä½¿ç”¨äº†æ³¨å…¥å¯¹è±¡

çœ‹åˆ°ä¸Šé¢å°±ä¼šæœ‰ä¸ªç–‘é—®ï¼Œè°ä¼šå»è®¿é—®ç§æœ‰æ–¹æ³•å‘¢ï¼Ÿæˆ‘è„‘å­åˆæ²¡å‘ğŸ˜’ï¼Œä½•å†µç§æœ‰æ–¹æ³•åœ¨å¤–é¢ä¹Ÿè®¿é—®ä¸äº†å•Š

è¿™å°±æ¶‰åŠåˆ°ä¸€ä¸ªç›¸å½“å¸¸è§çš„åœºæ™¯äº†ï¼Œç±»å†…éƒ¨æ–¹æ³•Aè°ƒç”¨å¸Œæœ›åˆ‡é¢æ‹¦æˆªçš„æ–¹æ³•Bï¼Œè¿™æ—¶æˆ‘ä»¬å¸¸è¿™ä¹ˆåš

```
public class A {
    @Autowired
    private A a;

    public void test() {
        a.testB();
    }
    
    @Point
    public String testB() {
        return "hello";
    }
}
```

ä¸Šé¢çš„testæ–¹æ³•ï¼Œè®¿é—®testBæ–¹æ³•å°±å¯ä»¥èµ°åˆ‡é¢é€»è¾‘ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªç±»ä¸­ï¼Œå°±æœ‰å¯èƒ½å‡ºç°ç›´æ¥æ˜¯ç”¨`a.privetMethod()`çš„åœºæ™¯äº†

æ­¤å¤–å°±æ˜¯åå°„æ‰§è¡ŒæŸäº›é€»è¾‘çš„æ—¶å€™ä¹Ÿæœ‰å¯èƒ½å‡ºç°è®¿é—®ç§æœ‰æ–¹æ³•äº†ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼›

æ¬¢è¿æœ‰å…´è¶£çš„å°ä¼™ä¼´å›å¤äº’åŠ¨ä¸€ä¸‹ï¼Œä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼š**ä¸€ç°ç°blog** 

## III. ä¸èƒ½é”™è¿‡çš„æºç å’Œç›¸å…³çŸ¥è¯†ç‚¹

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç ï¼š[https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/)

### 1. å¾®ä¿¡å…¬ä¼—å·: ä¸€ç°ç°Blog

å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œä»¥ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œéš¾å…æœ‰ç–æ¼å’Œé”™è¯¯ä¹‹å¤„ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œä¸åæ„Ÿæ¿€

ä¸‹é¢ä¸€ç°ç°çš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€›

- ä¸€ç°ç°Blogä¸ªäººåšå®¢ [https://blog.hhui.top](https://blog.hhui.top)
- ä¸€ç°ç°Blog-Springä¸“é¢˜åšå®¢ [http://spring.hhui.top](http://spring.hhui.top)


![ä¸€ç°ç°blog](https://spring.hhui.top/spring-blog/imgs/info/info.png)

