---
order: 7
title: 7.PropertySourceåŠ è½½Yamlé…ç½®æ–‡ä»¶å®ä¾‹æ¼”ç¤º
tag: 
  - PropertySource
category: 
  - SpringBoot
  - åŸºç¡€ç³»åˆ—
  - é…ç½®
date: 2020-12-26 10:38:40
keywords: SpringBoot PropertySource ymlæ–‡ä»¶ properties
---

åœ¨ä¹‹å‰æœ‰ä»‹ç»è¿‡å€ŸåŠ©æ³¨è§£`@PropertySource`æ¥å¼•å…¥è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨å½“æ—¶é‡åˆ°æŠ›å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œé€šè¿‡è¿™ä¸ªæ³¨è§£å¯ä»¥æ­£ç¡®è·å–åˆ°`.properties`æ–‡ä»¶çš„é…ç½®ä¿¡æ¯ï¼Œä½†æ˜¯`yaml`æ–‡ä»¶å´è¯»å–ä¸åˆ°ï¼Œæœ€è¿‘åˆç¢°åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæ­£å¥½æŠŠä¹‹å‰æŒ–çš„å‘å¡«ä¸Šï¼›æœ¬æ–‡å°†ä¸»è¦å®šä½ä¸€ä¸‹ï¼Œä¸ºå•¥ymlæ–‡ä»¶è¯»å–ä¸äº†ï¼Œåˆå¯ä»¥å¦‚ä½•å¤„ç†

å¦‚å¯¹ä¹‹å‰åšæ–‡æœ‰å…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥æŸ¥çœ‹: [180921-SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹è‡ªå®šä¹‰é…ç½®æŒ‡å®šä¸é…ç½®å†…å¼•ç”¨](https://spring.hhui.top/spring-blog/2018/09/21/180921-SpringBoot%E5%9F%BA%E7%A1%80%E7%AF%87%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%8C%87%E5%AE%9A%E4%B8%8E%E9%85%8D%E7%BD%AE%E5%86%85%E5%BC%95%E7%94%A8/)

<!-- more -->

## I. é¡¹ç›®ç¯å¢ƒ

### 1. åŸºæœ¬é…ç½®

æœ¬æ–‡åç»­çš„æºç å®šä½ä»¥åŠå®ä¾‹æ¼”ç¤ºéƒ½æ˜¯åŸºäº`SpringBoot 2.2.1.RELEASE`è¿›è¡Œï¼Œå¦‚éœ€å¤ç°æœ¬æ–‡ä¸­çš„caseï¼Œè¯·ç¡®ä¿ç¯å¢ƒä¸€è‡´

- IDEA
- MAVEN
- SpringBoot 2.2.1.RELEASE
- JDK1.8

### 2. å®ä¾‹é¡¹ç›®

åˆ›å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œç”¨äºåç»­çš„æ¼”ç¤ºï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶`biz.properties`

```properties
biz.token=mytoken
biz.appKey=asdf
biz.appVersion=1
biz.source=xxx.yyy

biz.uuid=${biz.token}#${biz.appKey}
```

æ¥ä¸‹æ¥å®šä¹‰å¯¹åº”çš„é…ç½®ç±»

```java
@Data
@Configuration
@PropertySource({"classpath:biz.properties"})
@ConfigurationProperties(prefix = "biz")
public class OtherProperBean {
    private String token;
    private String appKey;
    private Integer appVersion;
    private String source;
    private String uuid;
}
```

æœ€åè¡¥ä¸ŠSpringBooté¡¹ç›®ä¸å¯è·å–çš„å¯åŠ¨ç±»

```java
/**
 * Created by @author yihui in 14:08 18/9/19.
 */
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

## II. PropertySourceåŸç†åˆ†æ

æƒ³è¦å®šä½ä¸ºå•¥`@PropertySource`æ³¨è§£åªä¼šè·å–åˆ°`properties`æ–‡ä»¶çš„é…ç½®ï¼Œè€Œä¸èƒ½è·å–`yaml`æ–‡ä»¶é…ç½®ä¿¡æ¯ï¼Œæœ€ç›´æ¥çš„åŠæ³•å½“ç„¶æ˜¯ç›´æ¥æ’¸æºç ï¼ˆå®é™…ä¸Šæœ€ç®€å•çš„åŠæ³•ç›´æ¥å€ŸåŠ©æœç´¢å¼•æ“ï¼Œçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰å“ªä½å¤§ä½¬æœ‰è¿‡ç›¸å…³åˆ†äº«ï¼Œå¦‚æœä¸æ˜¯ä¸ºäº†å†™æœ¬æ–‡ï¼Œæˆ‘å¯æ˜¯å®Œå…¨æ²¡æƒ³å¼€æ’¸ï¼Œæ¯•ç«Ÿä»æå‡ºè¿™ä¸ªé—®é¢˜åˆ°ç°åœ¨å›å¤ï¼Œä¹Ÿè¿‡äº†ä¸¤å¹´å¤šäº†ğŸ˜­...ï¼‰

### 1. æºç å®šä½

é‚£ä¹ˆè¿™ä¸ªæºç å¯ä»¥æ€ä¹ˆå®šä½åˆ†æå‘¢ï¼Œå…ˆç›´æ¥è¿›å…¥è¿™ä¸ªæ³¨è§£ç…ä¸€ä¸‹

```java
public @interface PropertySource {
  // ... çœç•¥æ— å…³çš„å±æ€§

	Class<? extends PropertySourceFactory> factory() default PropertySourceFactory.class;
}
```

è¯·æ³¨æ„ä¸Šé¢çš„ç‰¹æ„ç•™å‡ºæ¥çš„`PropertySourceFactory`, ä»å‘½åä¸Šæ¥çœ‹ï¼Œå¤§è‡´å°±èƒ½æ„Ÿè§‰è¿™ä¸ªå·¥å‚ç±»ä¸å±æ€§æœ‰å…³äº†ï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†åˆ›å»º`PropertySource`å¯¹è±¡

å®ƒå°±æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œå¦‚æœæ²¡æœ‰çŒœé”™çš„è¯ï¼Œé…ç½®æ–‡ä»¶åŠ è½½åˆ°Springå®¹å™¨ä¹‹åï¼Œå¤šåŠå°±ä¼šä¸`PropertySource`å…³è”èµ·æ¥äº†ï¼ˆæ‰€ä»¥è¯´å¥½çš„å‘½åå¯ä»¥çœå¾ˆå¤šæ³¨é‡Šè¯´æ˜ï¼‰

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå·¥å‚ç±»çš„é»˜è®¤å®ç°`DefaultPropertySourceFactory`ï¼Œæºç å¾ˆç®€å•

```java
public class DefaultPropertySourceFactory implements PropertySourceFactory {

	@Override
	public PropertySource<?> createPropertySource(@Nullable String name, EncodedResource resource) throws IOException {
		return (name != null ? new ResourcePropertySource(name, resource) : new ResourcePropertySource(resource));
	}

}
```

åœ¨è¿™é‡Œæˆ‘ä»¬æ‰“ä¸ªæ–­ç‚¹ï¼Œç¡®è®¤ä¸€ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆç¥å™¨çš„äº‹æƒ…

![](/imgs/201226/00.jpg)

ä»ä¸Šé¢çš„æˆªå›¾å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª`EncodedResource`åŒ…å«äº†æˆ‘ä»¬æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼Œç›´æ¥å•æ­¥è¿›å»ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œçš„æ—¶å€™ä¸‹é¢è¿™ä¸ª

```java
// org.springframework.core.io.support.ResourcePropertySource#ResourcePropertySource(org.springframework.core.io.support.EncodedResource)
public ResourcePropertySource(EncodedResource resource) throws IOException {
		super(getNameForResource(resource.getResource()), PropertiesLoaderUtils.loadProperties(resource));
		this.resourceName = null;
}
```

è¯·æ³¨æ„ï¼Œæ ¸å¿ƒä»£ç ä¸æ˜¯`super()`è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œè€Œæ˜¯ä¼ å‚çš„`PropertiesLoaderUtils.loadProperties(resource)`

ä¸Šé¢è¿™ä¸€è¡Œè°ƒç”¨ï¼Œå°±æ˜¯å®ç°å…·ä½“çš„ä»é…ç½®æ–‡ä»¶ä¸­è·å–é…ç½®ä¿¡æ¯

ä¸‹é¢æ˜¯å…·ä½“çš„å®ç°ï¼ˆæ‘˜æŠ„æœ‰ç”¨çš„éƒ¨åˆ†é€»è¾‘ï¼‰

```java
// org.springframework.core.io.support.PropertiesLoaderUtils
public static Properties loadProperties(EncodedResource resource) throws IOException {
	Properties props = new Properties();
	fillProperties(props, resource);
	return props;
}

public static void fillProperties(Properties props, EncodedResource resource)
		throws IOException {
  // å±æ€§å¡«å……ï¼Œæ³¨æ„DefaultPropertiesPersister
	fillProperties(props, resource, new DefaultPropertiesPersister());
}

static void fillProperties(Properties props, EncodedResource resource, PropertiesPersister persister)
		throws IOException {
  ...
	try {
		String filename = resource.getResource().getFilename();
		if (filename != null && filename.endsWith(XML_FILE_EXTENSION)) {
			stream = resource.getInputStream();
			// è¿™ä¸ªæ˜¯å…³é”®
			persister.loadFromXml(props, stream);
		}
		else if (resource.requiresReader()) {
			reader = resource.getReader();
			// å…³é”®è°ƒç”¨
			persister.load(props, reader);
		}
		else {
			stream = resource.getInputStream();
			// å…³é”®è°ƒç”¨
			persister.load(props, stream);
		}
	}
	...
}
```


é…ç½®ä¿¡æ¯çš„è¯»å–ï¼Œæœ€ç»ˆä¾é çš„å°±æ˜¯`org.springframework.util.DefaultPropertiesPersister#load()`ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬åŸºæœ¬ä¸Šå°±æ‰¾åˆ°äº†ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–é…ç½®çš„â€œå¹•åé»‘æ‰‹â€ï¼Œç›´æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°é€»è¾‘å°±èƒ½çŸ¥é“ä¸ºå•¥ä¸æ”¯æŒyamläº†

```java
public class DefaultPropertiesPersister implements PropertiesPersister {

	@Override
	public void load(Properties props, InputStream is) throws IOException {
		props.load(is);
	}

	@Override
	public void load(Properties props, Reader reader) throws IOException {
		props.load(reader);
	}
}
```

ç›´æ¥è¿›å…¥çœ‹åˆ°æºç ï¼Œéå¸¸ç®€å•ç›´è§‚çš„å®ç°æ–¹å¼äº†ï¼Œç›´æ¥ä½¿ç”¨jdkçš„`java.util.Properties#load(java.io.InputStream)`æ¥è¯»å–é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥çœŸç›¸å·²ç»å¤§ç™½äº†ï¼ˆåŸæ¥éƒ½æ˜¯jdkçš„é”…ğŸ˜‚ï¼‰

### 2. yamlæ–‡ä»¶æ”¯æŒ

ç»è¿‡ä¸Šé¢çš„ä¸€ç•ªæ“ä½œï¼Œæˆ‘ä»¬çŸ¥é“`@ConfigurationProperties`åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯å€ŸåŠ©jdkçš„`Properties#load`æ–¹æ³•æ¥è¯»å–é…ç½®æ–‡ä»¶åˆ°å®¹å™¨å†…ï¼Œé‚£ä¹ˆè‹¥æˆ‘ä»¬å¸Œæœ›åŠ è½½yamlé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ€ä¹ˆæå‘¢ï¼Ÿ

å› ä¸ºSpringBootæ˜¯æ”¯æŒyamlé…ç½®æ–‡ä»¶çš„è¯»å–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥æ‰©å±•ä¸€ä¸‹ï¼Œå€ŸåŠ©SpringBootçš„å·¥å…·ç±»æ¥å®ç°é…ç½®æ–‡ä»¶åŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥å®ç°è‡ªå®šä¹‰çš„`PropertySourceFactory`

```java
public class YamlSourceFactory extends DefaultPropertySourceFactory {

    @Override
    public PropertySource<?> createPropertySource(String name, EncodedResource resource) throws IOException {
        if (resource == null) {
            return super.createPropertySource(name, resource);
        }

        // è¿™é‡Œä½¿ç”¨Yamlé…ç½®åŠ è½½ç±»æ¥è¯»å–ymlæ–‡ä»¶ä¿¡æ¯
        List<PropertySource<?>> sources = new YamlPropertySourceLoader().load(resource.getResource().getFilename(), resource.getResource());
        return sources.get(0);
    }
}
```

ç„¶åå†æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨çš„åœ°æ–¹ï¼Œåˆ©ç”¨è‡ªå®šä¹‰çš„å·¥å‚ç±»æ›¿æ¢é»˜è®¤çš„å³å¯

```java
@Data
@Configuration
@PropertySource(value = {"classpath:biz2.yml"}, factory = YamlSourceFactory.class)
@ConfigurationProperties(prefix = "biz2.yml")
public class YmlProperties {

    private Integer type;

    private String name;

    private List<Map<String, String>> ary;
}
```

å¯¹åº”çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹

```yaml
biz2:
  yml:
    type: 1
    name: biz.yml.name
    ary:
      - a: hello
      - b: world
```

æœ€åå®ä¾‹éªŒè¯ä¸€ä¸‹

```java
@SpringBootApplication
public class Application {

    public Application(YmlProperties ymlProperties) {
        System.out.println(ymlProperties);
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

![](/imgs/201226/01.jpg)

### 3. å°ç»“

å½“æˆ‘ä»¬å¸Œæœ›åŠ è½½è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶æ—¶ï¼Œ`@PropertySource`æ³¨è§£æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å€ŸåŠ©å¤šç¯å¢ƒé…ç½®æ–¹æ¡ˆï¼ŒæŒ‡å®š`spring.profiles.active`çš„å€¼ï¼Œå®ç°åŠ è½½å‰ç¼€ä¸º`application-`çš„é…ç½®æ–‡ä»¶ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹æˆ‘ä¹‹å‰çš„åšæ–‡ï¼‰

è¯·æ³¨æ„`@PropertySource`å¼•å…¥çš„é…ç½®æ–‡ä»¶ä¸æ”¯æŒ`yaml`æ–‡ä»¶ï¼Œå¦‚éœ€æ”¯æŒï¼Œå¯ä»¥å‚è€ƒæœ¬æ–‡ä¸­çš„å®ç°æ–¹å¼ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªyamlæ–‡ä»¶çš„`PropertySourceFactory`


æœ€åæä¸€å¥ï¼Œé‡åˆ°é—®é¢˜åƒä¸‡ä¸è¦æ”¾è¿‡ï¼Œå°½é‡è¿…é€Ÿè§£å†³ï¼Œä¸è¦ç•™å¾…ä»¥åï¼Œä¸ç„¶æ‹–å»¶ç—‡å‘ä½œçš„è¯ï¼Œè¿™ä¸ªæ—¶é—´å¯èƒ½å°±ä¸€ç›´æ‚¬ç€äº†...

## III. å…¶ä»–

### 0. é¡¹ç›®

**é¡¹ç›®æºç **

- å·¥ç¨‹: [https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç : [https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/000-properties](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/000-properties)

**ç³»åˆ—åšæ–‡**

- [ã€åŸºç¡€ç³»åˆ—ã€‘å®ç°ä¸€ä¸ªè‡ªå®šä¹‰é…ç½®åŠ è½½å™¨ï¼ˆåº”ç”¨ç¯‡ï¼‰](https://spring.hhui.top/spring-blog/2020/05/07/200507-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD%E5%99%A8/)
- [ã€åŸºç¡€ç³»åˆ—ã€‘SpringBooté…ç½®ä¿¡æ¯ä¹‹é»˜è®¤é…ç½®](https://spring.hhui.top/spring-blog/2018/09/25/180925-SpringBoot%E5%9F%BA%E7%A1%80%E7%AF%87%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B9%8B%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE/)
- [ã€åŸºç¡€ç³»åˆ—ã€‘SpringBooté…ç½®ä¿¡æ¯ä¹‹é…ç½®åˆ·æ–°](https://spring.hhui.top/spring-blog/2018/09/22/180922-SpringBoot%E5%9F%BA%E7%A1%80%E7%AF%87%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B9%8B%E9%85%8D%E7%BD%AE%E5%88%B7%E6%96%B0/)
- [ã€åŸºç¡€ç³»åˆ—ã€‘SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹è‡ªå®šä¹‰é…ç½®æŒ‡å®šä¸é…ç½®å†…å¼•ç”¨](https://spring.hhui.top/spring-blog/2018/09/21/180921-SpringBoot%E5%9F%BA%E7%A1%80%E7%AF%87%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%8C%87%E5%AE%9A%E4%B8%8E%E9%85%8D%E7%BD%AE%E5%86%85%E5%BC%95%E7%94%A8/)
- [ã€åŸºç¡€ç³»åˆ—ã€‘SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹å¤šç¯å¢ƒé…ç½®ä¿¡æ¯](https://spring.hhui.top/spring-blog/2018/09/20/180920-SpringBoot%E5%9F%BA%E7%A1%80%E7%AF%87%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B9%8B%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF/)
- [ã€åŸºç¡€ç³»åˆ—ã€‘SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹å¦‚ä½•è¯»å–é…ç½®ä¿¡æ¯](https://spring.hhui.top/spring-blog/2018/09/19/180919-SpringBoot%E5%9F%BA%E7%A1%80%E7%AF%87%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%B9%8B%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF/)

