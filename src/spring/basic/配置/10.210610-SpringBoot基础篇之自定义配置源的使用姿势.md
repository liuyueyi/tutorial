---
order: 10
title: 10.è‡ªå®šä¹‰é…ç½®æºçš„ä½¿ç”¨å§¿åŠ¿
tag: 
  - Value
category: 
  - SpringBoot
  - åŸºç¡€ç³»åˆ—
  - é…ç½®
date: 2021-06-10 19:44:53
keywords: springboot @value MapPropertySource
---
å‰é¢ä¸€ç¯‡åšæ–‡ä»‹ç»äº†ä¸€ä¸ª`@Value`çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œå…¶ä¸­æäº†ä¸€ä¸ªç‚¹ï¼Œ`@Value`å¯¹åº”çš„é…ç½®ï¼Œé™¤äº†æ˜¯é…ç½®æ–‡ä»¶ä¸­ä¹‹å¤–ï¼Œå¯ä»¥ä»å…¶ä»–çš„æ•°æ®æºä¸­è·å–ä¹ˆï¼Œå¦‚ä»redisï¼Œdbï¼Œhttpä¸­è·å–é…ç½®ï¼Ÿ

äº†è§£è¿‡SpringCloud Configçš„å¯ä»¥ç»™å‡ºç¡®åˆ‡çš„ç­”æ¡ˆï¼Œå¯ä»¥ï¼Œè€Œä¸”ç”¨èµ·æ¥è¿˜è€çˆ½äº†ï¼Œè¿œç¨‹é…ç½®ï¼Œæ”¯æŒé…ç½®åŠ¨æ€åˆ·æ–°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œåœ¨SpringBootä¸­ï¼Œå¦‚ä½•é…ç½®è‡ªå®šä¹‰çš„æ•°æ®æº

<!-- more -->

## I. é¡¹ç›®ç¯å¢ƒ

### 1. é¡¹ç›®ä¾èµ–

æœ¬é¡¹ç›®å€ŸåŠ©`SpringBoot 2.2.1.RELEASE` + `maven 3.5.3` + `IDEA`è¿›è¡Œå¼€å‘

å¼€ä¸€ä¸ªwebæœåŠ¡ç”¨äºæµ‹è¯•

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

## II. è‡ªå®šä¹‰é…ç½®æº

`@Value`ä¿®é¥°çš„æˆå‘˜ï¼Œç»‘å®šé…ç½®æ—¶ï¼Œæ˜¯ä»`Envrionment`ä¸­è¯»å–é…ç½®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ³¨å†Œä¸€ä¸ªè‡ªå®šä¹‰çš„é…ç½®æºï¼Œå€ŸåŠ©`MapPropertySource`å¯ä»¥æ¥å®ç°æˆ‘ä»¬éœ€æ±‚åœºæ™¯

### 1. è‡ªå®šä¹‰æ•°æ®æº

æ¼”ç¤ºä¸€ä¸ªæœ€ç®€å•è‡ªå®šä¹‰çš„é…ç½®æ•°æ®æºï¼Œé‡å†™`MapPropertySource`çš„`getProperties`æ–¹æ³•

å®ç°å¦‚ä¸‹

```java
public class SimplePropertiesSource extends MapPropertySource {
    public SimplePropertiesSource(String name, Map<String, Object> source) {
        super(name, source);
    }

    public SimplePropertiesSource() {
        this("filePropertiesSource", new HashMap<>());
    }

    /**
     * è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œé€‚ç”¨äºå®æ—¶è·å–é…ç½®
     *
     * @param name
     * @return
     */
    @Override
    public Object getProperty(String name) {
        // æ³¨æ„ï¼Œåªé’ˆå¯¹è‡ªå®šä¹‰å¼€å¤´çš„é…ç½®æ‰æ‰§è¡Œè¿™ä¸ªé€»è¾‘
        if (name.startsWith("selfdefine.")) {
            return name + "_" + UUID.randomUUID();
        }
        return super.getProperty(name);
    }
}
```

### 2. æ•°æ®æºæ³¨å†Œ

ä¸Šé¢åªæ˜¯å£°æ˜äº†é…ç½®æºï¼Œæ¥ä¸‹æ¥æŠŠå®ƒæ³¨å†Œåˆ°Environmentä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ä¾›åº”ç”¨ä½¿ç”¨äº†

```java
@RestController
@SpringBootApplication
public class Application {
    private Environment environment;

    @Bean
    public SimplePropertiesSource simplePropertiesSource(ConfigurableEnvironment environment) {
        this.environment = environment;
        SimplePropertiesSource ropertiesSource = new SimplePropertiesSource();
        environment.getPropertySources().addLast(ropertiesSource);
        return ropertiesSource;
    }

    // è·å–é…ç½®
    @GetMapping(path = "get")
    public String getProperty(String key) {
        return environment.getProperty(key);
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

![](/imgs/210610/00.gif)

ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œè‡ªå®šä¹‰é…ç½®å¼€å¤´çš„ä¼šè·å–åˆ°éšæœºçš„é…ç½®å€¼ï¼›é`selfdefine`å¼€å¤´çš„ï¼Œæ²¡æœ‰ç›¸åº”çš„é…ç½®ï¼Œè¿”å›ç©º

### 3. åŸºäºæ–‡ä»¶çš„è‡ªå®šä¹‰é…ç½®æº

ä¸Šé¢è¿™ä¸ªå¯èƒ½æœ‰ç‚¹è¿‡äºå„¿æˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†é…ç½®æºæ”¾åœ¨è‡ªå®šä¹‰çš„æ–‡ä»¶ä¸­ï¼Œå¹¶æ”¯æŒæ–‡ä»¶é…ç½®ä¿®æ”¹

```java
public class FilePropertiesSource extends MapPropertySource {
    public FilePropertiesSource(String name, Map<String, Object> source) {
        super(name, source);
    }

    public FilePropertiesSource() {
        this("filePropertiesSource", new HashMap<>());
    }

    // è¿™ç§æ–¹å¼ï¼Œé€‚ç”¨äºä¸€æ¬¡æå–æ‰€æœ‰çš„é…ç½®ï¼Œç„¶åä»å†…å­˜ä¸­æŸ¥è¯¢å¯¹åº”çš„é…ç½®ï¼Œæé«˜æœåŠ¡æ€§èƒ½
    // 10s æ›´æ–°ä¸€æ¬¡
    @PostConstruct
    @Scheduled(fixedRate = 10_000)
    public void refreshSource() throws IOException {
        String ans =
                FileCopyUtils.copyToString(new InputStreamReader(FilePropertiesSource.class.getClassLoader().getResourceAsStream("kv.properties")));
        Map<String, Object> map = new HashMap<>();
        for (String sub : ans.split("\n")) {
            if (sub.isEmpty()) {
                continue;
            }
            String[] kv = StringUtils.split(sub, "=");
            if (kv.length != 2) {
                continue;
            }

            map.put(kv[0].trim(), kv[1].trim());
        }

        source.clear();
        source.putAll(map);
    }
}
```

ä¸Šé¢å†™äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯10såˆ·æ–°ä¸€ä¸‹å†…å­˜ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿæ˜¯å¯ä»¥é…ç½®ä¸€ä¸ªæ–‡ä»¶å˜åŠ¨ç›‘å¬å™¨ï¼Œç›¸å…³æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥çœ‹ä¸‹[Javaå®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬å¯ä»¥æ€ä¹ˆç©](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247483855&idx=1&sn=918528761a188b664823dbf442ab681b&chksm=fce71a63cb909375a46cd1ec966881ce075f2b98ac0a84aaf2eaa33f65063c6be11378676039&token=73054292&lang=zh_CN#rd)


å¯¹åº”çš„é…ç½®æ–‡ä»¶

```properties
user=xhh
name=ä¸€ç°ç°
age=18
```

æ³¨å†Œçš„å§¿åŠ¿ä¸ä¸Šé¢ä¸€è‡´ï¼Œå°±ä¸å•ç‹¬è¯´æ˜äº†ï¼Œæ¥ä¸‹æ¥æ¼”ç¤ºä¸€ä¸‹ä½¿ç”¨


![](/imgs/210610/01.gif)

ä»ä¸Šå¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¸­çš„é…ç½®ä¿®æ”¹ä¹‹åï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¼šåˆ·æ–°

### 4. `@Value`ç»‘å®šè‡ªå®šä¹‰é…ç½®

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œå°†`@Value`ç»‘å®šè‡ªå®šä¹‰çš„é…ç½®ï¼Œæ˜¯å¦å¯ä»¥æˆåŠŸ

è°ƒæ•´ä¸€ä¸‹ä¸Šé¢çš„Application, æ·»åŠ ä¸€ä¸ªæˆå‘˜å±æ€§

```java
@Value("${name}")
private String name;

@GetMapping(path = "get")
public String getProperty(String key) {
    return name + "|" + environment.getProperty(key);
}
```

å†æ¬¡æµ‹è¯•å‘ç°æŠ›å¼‚å¸¸äº†ï¼Œè¯´æ˜¯è¿™ä¸ªé…ç½®ä¸å­˜åœ¨ï¼ï¼ï¼

![](/imgs/210610/02.jpg)

ï¼ˆè¿™å°±è¿‡åˆ†äº†å•Šï¼Œçœ‹äº†åŠå¤©ï¼Œç»“æœå‘Šè¯‰æˆ‘ä¸è¡Œï¼Œè¿™è¿˜ä¸å¾—èµ¶ç´§æä¸ªå·®è¯„ä¹ˆğŸ˜¡ğŸ˜¡ğŸ˜¡ï¼‰

å·²ç»å†™åˆ°è¿™é‡Œäº†ï¼Œå½“ç„¶æˆ‘ä¹Ÿå¾—ç»§ç»­å°è¯•æŒ½æ•‘ä¸€ä¸‹ï¼Œä¸ºå•¥å‰é¢ç›´æ¥é€šè¿‡`Environment`å¯ä»¥æ‹¿åˆ°é…ç½®ï¼Œä½†æ˜¯`@Value`æ³¨è§£ç»‘å®šå°±ä¸è¡Œå‘¢ï¼Ÿ

â€ç½ªé­ç¥¸é¦–â€œå°±åœ¨äºåˆå§‹åŒ–é¡ºåºï¼Œæˆ‘è‡ªå®šä¹‰çš„é…ç½®æºï¼Œè¿˜æ²¡æœ‰å¡åˆ°`Envrionment`ï¼Œä½ å°±å¼€ä¼šç€æ‰‹ç»‘å®šäº†ï¼Œå°±åƒå‡†å¤‡ç»™â€ä¸€ç°ç°blogâ€œä¸€ä¸ªå·®è¯„ï¼Œç»“æœå‘ç°è¿˜æ²¡å…³æ³¨...ï¼ˆå¥½å§ï¼Œæˆ‘æ‰¿è®¤æ²¡å…³æ³¨ä¹Ÿå¯ä»¥è¯„è®ºğŸ˜­ï¼‰

æ ¹æ®æ—¢å¾€çš„çŸ¥è¯†ç‚¹ï¼ˆè‡³äºæ˜¯å“ªäº›çŸ¥è¯†ç‚¹ï¼Œé‚£å°±é•¿è¯çŸ­è¯´ä¸äº†äº†ï¼Œçœ‹ä¸‹é¢å‡ ç¯‡ç²¾é€‰çš„åšæ–‡å§ï¼‰

- [ã€SpringBootåŸºç¡€ç³»åˆ—-å®æˆ˜ã€‘å¦‚ä½•æŒ‡å®š bean æœ€å…ˆåŠ è½½(åº”ç”¨ç¯‡)](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484553&idx=1&sn=f2d20abf3f3d409c53d0ee2675f7ab00&chksm=fce71f25cb9096338452312fb211776dee65fabbbe35908b9b00b43631c62a0f397a5b4aecf7&token=73054292&lang=zh_CN#rd)
- [SpringBootç³»åˆ—æ•™ç¨‹ä¹‹Beanä¹‹æŒ‡å®šåˆå§‹åŒ–é¡ºåºçš„è‹¥å¹²å§¿åŠ¿](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484364&idx=1&sn=35eb49543198b283ec505139b0f7af6f&chksm=fce71860cb909176b27ef22074970e3ac1746182b86b2a31d67fe5dcdedc59f99dc92eefa06a&token=73054292&lang=zh_CN#rd)
- [SpringBootç³»åˆ—æ•™ç¨‹ä¹‹BeanåŠ è½½é¡ºåºä¹‹é”™è¯¯ä½¿ç”¨å§¿åŠ¿è¾Ÿè°£](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484360&idx=1&sn=97188fc2e5595b1ba67db2e2634262c3&chksm=fce71864cb9091721af0288a0a4c9a4145b62dd63c927db6f0a14ceb8f13faa23183499f06e4&token=73054292&lang=zh_CN#rd)

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæœ€ç®€å•çš„æ–¹å¼å¦‚ä¸‹

åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„é…ç½®ç±»ï¼Œå®ç°è‡ªå®šä¹‰æ•°æ®æºçš„æ³¨å†Œ

```java
@Configuration
public class AutoConfig {
    @Bean
    public FilePropertiesSource filePropertiesSource(ConfigurableEnvironment environment) {
        FilePropertiesSource filePropertiesSource = new FilePropertiesSource();
        environment.getPropertySources().addLast(filePropertiesSource);
        return filePropertiesSource;
    }
}
```

æµ‹è¯•ç±»ä¸ŠæŒ‡å®šbeanä¾èµ–

```java
@DependsOn("filePropertiesSource")
@EnableScheduling
@RestController
@SpringBootApplication
public class Application {
    @Autowired
    private Environment environment;

    @Value("${name}")
    private String name;

    @GetMapping(path = "get")
    public String getProperty(String key) {
        return name + "|" + environment.getProperty(key);
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

å†æ¬¡æµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹

![](/imgs/210610/03.gif)

ä»ä¸Šé¢çš„æ¼”ç¤ºåŠ¨å›¾å¯ä»¥çœ‹åˆ°ï¼Œç»‘å®šè‡ªå®šä¹‰çš„æ•°æ®æºé…ç½®ï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå½“é…ç½®å˜æ›´æ—¶ï¼Œç»‘å®šçš„nameå­—æ®µï¼Œæ²¡æœ‰éšä¹‹æ›´æ–°

ç®€å•æ¥è®²å°±æ˜¯ä¸æ”¯æŒåŠ¨æ€åˆ·æ–°ï¼Œè¿™å°±éš¾å—äº†å•Šï¼Œæˆ‘å°±æƒ³è¦åŠ¨æ€åˆ·æ–°ï¼Œé‚£è¯¥æ€ä¹ˆæï¼Ÿ

- ä¸è¦æ€¥ï¼Œæ–°çš„åšæ–‡å·²ç»å®‰æ’ä¸Šäº†ï¼Œä¸‹ç¯‡å¥‰ä¸Šï¼ˆæ€•è¿·è·¯çš„å°ä¼™ä¼´ï¼Œä¸å¦¨å…³æ³¨ä¸€ä¸‹â€ä¸€ç°ç°blogâ€œğŸºï¼‰

### 5. å°ç»“

æœ€åæŒ‰ç…§æƒ¯ä¾‹å°ç»“ä¸€ä¸‹ï¼Œæœ¬æ–‡ç¯‡å¹…è™½é•¿ï¼Œä½†çŸ¥è¯†ç‚¹æ¯”è¾ƒé›†ä¸­ï¼Œæ€»ç»“ä¸‹æ¥ï¼Œä¸¤å¥è¯æå®š

- é€šè¿‡ç»§æ‰¿`MapPropertySource`æ¥å®ç°è‡ªå®šä¹‰é…ç½®æºï¼Œæ³¨å†Œåˆ°`Envrionment`å¯ä¾›`@Value`ä½¿ç”¨
- ä½¿ç”¨`@Value`ç»‘å®šè‡ªå®šä¹‰é…ç½®æºæ—¶ï¼Œæ³¨æ„æ³¨å†Œçš„é¡ºåºè¦æ—©äºbeançš„åˆå§‹åŒ–


å¥½çš„ï¼Œåˆ°è¿™é‡Œæ­£æ–‡ç»“æŸï¼Œ æˆ‘æ˜¯ä¸€ç°ç°ï¼Œæ¬¢è¿å„ä½å¤§ä½¬æ¥è¸©ä¸€è¸©é•¿è‰çš„å…¬ä¼—å·"ä¸€ç°ç°blog"

## III. ä¸èƒ½é”™è¿‡çš„æºç å’Œç›¸å…³çŸ¥è¯†ç‚¹

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç : [https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/002-dynamic-envronment](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/002-dynamic-envronment)

**é…ç½®ç³»åˆ—åšæ–‡**

- [ã€SpringBoot åŸºç¡€ç³»åˆ—ã€‘@Value ä¸­å“ªäº›ä½ ä¸çŸ¥é“çš„çŸ¥è¯†ç‚¹](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247486297&idx=1&sn=9c9014eb80987f8c6ef842b1ae02b155&chksm=fce710f5cb9099e31047b01b9d4f1e454cf31c6b11fdd85f7f896d5392e9db2f519af65fd5d2&scene=21#wechat_redirect)
- [ã€SpringBoot åŸºç¡€ç³»åˆ—ã€‘ConfigurationProperties é…ç½®ç»‘å®šä¸­é‚£äº›ä½ ä¸çŸ¥é“çš„äº‹æƒ…](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247485872&idx=1&sn=cb565e467d2d2dc9d69ad80a1f936813&chksm=fce7121ccb909b0a0efe89c94d5eba504cf490e0f0bdd15502def81be8c23b96ea76b5f247c4&scene=21#wechat_redirect)
- [ã€SpringBoot åŸºç¡€ç³»åˆ—ã€‘SpringBoot é…ç½®ç¯‡ä¹‹ PropertySource åŠ è½½ Yaml é…ç½®æ–‡ä»¶å®ä¾‹æ¼”ç¤º](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247485754&idx=1&sn=724f1a314f64faaaff580dfac0b58e73&chksm=fce71296cb909b8086442a6ebc982b5ed16b1a7252da2b8af27434c3dd6c757537867433efeb&scene=21#wechat_redirect)
- [ã€SpringBoot åŸºç¡€ç³»åˆ—ã€‘å®ç°ä¸€ä¸ªè‡ªå®šä¹‰é…ç½®åŠ è½½å™¨ï¼ˆåº”ç”¨ç¯‡ï¼‰](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484640&idx=1&sn=5ac20b68d7b539295dabc0c2aaf81314&chksm=fce71f4ccb90965afb626b437cc618172b2a34d8ff72b2ec30eba71e85ff9330503e0ead9e9a&scene=21#wechat_redirect)
- [SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹é…ç½®åˆ·æ–°](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484056&idx=1&sn=90f705d698b2613bcc269fea98dc993e&chksm=fce71934cb90902264f260b15977fc9bf7e19a3ebf3f779acec2f5842c9a8ff6ac514beebf60&scene=21#wechat_redirect)
- [SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹è‡ªå®šä¹‰é…ç½®æŒ‡å®šä¸é…ç½®å†…å¼•ç”¨](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484054&idx=1&sn=954d2bb34b5ce288dcfc2451cbcd2830&chksm=fce7193acb90902cf2ba829362da0e327d7849f3339e4d61188a03cabeb07af0590056f755d5&scene=21#wechat_redirect)
- [SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹å¤šç¯å¢ƒé…ç½®ä¿¡æ¯](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484053&idx=1&sn=3fc32d8a21a5cadc7b33b11681f272ae&chksm=fce71939cb90902fdc5b352e0d135b395248aa9ef40acd5e145bdd05a62185ff538c66f4fe26&scene=21#wechat_redirect)
- [SpringBootåŸºç¡€ç¯‡é…ç½®ä¿¡æ¯ä¹‹å¦‚ä½•è¯»å–é…ç½®ä¿¡æ¯](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484040&idx=1&sn=0b984bc76954f9214ed32ada38bc82d2&chksm=fce71924cb909032ad7a06a12aa71c23afe5698d552f182cc96bb5486b54e5a7332d7ab0736d&scene=21#wechat_redirect)



