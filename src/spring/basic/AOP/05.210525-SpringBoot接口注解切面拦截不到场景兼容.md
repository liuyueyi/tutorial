---
order: 5
title: 5.æ¥å£ä¸Šæ³¨è§£AOPæ‹¦æˆªä¸åˆ°åœºæ™¯å…¼å®¹
tag: 
  - AOP
category: 
  - SpringBoot
  - åŸºç¡€ç³»åˆ—
  - AOP
date: 2021-05-25 12:33:16
keywords: aop spring springboot åˆ‡é¢ æ¥å£æ³¨è§£ æ³¨è§£æ‹¦æˆª
---

åœ¨Javaçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé¢å‘æ¥å£çš„ç¼–ç¨‹å¯èƒ½æ˜¯å¤§å®¶çš„å¸¸æ€ï¼Œåˆ‡é¢ä¹Ÿæ˜¯å„ä½å¤§ä½¬ä½¿ç”¨Springæ—¶ï¼Œæˆ–å¤šæˆ–å°‘ä¼šä½¿ç”¨çš„ä¸€é¡¹åŸºæœ¬æŠ€èƒ½ï¼›ç»“æœè¿™ä¸¤ä¸ªç¢°åˆ°ä¸€èµ·ï¼Œæœ‰æ„æ€çš„äº‹æƒ…å°±å‘ç”Ÿäº†ï¼Œæ¥å£æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ï¼Œé¢å‘æ³¨è§£çš„åˆ‡é¢æ‹¦æˆªï¼Œå±…ç„¶ä¸ç”Ÿæ•ˆ

è¿™å°±æœ‰ç‚¹å¥‡æ€ªäº†å•Šï¼Œæœ€å¼€å§‹é‡åˆ°è¿™ä¸ªé—®é¢˜æ—¶ï¼Œè¡¨ç¤ºéš¾ä»¥ç›¸ä¿¡ï¼›äº‹åŠ¡æ³¨è§£ä¹ŸæŒºå¤šæ˜¯å†™åœ¨æ¥å£ä¸Šçš„ï¼Œå¥½åƒä¹Ÿæ²¡æœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼ˆéš¾é“æ˜¯ä¹Ÿä¸ç”Ÿæ•ˆï¼Œåªæ˜¯è‡ªå·±æ²¡æœ‰å…³æ³¨åˆ°ï¼Ÿï¼‰

æ¥ä¸‹æ¥æˆ‘ä»¬å¥½å¥½ç…ç…ï¼Œè¿™åˆ°åº•æ˜¯æ€ä¹ˆä¸ªæƒ…å†µ

<!-- more -->

## I. åœºæ™¯å¤ç°

è¿™ä¸ªåœºæ™¯å¤ç°ç›¸å¯¹è€Œè¨€æ¯”è¾ƒç®€å•äº†ï¼Œä¸€ä¸ªæ¥å£ï¼Œä¸€ä¸ªå®ç°ç±»ï¼›ä¸€ä¸ªæ³¨è§£ï¼Œä¸€ä¸ªåˆ‡é¢å®Œäº‹

### 1. é¡¹ç›®ç¯å¢ƒ

é‡‡ç”¨`SpringBoot 2.2.1.RELEASE` + `IDEA` + `maven` è¿›è¡Œå¼€å‘

æ·»åŠ aopä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

### 2. å¤ç°case

å£°æ˜ä¸€ä¸ªæ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AnoDot {
}
```

æ‹¦æˆªåˆ‡é¢ï¼Œä¸‹é¢è¿™æ®µä»£ç æ¥è‡ªä¹‹å‰åˆ†äº«çš„åšæ–‡ [ã€åŸºç¡€ç³»åˆ—ã€‘AOPå®ç°ä¸€ä¸ªæ—¥å¿—æ’ä»¶ï¼ˆåº”ç”¨ç¯‡ï¼‰](https://spring.hhui.top/spring-blog/2019/03/13/190313-SpringCloud%E5%BA%94%E7%94%A8%E7%AF%87%E4%B9%8BAOP%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD/)

```java
@Aspect
@Component
public class LogAspect {
    private static final String SPLIT_SYMBOL = "|";


    @Pointcut("execution(public * com.git.hui.boot.aop.demo.*.*(..)) || @annotation(AnoDot)")
    public void pointcut() {
    }

    @Around(value = "pointcut()")
    public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        Object res = null;
        String req = null;
        long start = System.currentTimeMillis();
        try {
            req = buildReqLog(proceedingJoinPoint);
            res = proceedingJoinPoint.proceed();
            return res;
        } catch (Throwable e) {
            res = "Un-Expect-Error";
            throw e;
        } finally {
            long end = System.currentTimeMillis();
            System.out.println(req + "" + JSON.toJSONString(res) + SPLIT_SYMBOL + (end - start));
        }
    }


    private String buildReqLog(ProceedingJoinPoint joinPoint) {
        // ç›®æ ‡å¯¹è±¡
        Object target = joinPoint.getTarget();
        // æ‰§è¡Œçš„æ–¹æ³•
        Method method = ((MethodSignature) joinPoint.getSignature()).getMethod();
        // è¯·æ±‚å‚æ•°
        Object[] args = joinPoint.getArgs();

        StringBuilder builder = new StringBuilder(target.getClass().getName());
        builder.append(SPLIT_SYMBOL).append(method.getName()).append(SPLIT_SYMBOL);
        for (Object arg : args) {
            builder.append(JSON.toJSONString(arg)).append(",");
        }
        return builder.substring(0, builder.length() - 1) + SPLIT_SYMBOL;
    }
}
```

ç„¶åå®šä¹‰ä¸€ä¸ªæ¥å£ä¸å®ç°ç±»ï¼Œæ³¨æ„ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ³¨è§£åœ¨æ¥å£ä¸Šï¼Œä¸€ä¸ªæ³¨è§£åœ¨å®ç°ç±»ä¸Š

```java
public interface BaseApi {
    @AnoDot
    String print(String obj);

    String print2(String obj);
}

@Component
public class BaseApiImpl implements BaseApi {
    @Override
    public String print(String obj) {
        System.out.println("ano in interface:" + obj);
        return "return:" + obj;
    }

    @AnoDot
    @Override
    public String print2(String obj) {
        System.out.println("ano in impl:" + obj);
        return "return:" + obj;
    }
}
```

æµ‹è¯•case

```java
@SpringBootApplication
public class Application {

    public Application(BaseApi baseApi) {
        System.out.println(baseApi.print("hello world"));
        System.out.println("-----------");
        System.out.println(baseApi.print2("hello world"));
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

æ‰§è¡Œåè¾“å‡ºç»“æœå¦‚ä¸‹ï¼ˆæœ‰å›¾æœ‰çœŸç›¸ï¼Œåˆ«è¯´æˆ‘éª—ä½ ğŸ™ƒï¼‰

![](/imgs/210525/00.jpg)


### 3. äº‹åŠ¡æ³¨è§£æµ‹è¯•

ä¸Šé¢è¿™ä¸ªä¸ç”Ÿæ•ˆï¼Œé‚£æˆ‘ä»¬é€šå¸¸å†™åœ¨æ¥å£ä¸Šçš„äº‹åŠ¡æ³¨è§£ï¼Œä¼šç”Ÿæ•ˆä¹ˆï¼Ÿ

æ·»åŠ mysqlæ“ä½œçš„ä¾èµ–

```xml
<dependencies>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jdbc</artifactId>
    </dependency>
</dependencies>
```

æ•°æ®åº“é…ç½® `application.properties`

```properties
## DataSource
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/story?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2b8
spring.datasource.username=root
spring.datasource.password=
```

æ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬çš„æ¥å£å®šä¹‰ä¸å®ç°

```java
public interface TransApi {
    @Transactional(rollbackFor = Exception.class)
    boolean update(int id);
}

@Service
public class TransApiImpl implements TransApi {
    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public boolean update(int id) {
        String sql = "replace into money (id, name, money) values (" + id + ", 'äº‹åŠ¡æµ‹è¯•', 200)";
        jdbcTemplate.execute(sql);

        Object ans = jdbcTemplate.queryForMap("select * from money where id = 111");
        System.out.println(ans);

        throw new RuntimeException("äº‹åŠ¡å›æ»š");
    }
}
```


æ³¨æ„ä¸Šé¢çš„updateæ–¹æ³•ï¼Œäº‹åŠ¡æ³¨è§£åœ¨æ¥å£ä¸Šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç¡®è®¤è°ƒç”¨ä¹‹åï¼Œæ˜¯å¦ä¼šå›æ»š

```java
@SpringBootApplication
public class Application {
    public Application(TransApiImpl transApi, JdbcTemplate jdbcTemplate) {
        try {
            transApi.update(111);
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }

        System.out.println(jdbcTemplate.queryForList("select * from money where id=111"));
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

![](/imgs/210525/01.jpg)

å›æ»šäº†ï¼Œæœ‰æœ¨æœ‰ï¼ï¼ï¼

æœç„¶æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå“å¾—æˆ‘ä¸€èº«å†·æ±—ï¼Œè¿™è¦æ˜¯æœ‰é—®é¢˜ï¼Œé‚£å°±...(ä¸æ•¢æƒ³ä¸æ•¢æƒ³)

æ‰€ä»¥é—®é¢˜æ¥äº†ï¼Œä¸ºå•¥ç¬¬ä¸€ç§æ–¹å¼ä¸ç”Ÿæ•ˆå‘¢ï¼Ÿï¼Ÿï¼Ÿ

## II. æ¥å£æ³¨è§£åˆ‡é¢æ‹¦æˆªå®ç°

æš‚ä¸”æŒ‰ä¸‹æ¢å¯»ç©¶ç«Ÿçš„æ¬²æœ›ï¼Œå…ˆçœ‹ä¸‹å¦‚æœæƒ³è®©æˆ‘ä»¬å¯ä»¥æ‹¦æˆªæ¥å£ä¸Šçš„æ³¨è§£ï¼Œå¯ä»¥æ€ä¹ˆåšå‘¢?

æ—¢ç„¶æ‹¦æˆªä¸ä¸Šï¼Œå¤šåŠæ˜¯å› ä¸ºå­ç±»æ²¡æœ‰ç»§æ‰¿çˆ¶ç±»çš„æ³¨è§£ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œåˆ‡ç‚¹åŒ¹é…æ—¶ï¼ŒåŒ¹é…ä¸åˆ°ï¼›æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£å°±è®©å®ƒåœ¨åŒ¹é…æ—¶ï¼Œæ‰¾ä¸‹çˆ¶ç±»çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„æ³¨è§£

### 1. è‡ªå®šä¹‰Pointcut

è™½è¯´æ˜¯è‡ªå®šä¹‰ï¼Œä½†ä¹Ÿæ²¡æœ‰è¦æ±‚æˆ‘ä»¬ç›´æ¥å®ç°è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬é€‰æ‹©`StaticMethodMatcherPointcut`æ¥è¡¥å…¨é€»è¾‘

```java
import org.springframework.core.annotation.AnnotatedElementUtils;

public static class LogPointCut extends StaticMethodMatcherPointcut {

    @SneakyThrows
    @Override
    public boolean matches(Method method, Class<?> aClass) {
        // ç›´æ¥ä½¿ç”¨springå·¥å…·åŒ…ï¼Œæ¥è·å–methodä¸Šçš„æ³¨è§£ï¼ˆä¼šæ‰¾çˆ¶ç±»ä¸Šçš„æ³¨è§£ï¼‰
        return AnnotatedElementUtils.hasAnnotation(method, AnoDot.class);
    }
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬é‡‡ç”¨å£°æ˜å¼æ¥å®ç°åˆ‡é¢é€»è¾‘

### 2. è‡ªå®šä¹‰Advice

è¿™ä¸ªadviceå°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„åˆ‡é¢é€»è¾‘ï¼Œå’Œä¸Šé¢çš„æ—¥å¿—è¾“å‡ºå·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºå‚æ•°ä¸åŒ

è‡ªå®šä¹‰adviceå®ç°è‡ªæ¥å£`MethodInterceptor`ï¼Œé¡¶å±‚æ¥å£æ˜¯`Advice`

```java
public static class LogAdvice implements MethodInterceptor {
    private static final String SPLIT_SYMBOL = "|";

    @Override
    public Object invoke(MethodInvocation methodInvocation) throws Throwable {
        Object res = null;
        String req = null;
        long start = System.currentTimeMillis();
        try {
            req = buildReqLog(methodInvocation);
            res = methodInvocation.proceed();
            return res;
        } catch (Throwable e) {
            res = "Un-Expect-Error";
            throw e;
        } finally {
            long end = System.currentTimeMillis();
            System.out.println("ExtendLogAspect:" + req + "" + JSON.toJSONString(res) + SPLIT_SYMBOL + (end - start));
        }
    }


    private String buildReqLog(MethodInvocation joinPoint) {
        // ç›®æ ‡å¯¹è±¡
        Object target = joinPoint.getThis();
        // æ‰§è¡Œçš„æ–¹æ³•
        Method method = joinPoint.getMethod();
        // è¯·æ±‚å‚æ•°
        Object[] args = joinPoint.getArguments();

        StringBuilder builder = new StringBuilder(target.getClass().getName());
        builder.append(SPLIT_SYMBOL).append(method.getName()).append(SPLIT_SYMBOL);
        for (Object arg : args) {
            builder.append(JSON.toJSONString(arg)).append(",");
        }
        return builder.substring(0, builder.length() - 1) + SPLIT_SYMBOL;
    }
}
```

### 3. è‡ªå®šä¹‰Advisor

å°†ä¸Šé¢è‡ªå®šä¹‰çš„åˆ‡ç‚¹pointcutä¸é€šçŸ¥adviceæ•´åˆï¼Œå®ç°æˆ‘ä»¬çš„åˆ‡é¢

```java
public static class LogAdvisor extends AbstractBeanFactoryPointcutAdvisor {
    @Setter
    private Pointcut logPointCut;

    @Override
    public Pointcut getPointcut() {
        return logPointCut;
    }
}
```

### 4. æœ€åæ³¨å†Œåˆ‡é¢

è¯´æ˜¯æ³¨å†Œï¼Œå®é™…ä¸Šå°±æ˜¯å£°æ˜ä¸ºbeanï¼Œä¸¢åˆ°springå®¹å™¨ä¸­è€Œå·²

```java
@Bean
public LogAdvisor init() {
    LogAdvisor logAdvisor = new LogAdvisor();
    // è‡ªå®šä¹‰å®ç°å§¿åŠ¿
    logAdvisor.setLogPointCut(new LogPointCut());
    logAdvisor.setAdvice(new LogAdvice());
    return logAdvisor;
}
```

ç„¶åå†æ¬¡æ‰§è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¾“å‡ºå¦‚ä¸‹

![](/imgs/210525/02.jpg)


æ¥å£ä¸Šçš„æ³¨è§£ä¹Ÿè¢«æ‹¦æˆªäº†ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªè€—æ—¶çš„è¾“å‡ºï¼Œæœ‰ç‚¹å¤¸å¼ äº†å•Šï¼Œé‡‡ç”¨ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œè¿™ä¸ªè€—æ—¶æœ‰ç‚¹å¤¸å¼ äº†å•Šï¼Œç”Ÿäº§ç¯å¢ƒè¿™ä¹ˆä¸€æï¼Œå²‚ä¸æ˜¯åˆ†åˆ†é’Ÿå·é“ºç›–çš„èŠ‚å¥

- å¯ä»¥å€ŸåŠ© StopWatch æ¥æŸ¥çœ‹åˆ°åº•æ˜¯å“ªé‡Œçš„å¼€é”€å¢åŠ äº†è¿™ä¹ˆå¤š ï¼ˆå…³äºStopWatchçš„ä½¿ç”¨ï¼Œä¸‹ç¯‡ä»‹ç»ï¼‰
- å•æ¬¡æ‰§è¡Œçš„ç»Ÿè®¡åå·®é—®é¢˜ï¼Œå°†ä¸Šé¢çš„è°ƒç”¨ï¼Œæ‰§è¡Œä¸€ç™¾éä¹‹åï¼Œå†çœ‹è€—æ—¶ï¼Œè¶‹äºå¹³è¡¡ï¼Œå¦‚ä¸‹å›¾

![](/imgs/210525/03.jpg)

### 5. å°ç»“

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å®ç°äº†æ¥å£ä¸Šæ³¨è§£çš„æ‹¦æˆªï¼Œè™½è¯´è§£å†³äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯ç–‘æƒ‘çš„åœ°æ–¹ä¾ç„¶æ²¡æœ‰ç­”æ¡ˆ

- ä¸ºå•¥æ¥å£ä¸Šçš„æ³¨è§£æ‹¦æˆªä¸åˆ° ï¼Ÿ
- ä¸ºå•¥äº‹åŠ¡æ³¨è§£ï¼Œæ”¾åœ¨æ¥å£ä¸Šå¯ä»¥ç”Ÿæ•ˆï¼Œäº‹åŠ¡æ³¨è§£çš„å®ç°æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ
- è‡ªå®šä¹‰çš„åˆ‡ç‚¹ï¼Œå¯ä»¥é…åˆæˆ‘ä»¬çš„æ³¨è§£æ¥ç©ä¹ˆï¼Ÿ
- ä¸ºä»€ä¹ˆé¦–æ¬¡æ‰§è¡Œæ—¶ï¼Œè€—æ—¶æ¯”è¾ƒå¤šï¼›å¤šæ¬¡æ‰§è¡Œä¹‹åï¼Œåˆ™è€—æ—¶è¶‹äºæ­£å¸¸ï¼Ÿ

ä¸Šé¢è¿™å‡ ä¸ªé—®é¢˜ï¼Œæ¯«æ— æ„å¤–ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰ç¡®åˆ‡çš„ç­”æ¡ˆï¼Œå¾…æˆ‘ç ”ç©¶ä¸€ç•ªï¼Œåç»­å†æ¥åˆ†äº«


## III. å…¶ä»–

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æ¥å£åˆ‡é¢æ‹¦æˆª: [https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/011-aop-logaspect](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/011-aop-logaspect)
- äº‹åŠ¡: [https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/101-jdbctemplate-transaction](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/101-jdbctemplate-transaction)

