---
order: 6
title: 6.AOPç»“åˆSpELå®ç°æ—¥å¿—è¾“å‡ºçš„æ³¨æ„äº‹é¡¹
tag: 
  - AOP
category: 
  - SpringBoot
  - åŸºç¡€ç³»åˆ—
  - AOP
date: 2021-06-08 18:50:52
keywords: SpringBoot SpEL AOP Gson JSON
---

ä½¿ç”¨AOPæ¥æ‰“å°æ—¥å¿—å¤§å®¶ä¸€æŠŠéƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œæœ€è¿‘åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†å‡ ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯SpELçš„è§£æï¼Œä¸€ä¸ªæ˜¯å‚æ•°çš„JSONæ ¼å¼è¾“å‡º

<!-- more -->

## I. é¡¹ç›®ç¯å¢ƒ

### 1. é¡¹ç›®ä¾èµ–

æœ¬é¡¹ç›®å€ŸåŠ©`SpringBoot 2.2.1.RELEASE` + `maven 3.5.3` + `IDEA`è¿›è¡Œå¼€å‘

å¼€ä¸€ä¸ªwebæœåŠ¡ç”¨äºæµ‹è¯•

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

## II. AOP & SpEL

å…³äºAOPä¸SpELçš„çŸ¥è¯†ç‚¹ï¼Œä¹‹å‰éƒ½æœ‰è¿‡ä¸“é—¨çš„ä»‹ç»ï¼Œè¿™é‡Œåšä¸€ä¸ªèšåˆï¼Œä¸€ä¸ªéå¸¸ç®€å•çš„æ—¥å¿—è¾“å‡ºåˆ‡é¢ï¼Œåœ¨éœ€è¦æ‰“å°æ—¥å¿—çš„æ–¹æ³•ä¸Šï¼Œæ·»åŠ æ³¨è§£`@Log`ï¼Œè¿™ä¸ªæ³¨è§£ä¸­å®šä¹‰ä¸€ä¸ª`key`ï¼Œä½œä¸ºæ—¥å¿—è¾“å‡ºçš„æ ‡è®°ï¼›keyæ”¯æŒSpELè¡¨è¾¾å¼

### 1. AOPåˆ‡é¢

æ³¨è§£å®šä¹‰

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Log {
    String key();
}
```

åˆ‡é¢é€»è¾‘

```java
@Slf4j
@Aspect
@Component
public class AopAspect implements ApplicationContextAware {
    private ExpressionParser parser = new SpelExpressionParser();
    private ParameterNameDiscoverer parameterNameDiscoverer = new DefaultParameterNameDiscoverer();

    @Around("@annotation(logAno)")
    public Object around(ProceedingJoinPoint joinPoint, Log logAno) throws Throwable {
        long start = System.currentTimeMillis();
        String key = loadKey(logAno.key(), joinPoint);
        try {
            return joinPoint.proceed();
        } finally {
            log.info("key: {}, args: {}, cost: {}", key,
                    JSONObject.toJSONString(joinPoint.getArgs()),
                    System.currentTimeMillis() - start);
        }
    }

    private String loadKey(String key, ProceedingJoinPoint joinPoint) {
        if (key == null) {
            return key;
        }

        StandardEvaluationContext context = new StandardEvaluationContext();

        context.setBeanResolver(new BeanFactoryResolver(applicationContext));
        String[] params = parameterNameDiscoverer.getParameterNames(((MethodSignature) joinPoint.getSignature()).getMethod());
        Object[] args = joinPoint.getArgs();
        for (int i = 0; i < args.length; i++) {
            context.setVariable(params[i], args[i]);
        }

        return parser.parseExpression(key).getValue(context, String.class);
    }

    private ApplicationContext applicationContext;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }
}
```

ä¸Šé¢è¿™ä¸ªé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå’Œå¤§å®¶ç†ŸçŸ¥çš„ä½¿ç”¨å§¿åŠ¿æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«

### 2. StandardEvaluationContextå®‰å…¨é—®é¢˜

å…³äº`StandardEvaluationContext`çš„æ³¨å…¥é—®é¢˜ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æŸ¥è¯¢ä¸€ä¸‹ç›¸å…³æ–‡ç« ï¼›å¯¹äºå®‰å…¨æ ¡éªŒè¾ƒé«˜çš„ï¼Œè¦æ±‚åªèƒ½ä½¿ç”¨`SimpleEvaluationContext`ï¼Œä½¿ç”¨å®ƒçš„è¯ï¼ŒSpELçš„èƒ½åŠ›å°±è¢«é™åˆ¶äº†

å¦‚åŠ ä¸€ä¸ªæµ‹è¯•

```java
@Data
@Accessors(chain = true)
public class DemoDo {

    private String name;

    private Integer age;
}
```

æœåŠ¡ç±»

```java
@Service
public class HelloService {

    @Log(key = "#demo.getName()")
    public String say(DemoDo demo, String prefix) {
        return prefix + ":" + demo;
    }
}
```

ä¸ºäº†éªŒè¯`SimpleEvaluationContext`ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„`loadKeys`æ–¹æ³•

```java
private String loadKey(String key, ProceedingJoinPoint joinPoint) {
    if (key == null) {
        return key;
    }

    SimpleEvaluationContext context = new SimpleEvaluationContext.Builder().build();
    String[] params = parameterNameDiscoverer.getParameterNames(((MethodSignature) joinPoint.getSignature()).getMethod());
    Object[] args = joinPoint.getArgs();
    for (int i = 0; i < args.length; i++) {
        context.setVariable(params[i], args[i]);
    }

    return parser.parseExpression(key).getValue(context, String.class);
}
```

å¯åŠ¨æµ‹è¯•

```java
@SpringBootApplication
public class Application {

    public Application(HelloService helloService) {
        helloService.say(new DemoDo().setName("ä¸€ç°ç°blog").setAge(18), "welcome");
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

![](/imgs/210608/00.jpg)

ç›´æ¥æç¤ºæ–¹æ³•æ‰¾ä¸åˆ°ï¼ï¼ï¼


### 3. gsonåºåˆ—åŒ–é—®é¢˜

ä¸Šé¢çš„caseä¸­ï¼Œä½¿ç”¨çš„FastJsonå¯¹ä¼ å‚è¿›è¡Œåºåˆ—åŒ–ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é‡‡ç”¨Gsonæ¥åšåºåˆ—åŒ–

```xml
<dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
</dependency>
```

ç„¶åæ–°å¢ä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•

```java
@Service
public class HelloService {
    /**
     * å­—é¢é‡ï¼Œæ³¨æ„ç”¨å•å¼•å·åŒ…è£¹èµ·æ¥
     * @param key
     * @return
     */
    @Log(key = "'yihuihuiblog'")
    public String hello(String key, HelloService helloService) {
        return key + "_" + helloService.say(new DemoDo().setName(key).setAge(10), "prefix");
    }
}
```

æ³¨æ„ä¸Šé¢æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œéå¸¸æœ‰æ„æ€çš„æ˜¯ï¼Œä¼ å‚æ˜¯è‡ªå·±çš„å®ä¾‹ï¼›å†æ¬¡æ‰§è¡Œ

```java
public Application(HelloService helloService) {
    helloService.say(new DemoDo().setName("ä¸€ç°ç°blog").setAge(18), "welcome");

    String ans = helloService.hello("ä¸€ç°ç°", helloService);
    System.out.println(ans);
}
```

ç›´æ¥æŠ›äº†å¼‚å¸¸

![](/imgs/210608/01.jpg)

è¿™å°±å¾ˆå°´å°¬äº†ï¼Œä¸€ä¸ªè¾“å‡ºæ—¥å¿—çš„è¾…åŠ©å·¥å…·ï¼Œå› ä¸ºåºåˆ—åŒ–ç›´æ¥å¯¼è‡´æ¥å£ä¸å¯ç”¨ï¼Œè¿™å°±ä¸ä¼˜é›…äº†ï¼›è€Œæˆ‘ä»¬ä½œä¸ºæ—¥å¿—è¾“å‡ºçš„åˆ‡é¢ï¼Œåˆæ˜¯æ²¡æœ‰åŠæ³•æ§åˆ¶è¿™ä¸ªä¼ å‚çš„ï¼Œæ²¡åŠæ³•è¦æ±‚ä½¿ç”¨çš„å‚æ•°ï¼Œä¸€å®šèƒ½åºåˆ—åŒ–ï¼Œè¿™é‡Œéœ€è¦é¢å¤–æ³¨æ„ ï¼ˆæ¯”è¾ƒå¥½çš„æ–¹å¼å°±æ˜¯ç®€å•å¯¹è±¡éƒ½å®ç°toString,ç„¶åè¾“å‡ºtoStringçš„ç»“æœï¼›è€Œä¸æ˜¯jsonä¸²ï¼‰

### 4. å°ç»“

è™½ç„¶ä¸Šé¢ä¸€å¤§ä¸²çš„å†…å®¹ï¼Œæ€»ç»“ä¸‹æ¥ï¼Œä¹Ÿå°±ä¸¤ç‚¹

- SpELè‹¥é‡‡ç”¨çš„æ˜¯`SimpleEvaluationContext`ï¼Œé‚£ä¹ˆæ³¨æ„spelçš„åŠŸèƒ½æ˜¯å‡å¼±çš„ï¼Œä¸€äº›ç‰¹æ€§ä¸æ”¯æŒ
- è‹¥å°†æ–¹æ³•å‚æ•°jsonåºåˆ—åŒ–è¾“å‡ºï¼Œé‚£ä¹ˆéœ€è¦æ³¨æ„æŸäº›ç±»åœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæŠ›å¼‚å¸¸

ï¼ˆçœ‹åˆ°è¿™é‡Œçš„å°ä¼™ä¼´ï¼Œä¸å¦¨ç‚¹ä¸ªèµï¼Œé¡ºæ‰‹å…³æ³¨ä¸‹å¾®ä¿¡å…¬ä¼—å·â€ä¸€ç°ç°blogâ€œï¼Œæˆ‘çš„å…¬ä¼—å·å·²ç»å¯‚å¯çš„é•¿è‰äº†ğŸ˜­ï¼‰

## III. ä¸èƒ½é”™è¿‡çš„æºç å’Œç›¸å…³çŸ¥è¯†ç‚¹

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç : [https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/014-spel-aop](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/014-spel-aop)

**AOPç³»åˆ—åšæ–‡**

- [SpringBootåŸºç¡€ç³»åˆ—AOPæ— æ³•æ‹¦æˆªæ¥å£ä¸Šæ³¨è§£åœºæ™¯å…¼å®¹](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247486254&idx=1&sn=d33ed6b90880fe518f587225a4550283&chksm=fce71082cb90999461d262d4ad41683ebea96d1a0eb6c8e48dcc8613922841b3c1dcd2c8f5fb&token=798393379&lang=zh_CN#rd)
- [SpringBootåŸºç¡€ç³»åˆ—å®ç°ä¸€ä¸ªç®€å•çš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡(åº”ç”¨ç¯‡)](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484621&idx=1&sn=fd24ef403c138292aff808daedcc87dd&chksm=fce71f61cb9096779257b53aab53cd985e35d5ed17fdd53be6aa953a2d97c3734aa0ba49a309&token=798393379&lang=zh_CN#rd)
- [SpringBootåŸºç¡€ç¯‡AOPä¹‹æ‹¦æˆªä¼˜å…ˆçº§è¯¦è§£](https://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484170&idx=1&sn=56ae689c23d75649009d59dd2a9b97c2&chksm=fce718a6cb9091b071a8f8c71c096fcd91bf3b764f96f02e09e6e345df455b25573124874a92&token=798393379&lang=zh_CN#rd)
- [SpringBootåº”ç”¨ç¯‡ä¹‹AOPå®ç°æ—¥å¿—åŠŸèƒ½](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484181&idx=1&sn=4518fb3d9c60bdb04428f044cc75af85&chksm=fce718b9cb9091af543634b338cbc998bf3014f5a230244e7340d92169a58c150ae07211d713&token=798393379&lang=zh_CN#rd)
- [SpringBootåŸºç¡€ç¯‡AOPä¹‹é«˜çº§ä½¿ç”¨æŠ€èƒ½](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484155&idx=1&sn=9ae1870f6ed9bd69a2c0745fbfddcb2a&chksm=fce71957cb909041b418ae24ae9dca5f64c8546f8db230c9b5a1d8d21828f2b8e8171568f12a&token=798393379&lang=zh_CN#rd)
- [SpringBootåŸºç¡€ç¯‡AOPä¹‹åŸºæœ¬ä½¿ç”¨å§¿åŠ¿å°ç»“](http://mp.weixin.qq.com/s?__biz=MzU3MTAzNTMzMQ==&mid=2247484151&idx=1&sn=96394bfb6cd4d009ab32d5605fc96d25&chksm=fce7195bcb90904d31a2f6a4f3367455c81715944ec0c89b4dc2f4502e27fecbbf37a780bef6&token=798393379&lang=zh_CN#rd)

