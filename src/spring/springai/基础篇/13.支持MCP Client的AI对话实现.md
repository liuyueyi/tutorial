---
order: 13
title: 13.æ”¯æŒMCP Clientçš„AIå¯¹è¯å®ç°
tag:
  - Spring
  - SpringAI
category:
  - SpringAI
date: 2025-08-05 17:24:07
keywords: SpringAI
---

# 13.æ”¯æŒMCP Clientçš„AIå¯¹è¯å®ç°

å‰é¢ä»‹ç»äº†é€šè¿‡SpringAIæ¥å®ç°MCP Serverï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ï¼Œé€šè¿‡SpringAIæ¥å®ç°ä¸€ä¸ªæ”¯æŒä¸Šæ¬¡å®ç°çš„`MCP Client`çš„`AI`å¯¹è¯

## ä¸€ã€é¡¹ç›®åˆå§‹åŒ–

SpringAI MCPå®¢æˆ·ç«¯çš„starterï¼Œæä¾›äº†MCPå®¢æˆ·ç«¯çš„è‡ªåŠ¨é…ç½®ï¼Œæ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼ï¼ˆæœ¬åœ°+ç½‘ç»œï¼‰ï¼Œæ”¯æŒåŒæ­¥ã€å¼‚æ­¥çš„è°ƒç”¨

### 1. é¡¹ç›®åˆ›å»º

åˆ›å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œå¹¶å¼•å…¥SpringAIä¾èµ–ï¼ŒåŸºæœ¬æµç¨‹å¦‚ [åˆ›å»ºä¸€ä¸ªSpringAI-Demoå·¥ç¨‹](01.åˆ›å»ºä¸€ä¸ªSpringAI-Demoå·¥ç¨‹.md)

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-model-zhipuai</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-mcp-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-thymeleaf</artifactId>
    </dependency>
    <dependency>
        <groupId>io.github.wimdeblauwe</groupId>
        <artifactId>htmx-spring-boot-thymeleaf</artifactId>
        <version>3.4.0</version>
    </dependency>
</dependencies>
```

å…¶ä¸­`spring-ai-starter-mcp-client`ä¾èµ–ï¼Œæä¾›äº†MCPå®¢æˆ·ç«¯çš„starterï¼Œä½¿ç”¨çš„æ˜¯æ™ºè°±çš„å…è´¹å¤§æ¨¡å‹`GLM-4-Flash`

å…¶æ¬¡æˆ‘ä»¬ä½¿ç”¨ `thymeleaf + htmx` æ¥å®ç°ä¸€ä¸ªç®€å•çš„èŠå¤©ç•Œé¢

### 2. é¡¹ç›®é…ç½®

åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé™¤äº†æŒ‡å®šå¤§æ¨¡å‹çš„å¯†é’¥ã€æ¨¡å‹ä¹‹å¤–ï¼Œè¿˜éœ€è¦é…ç½®MCPå®¢æˆ·ç«¯çš„å‚æ•°

```yaml
spring:
  ai:
    zhipuai:
      # api-key ä½¿ç”¨ä½ è‡ªå·±ç”³è¯·çš„è¿›è¡Œæ›¿æ¢ï¼›å¦‚æœä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œå¯ä»¥é€šè¿‡å¯åŠ¨å‚æ•°è¿›è¡Œè®¾ç½®
      api-key: ${zhipuai-api-key}
      chat: # èŠå¤©æ¨¡å‹
        options:
          model: GLM-4-Flash
    mcp:
      client:
        sse:
          connections:
            global-date-times:
              # è¿™é‡Œä½¿ç”¨ S07-mcp-server åˆ›å»ºçš„mcpæœåŠ¡ï¼Œç”¨äºè·å–å½“å‰æ—¶é—´
              url: http://localhost:8080/sse
        enabled: true
        name: time-mcp
        version: 1.0.0
        request-timeout: 30s
        type: async


# ä¿®æ”¹æ—¥å¿—çº§åˆ«
logging:
  level:
    org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor: debug
server:
  port: 8081
```

æˆ‘ä»¬è¿™é‡Œçš„ä½¿ç”¨çš„`MCP Server`ä¸º[S07-mcp-server](https://github.com/liuyueyi/spring-ai-demo/tree/master/S07-mcp-server)ä¸­å®ç°çš„æ ¹æ®åœ°åŒºè·å–å½“å‰æ—¶é—´çš„æœåŠ¡

## äºŒã€MCP Clientå®ç°

SpringAI å¯¹MCP Client çš„å®ç°å°è£…çš„éå¸¸å¥½äº†ï¼Œå¯¹äºä¸Šå±‚åº”ç”¨è€Œè¨€ï¼Œç›´æ¥å¯ä»¥é€šè¿‡è‡ªå®šæ³¨å…¥çš„ `ToolCallbackProvider`ï¼Œå°†mcp clientä½œä¸ºå¤§æ¨¡å‹çš„å·¥å…·è°ƒç”¨æ·»åŠ åˆ°æ¨¡å‹ä¸­ï¼Œç„¶åé€šè¿‡æ¨¡å‹è°ƒç”¨ï¼Œå³å¯å®ŒæˆMCPçš„ä½¿ç”¨æ¼”ç¤º

### 1. åˆå§‹åŒ–ChatClient

ç›´æ¥é€šè¿‡æ¨¡å‹å’Œ`ToolCallbackProvider`ï¼Œæ¥åˆ›å»ºæ”¯æŒmcpè°ƒç”¨çš„ `ChatClient`

```java
@Controller
public class ChatController {
    private final ChatClient chatClient;

    public ChatController(ChatModel chatModel, ToolCallbackProvider toolCallbackProvider) {
        System.out.println("å½“å‰æ³¨å†Œçš„å·¥å…·æ•°é‡: " + toolCallbackProvider.getToolCallbacks().length);
        this.chatClient = ChatClient.builder(chatModel)
                // å°†mcp client ä½œä¸ºå¤§æ¨¡å‹çš„å·¥å…·æ¥ä½¿ç”¨
                .defaultToolCallbacks(toolCallbackProvider)
                .defaultAdvisors(MessageChatMemoryAdvisor.builder(MessageWindowChatMemory.builder().build()).build(),
                        new SimpleLoggerAdvisor())
                .build();
    }
}
```

### 2. å®ç°èŠå¤©å¯¹è¯

èŠå¤©å¯¹è¯çš„å®ç°ï¼Œéå¸¸ç®€å•ï¼Œé€šè¿‡ `ChatClient` è°ƒç”¨æ¨¡å‹ï¼Œå¹¶è¿”å›ç»“æœ

```java
@Controller
public class ChatController {

    /**
     * é¦–é¡µ
     *
     * @param model
     * @return
     */
    @GetMapping("/")
    public String index(Model model) {
        return "index";
    }

    /**
     * ç”¨æˆ·é—®ç­”
     *
     * @param message
     * @param model
     * @return
     */
    @PostMapping("/ask")
    public HtmxResponse chat(String message, Model model) {
        String res = this.chatClient.prompt(message).call().content();
        model.addAttribute("question", message);
        model.addAttribute("response", res);
        // è¿”å› chat.html ä¸­ chatFragment ç»è¿‡æ¸²æŸ“åçš„å†…å®¹ï¼Œç”¨äºå¯¹è¯çš„å¡«å……
        return HtmxResponse.builder().view("chat :: chatFragment").build();
    }
}
```

### 3. å‰ç«¯èŠå¤©é¡µé¢å®ç°

èŠå¤©ä¸»é¡µ index.html

```html
<!-- Thymeleaf -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>æ”¯æŒMCP Clientçš„èŠå¤©å¯¹è¯æ¡†</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"
            integrity="sha384-ujb1lZYygJmzgSwoxRggbCHcjc0rB2XoQrxeTUQyRjrOnlCoYta87iKBWq3EsdM2"
            crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        function scrollToBottom(element) {
            document.getElementById('message').value = ''
            element.scrollTop = element.scrollHeight;
        }
    </script>
</head>
<body class="h-screen bg-gradient-to-br from-indigo-50 to-purple-50">
<div class="flex h-full max-w-6xl mx-auto">

    <main class="flex flex-col p-4 w-full">
        <header class="mb-6 py-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold leading-none tracking-tight text-indigo-800">
                ğŸ¤– MCP Client Chat
            </h1>
            <p class="text-gray-600 mt-1">ä¸AIåŠ©æ‰‹è¿›è¡Œæ™ºèƒ½å¯¹è¯</p>
        </header>

        <div id="chat" class="flex-1 mb-4 p-4 rounded-2xl bg-white shadow-sm overflow-auto">
            <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4">
            <form
                    class="w-full"
                    hx-post="/ask"
                    hx-swap="beforeend"
                    hx-target="#chat"
                    hx-indicator="#loading-indicator"
                    hx-on="htmx:beforeRequest:
                    document.getElementById('message').disabled = true;
                    document.getElementById('submit-btn').disabled = true;
                    document.getElementById('submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                    htmx:afterRequest:
                    document.getElementById('message').value = '';
                    document.getElementById('message').disabled = false;
                    document.getElementById('submit-btn').disabled = false;
                    document.getElementById('submit-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                    scrollToBottom(document.getElementById('chat'));">
                <div class="flex items-center rounded-full bg-gray-100 p-2 shadow-inner">
                    <input type="text" name="message" id="message"
                           class="bg-transparent outline-none text-gray-700 rounded-full py-3 px-4 w-full"
                           placeholder="è¾“å…¥æ¶ˆæ¯..."/>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full p-3 ml-2 transition duration-200 relative">ğŸ“¤
                        <span id="loading-indicator" class="htmx-indicator absolute inset-0 flex items-center justify-center"><span class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></span></span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }

    .htmx-indicator {
        display: none;
    }

    .htmx-request .htmx-indicator {
        display: flex;
    }

    .htmx-request.htmx-indicator {
        display: flex;
    }
</style>
</body>
</html>
```

å¯¹è¯å†å² `chat.html`

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="chatFragment" class="mb-8">
    <div class="inline-block bg-blue-300 rounded-lg p-2 ml-auto" th:text="${question}">Message</div>
    <p class="mt-4 h-full overflow-auto" th:text="${response}">Response</p>
</div>
</body>
</html>
```

### 4. ä½¿ç”¨æµ‹è¯•

é¦–å…ˆï¼Œå¯åŠ¨mcp serverï¼Œ ç„¶åå†å¯åŠ¨èŠå¤©å¯¹è¯æ¡†ï¼›ç„¶åå¼€å§‹å¯¹è¯

![ç›´æ¥è¯¢é—®å½“å‰æ—¶é—´](/imgs/column/springai/13-1.webp)

![ä¸šåŠ¡åœºæ™¯ä¸­æºå¸¦æ—¶é—´](/imgs/column/springai/13-2.webp)


## ä¸‰ã€å°ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»å°†MCP Clientçš„ä½¿ç”¨ï¼Œæ•´ä½“åº”ç”¨èµ·æ¥ï¼Œæ¯”è¾ƒç®€å•ï¼Œç”šè‡³æ˜¯æ¯”function callingæ›´ç®€å•ï¼ˆå› ä¸ºè‡ªåŠ¨å°†mcpæœåŠ¡æ³¨å…¥ä¸º`ToolCallbackProvider`ï¼Œå¯ä»¥ç›´æ¥ä¼ å…¥`ChatClient`ç”¨ä½œå¤§æ¨¡å‹çš„å·¥å…·è°ƒç”¨ï¼‰

å½“ç„¶é™¤äº†ä¸Šé¢è¿™ç§æ–¹å¼ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨MCP Clientæ¥è¿›è¡Œäº¤äº’

> MCPClient ä½¿ç”¨å§¿åŠ¿å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š [java-mcp-client](https://modelcontextprotocol.io/sdk/java/mcp-client)

```java
// è‡ªåŠ¨è·å–McpClient (æ³¨æ„åŒºåˆ†åŒæ­¥ã€å¼‚æ­¥ï¼‰

@Autowired
private List<McpSyncClient> mcpSyncClients;  // For sync client


@Autowired
private List<McpAsyncClient> mcpAsyncClients;  // For async client


/**
 * ç›´æ¥è°ƒç”¨mcpæœåŠ¡
 *
 * @param area
 * @return
 */
@GetMapping("/directCallMcp")
@ResponseBody
public Object directCallMcp(String area) {
    Mono<McpSchema.CallToolResult> result = mcpClients.get(0).callTool(
    new McpSchema.CallToolRequest("getTimeByZoneId", Map.of("area", area))
    );
    return result.block().content();
}
```

![](/imgs/column/springai/13-3.webp)

æ–‡ä¸­æ‰€æœ‰æ¶‰åŠåˆ°çš„ä»£ç ï¼Œå¯ä»¥åˆ°é¡¹ç›®ä¸­è·å– [https://github.com/liuyueyi/spring-ai-demo](https://github.com/liuyueyi/spring-ai-demo/tree/master/S13-mcp-client-chat)
