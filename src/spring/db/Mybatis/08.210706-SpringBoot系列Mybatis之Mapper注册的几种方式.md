---
order: 8
title: 8.SpringBootç³»åˆ—Mybatisä¹‹Mapperæ³¨å†Œçš„å‡ ç§æ–¹å¼
tag: 
  - Mybatis
category: 
  - SpringBoot
  - DBç³»åˆ—
  - Mybatis
date: 2021-07-06 18:59:05
keywords: mybatis springboot mysql db datasource
---

SpringBooté¡¹ç›®ä¸­å€ŸåŠ©Mybatisæ¥æ“ä½œæ•°æ®åº“ï¼Œå¯¹å¤§éƒ¨åˆ†javaæŠ€æœ¯æ ˆçš„å°ä¼™ä¼´æ¥è¯´ï¼Œå¹¶ä¸ä¼šé™Œç”Ÿï¼›æˆ‘ä»¬çŸ¥é“ï¼Œä½¿ç”¨mybatisï¼Œä¸€èˆ¬ä¼šæœ‰ä¸‹é¢å‡ ä¸ª

- Entity: æ•°æ®åº“å®ä½“ç±»
- Mapper: dbæ“ä½œæ¥å£
- Service: æœåŠ¡ç±»

æœ¬ç‰‡åšæ–‡ä¸­çš„æ³¨è§£ï¼Œæ”¾åœ¨Mapperä¸Šï¼Œä½ çŸ¥é“æ³¨å†ŒMapperæœ‰å‡ ç§æ–¹å¼ä¹ˆï¼ˆè¿™ä¸ªé—®é¢˜åƒä¸åƒ"èŒ´"å­—æœ‰å‡ ä¸ªå†™æ³•ğŸ˜¬ï¼‰

<!-- more -->

## I. ç¯å¢ƒå‡†å¤‡

### 1. æ•°æ®åº“å‡†å¤‡

ä½¿ç”¨mysqlä½œä¸ºæœ¬æ–‡çš„å®ä¾‹æ•°æ®åº“ï¼Œæ–°å¢ä¸€å¼ è¡¨

```sql
CREATE TABLE `money` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT 'ç”¨æˆ·å',
  `money` int(26) NOT NULL DEFAULT '0' COMMENT 'é’±',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  `create_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `name` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
```


### 2. é¡¹ç›®ç¯å¢ƒ

æœ¬æ–‡å€ŸåŠ© `SpringBoot 2.2.1.RELEASE` + `maven 3.5.3` + `IDEA`è¿›è¡Œå¼€å‘

pomä¾èµ–å¦‚ä¸‹

```xml
<dependencies>
    <dependency>
        <groupId>org.mybatis.spring.boot</groupId>
        <artifactId>mybatis-spring-boot-starter</artifactId>
        <version>2.2.0</version>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
</dependencies>
```

dbé…ç½®ä¿¡æ¯ `application.yml`

```yaml
spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/story?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password:
```

## II. å®ä¾‹æ¼”ç¤º

å‰é¢åŸºç¡€ç¯å¢ƒæ­å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥å‡†å¤‡ä¸‹Mybatisçš„Entity,Mapperç­‰åŸºç¡€ç±»

### 1. å®ä½“ç±»,Mapperç±»

æ•°æ®åº“å®ä½“ç±»`MoneyPo`

```java
@Data
public class MoneyPo {
    private Integer id;

    private String name;

    private Long money;

    private Integer isDeleted;

    private Timestamp createAt;

    private Timestamp updateAt;
}
```

å¯¹åº”çš„Mapperæ¥å£ï¼ˆè¿™é‡Œç›´æ¥ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥å®ç°CURDï¼‰

```java
public interface MoneyMapper {

    /**
     * ä¿å­˜æ•°æ®ï¼Œå¹¶ä¿å­˜ä¸»é”®id
     *
     * @param po
     * @return int
     */
    @Options(useGeneratedKeys = true, keyProperty = "po.id", keyColumn = "id")
    @Insert("insert into money (name, money, is_deleted) values (#{po.name}, #{po.money}, #{po.isDeleted})")
    int save(@Param("po") MoneyPo po);

    /**
     * æ›´æ–°
     *
     * @param id    id
     * @param money é’±
     * @return int
     */
    @Update("update money set `money`=#{money} where id = #{id}")
    int update(@Param("id") int id, @Param("money") long money);

    /**
     * åˆ é™¤æ•°æ®
     *
     * @param id id
     * @return int
     */
    @Delete("delete from money where id = #{id}")
    int delete(@Param("id") int id);

    /**
     * ä¸»é”®æŸ¥è¯¢
     *
     * @param id id
     * @return {@link MoneyPo}
     */
    @Select("select * from money where id = #{id}")
    @Results(id = "moneyResultMap", value = {
            @Result(property = "id", column = "id", id = true, jdbcType = JdbcType.INTEGER),
            @Result(property = "name", column = "name", jdbcType = JdbcType.VARCHAR),
            @Result(property = "money", column = "money", jdbcType = JdbcType.INTEGER),
            @Result(property = "isDeleted", column = "is_deleted", jdbcType = JdbcType.TINYINT),
            @Result(property = "createAt", column = "create_at", jdbcType = JdbcType.TIMESTAMP),
            @Result(property = "updateAt", column = "update_at", jdbcType = JdbcType.TIMESTAMP)})
    MoneyPo getById(@Param("id") int id);
}
```

å¯¹åº”çš„Serviceç±»

```java
@Slf4j
@Service
public class MoneyService {
    @Autowired
    private MoneyMapper moneyMapper;

    public void basicTest() {
        int id = save();
        log.info("save {}", getById(id));
        boolean update = update(id, 202L);
        log.info("update {}, {}", update, getById(id));
        boolean delete = delete(id);
        log.info("delete {}, {}", delete, getById(id));
    }

    private int save() {
        MoneyPo po = new MoneyPo();
        po.setName("ä¸€ç°ç°blog");
        po.setMoney(101L);
        po.setIsDeleted(0);
        moneyMapper.save(po);
        return po.getId();
    }

    private boolean update(int id, long newMoney) {
        int ans = moneyMapper.update(id, newMoney);
        return ans > 0;
    }

    private boolean delete(int id) {
        return moneyMapper.delete(id) > 0;
    }

    private MoneyPo getById(int id) {
        return moneyMapper.getById(id);
    }
}
```

### 2. æ³¨å†Œæ–¹å¼

æ³¨æ„ï¼Œä¸Šé¢å†™å®Œä¹‹åï¼Œè‹¥ä¸é€šè¿‡ä¸‹é¢çš„å‡ ç§æ–¹å¼æ³¨å†ŒMapperæ¥å£ï¼Œé¡¹ç›®å¯åŠ¨ä¼šå¤±è´¥ï¼Œæç¤ºæ‰¾ä¸åˆ°MoneyMapperå¯¹åº”çš„bean

```
Field moneyMapper in com.git.hui.boot.mybatis.service.MoneyService required a bean of type 'com.git.hui.boot.mybatis.mapper.MoneyMapper' that could not be found.
```


#### 2.1 @MapperScanæ³¨å†Œæ–¹å¼

åœ¨é…ç½®ç±»orå¯åŠ¨ç±»ä¸Šï¼Œæ·»åŠ `@MapperScan`æ³¨è§£æ¥æŒ‡å®šMapperæ¥å£çš„åŒ…è·¯å¾„ï¼Œä»è€Œå®ç°Mapperæ¥å£çš„æ³¨å†Œ

```java
@MapperScan(basePackages = "com.git.hui.boot.mybatis.mapper")
@SpringBootApplication
public class Application {

    public Application(MoneyService moneyService) {
        moneyService.basicTest();
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

æ‰§è¡Œä¹‹åè¾“å‡ºç»“æœå¦‚ä¸‹

```
2021-07-06 19:12:57.984  INFO 1876 --- [           main] c.g.h.boot.mybatis.service.MoneyService  : save MoneyPo(id=557, name=ä¸€ç°ç°blog, money=101, isDeleted=0, createAt=2021-07-06 19:12:57.0, updateAt=2021-07-06 19:12:57.0)
2021-07-06 19:12:58.011  INFO 1876 --- [           main] c.g.h.boot.mybatis.service.MoneyService  : update true, MoneyPo(id=557, name=ä¸€ç°ç°blog, money=202, isDeleted=0, createAt=2021-07-06 19:12:57.0, updateAt=2021-07-06 19:12:57.0)
2021-07-06 19:12:58.039  INFO 1876 --- [           main] c.g.h.boot.mybatis.service.MoneyService  : delete true, null
```

æ³¨æ„ï¼š

- basePackages: ä¼ å…¥Mapperçš„åŒ…è·¯å¾„ï¼Œæ•°ç»„ï¼Œå¯ä»¥ä¼ å…¥å¤šä¸ª
- åŒ…è·¯å¾„æ”¯æŒæ­£åˆ™ï¼Œå¦‚`com.git.hui.boot.*.mapper`
	- ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œå¯ä»¥é¿å…è®©æˆ‘ä»¬æ‰€æœ‰çš„mapperéƒ½æ”¾åœ¨ä¸€ä¸ªåŒ…è·¯å¾„ä¸‹ï¼Œä»è€Œå¯¼è‡´é˜…è¯»ä¸å‹å¥½

#### 2.2 @Mapper æ³¨å†Œæ–¹å¼

å‰é¢çš„`@MapperScan`æŒ‡å®šmapperçš„åŒ…è·¯å¾„ï¼Œè¿™ä¸ªæ³¨è§£åˆ™ç›´æ¥æ”¾åœ¨Mapperæ¥å£ä¸Š

```java
@Mapper
public interface MoneyMapper {
...
}
```

æµ‹è¯•è¾“å‡ºçœç•¥...

#### 2.3 MapperScannerConfigureræ³¨å†Œæ–¹å¼

ä½¿ç”¨`MapperScannerConfigurer`æ¥å®ç°mapperæ¥å£æ³¨å†Œï¼Œåœ¨å¾ˆä¹…ä»¥å‰ï¼Œè¿˜æ˜¯ä½¿ç”¨Springçš„xmlè¿›è¡Œbeançš„å£°æ˜çš„æ—¶å€™ï¼Œmybatisçš„mapperå°±æ˜¯è¿™ä¹ˆç©çš„

```xml
<bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <property name="basePackage" value="xxx"/>
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory"/>
</bean>
```

å¯¹åº”çš„javaä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration
public class AutoConfig {
    @Bean(name = "sqlSessionFactory")
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
        bean.setDataSource(dataSource);
        bean.setMapperLocations(
                // è®¾ç½®mybatisçš„xmlæ‰€åœ¨ä½ç½®ï¼Œè¿™é‡Œä½¿ç”¨mybatisæ³¨è§£æ–¹å¼ï¼Œæ²¡æœ‰é…ç½®xmlæ–‡ä»¶
                new PathMatchingResourcePatternResolver().getResources("classpath*:mapping/*.xml"));
        return bean.getObject();
    }

    @Bean("sqlSessionTemplate")
    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory storySqlSessionFactory) {
        return new SqlSessionTemplate(storySqlSessionFactory);
    }

    @Bean
    public MapperScannerConfigurer mapperScannerConfigurer() {
        MapperScannerConfigurer mapperScannerConfigurer = new MapperScannerConfigurer();
        mapperScannerConfigurer.setBasePackage("com.git.hui.boot.mybatis.mapper");
        mapperScannerConfigurer.setSqlSessionFactoryBeanName("sqlSessionFactory");
        mapperScannerConfigurer.setSqlSessionTemplateBeanName("sqlSessionTemplate");
        return mapperScannerConfigurer;
    }
}
```

æµ‹è¯•è¾“å‡ºçœç•¥

### 3. å°ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»Mybatisä¸­Mapperæ¥å£çš„ä¸‰ç§æ³¨å†Œæ–¹å¼ï¼Œå…¶ä¸­å¸¸è§çš„ä¸¤ç§æ³¨è§£æ–¹å¼
- `@MapperScan`: æŒ‡å®šMapperæ¥å£çš„åŒ…è·¯å¾„
- `@Mapper`: æ”¾åœ¨mapperæ¥å£ä¸Š
- `MapperScannerConfigurer`: ç¼–ç¨‹æ–¹å¼æ³¨å†Œ

é‚£ä¹ˆç–‘é—®æ¥äº†ï¼Œä¸ºå•¥è¦ä»‹ç»è¿™ä¸‰ç§æ–¹å¼ï¼Œæˆ‘ä»¬å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå‰é¢ä¸¤ä¸ªåŸºæœ¬ä¸Šå°±æ»¡è¶³äº†ï¼›ä»€ä¹ˆåœºæ™¯ä¼šç”¨åˆ°ç¬¬ä¸‰ç§æ–¹å¼ï¼Ÿ

- å¦‚å†™é€šç”¨çš„Mapperï¼ˆç±»ä¼¼Mybatis-Plusä¸­çš„BaseMapperï¼‰
- å¦‚ä¸€ä¸ªMapperï¼Œå¤šæ•°æ®æºçš„åœºæ™¯ï¼ˆå¦‚ä¸»ä»åº“ï¼Œå†·çƒ­åº“ï¼Œdbçš„æ“ä½œmapperä¸€è‡´ï¼Œä½†æ˜¯åº•å±‚çš„æ•°æ®æºä¸åŒï¼‰

æœ¬æ–‡åˆ°æ­¤ç»“æŸï¼Œå…³äºä¸Šé¢ä¸¤ä¸ªåœºæ™¯çš„å®ä¾‹caseï¼Œåé¢æœ‰ç©ºå†è¡¥ä¸Šï¼Œæˆ‘æ˜¯ä¸€ç°ç°ï¼Œæœ‰ç¼˜å†è§ï¼ˆæ¬¢è¿å…³æ³¨é•¿è‰çš„å…¬ä¼—å·`ä¸€ç°ç°blog`ï¼‰

## III. ä¸èƒ½é”™è¿‡çš„æºç å’Œç›¸å…³çŸ¥è¯†ç‚¹

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç ï¼š[https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/104-mybatis-ano](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/104-mybatis-ano)

