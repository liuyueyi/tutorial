---
order: 2
title: 2.äº‹åŠ¡éš”ç¦»çº§åˆ«çŸ¥è¯†ç‚¹å°ç»“
tag: 
  - äº‹åŠ¡
  - Transactional
category: 
  - SpringBoot
  - DBç³»åˆ—
  - äº‹åŠ¡
date: 2020-01-20 14:07:39
keywords: MySql SpringBoot JdbcTemplate äº‹åŠ¡ Transactional Isolation éš”ç¦»çº§åˆ« RR RU RC SERIALIZABLE
---

> ç»ˆäºæ¸¡è¿‡æ¼«é•¿çš„è‡ªæˆ‘éš”ç¦»æœŸï¼Œå¥åº·çš„æ´»ç€çœŸå¥½ï¼›ä¸ºæ­¦æ±‰ç¥ˆç¦ï¼Œå¸Œæœ›å¿«ç‚¹æ¸¡è¿‡ï¼Œèƒ½æ—©æ—¥å›å½’å¤§æ­¦æ±‰ ğŸ˜­ğŸ˜­ğŸ˜­

ä¸Šä¸€ç¯‡åšæ–‡ä»‹ç»äº†å£°æ˜å¼äº‹åŠ¡`@Transactional`çš„ç®€å•ä½¿ç”¨å§¿åŠ¿ï¼Œæœ€æ–‡ç« çš„æœ€åç»™å‡ºäº†è¿™ä¸ªæ³¨è§£çš„å¤šä¸ªå±æ€§ï¼Œæœ¬æ–‡å°†ç€é‡æ”¾åœ¨äº‹åŠ¡éš”ç¦»çº§åˆ«çš„çŸ¥è¯†ç‚¹ä¸Šï¼Œå¹¶é€šè¿‡å®ä¾‹æ¼”ç¤ºä¸åŒçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»çš„å…·ä½“åœºæ™¯

<!-- more -->

## I. åŸºç¡€çŸ¥è¯†

åœ¨è¿›å…¥æ­£æ–‡ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€ä¸‹äº‹åŠ¡éš”ç¦»çº§åˆ«çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ç‚¹ï¼Œè¯¦ç»†å†…å®¹ï¼Œæ¨èå‚è€ƒåšæ–‡

> [mysqlä¹‹é”ä¸äº‹åŠ¡](https://juejin.im/post/5ab5e44a6fb9a028c97a013d)

### 1. åŸºæœ¬æ¦‚å¿µ

> ä»¥ä¸‹åŸºæœ¬æ¦‚å¿µæºäºä¸ªäººç†è§£ä¹‹åï¼Œé€šè¿‡ç®€å•çš„caseè¿›è¡Œæè¿°ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æ‹ç –

**æ›´æ–°ä¸¢å¤±**

ç®€å•æ¥è®²ï¼Œä¸¤ä¸ªäº‹åŠ¡A,Båˆ†åˆ«æ›´æ–°ä¸€æ¡è®°å½•çš„filedA, filedBå­—æ®µï¼Œå…¶ä¸­äº‹åŠ¡Bå¼‚å¸¸ï¼Œå¯¼è‡´å›æ»šï¼Œå°†è¿™æ¡è®°å½•çš„æ¢å¤ä¸ºä¿®æ”¹ä¹‹å‰çš„çŠ¶æ€ï¼Œå¯¼è‡´äº‹åŠ¡Açš„ä¿®æ”¹ä¸¢å¤±äº†ï¼Œè¿™å°±æ˜¯æ›´æ–°ä¸¢å¤±

**è„è¯»**

è¯»å–åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„ä¿®æ”¹ï¼Œæ‰€ä»¥å½“å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ˜¯å¤±è´¥å¯¼è‡´å›æ»šçš„æ—¶å€™ï¼Œè¿™ä¸ªè¯»å–çš„æ•°æ®å…¶å®æ˜¯ä¸å‡†ç¡®çš„ï¼Œè¿™å°±æ˜¯è„è¯»

**ä¸å¯é‡å¤è¯»**

ç®€å•æ¥è®²ï¼Œå°±æ˜¯ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œå¤šæ¬¡æŸ¥è¯¢åŒä¸€ä¸ªæ•°æ®ï¼Œè¿”å›çš„ç»“æœå±…ç„¶ä¸ä¸€æ ·ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤åº¦ï¼ˆé‡å¤è¯»å–çš„ç»“æœä¸ä¸€æ ·ï¼‰

**å¹»è¯»**

åŒæ ·æ˜¯å¤šæ¬¡æŸ¥è¯¢ï¼Œä½†æ˜¯åé¢æŸ¥è¯¢æ—¶ï¼Œå‘ç°å¤šäº†æˆ–è€…å°‘äº†ä¸€äº›è®°å½•

æ¯”å¦‚ï¼šæŸ¥è¯¢idåœ¨[1,10]ä¹‹é—´çš„è®°å½•ï¼Œç¬¬ä¸€æ¬¡è¿”å›äº†1,2,3ä¸‰æ¡è®°å½•ï¼›ä½†æ˜¯å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ–°å¢äº†ä¸€ä¸ªidä¸º4çš„è®°å½•ï¼Œå¯¼è‡´å†æ¬¡æŸ¥è¯¢æ—¶ï¼Œè¿”å›äº†1,2,3,4å››æ¡è®°å½•ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢æ—¶å¤šäº†ä¸€æ¡è®°å½•ï¼Œè¿™å°±æ˜¯å¹»è¯»


å¹»è¯»å’Œä¸å¯é‡å¤è¯»çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š

- å¹»è¯»é’ˆå¯¹çš„æ˜¯æŸ¥è¯¢ç»“æœä¸ºå¤šä¸ªçš„åœºæ™¯ï¼Œå‡ºç°äº†æ•°æ®çš„å¢åŠ orå‡å°‘
- ä¸å¯é‡å¤åº¦è¯»å¯¹çš„æ˜¯æŸäº›ç‰¹å®šçš„è®°å½•ï¼Œè¿™äº›è®°å½•çš„æ•°æ®ä¸ä¹‹å‰ä¸ä¸€è‡´

### 2. éš”ç¦»çº§åˆ«

åé¢æµ‹è¯•çš„æ•°æ®åº“ä¸ºmysqlï¼Œå¼•æ“ä¸ºinnodbï¼Œå¯¹åº”æœ‰å››ä¸ªéš”ç¦»çº§åˆ«

| éš”ç¦»çº§åˆ« | è¯´æ˜ | fix | not fix | 
| --- | --- | --- | --- |
| RU(read uncommitted) | æœªæˆæƒè¯»ï¼Œè¯»äº‹åŠ¡å…è®¸å…¶ä»–è¯»å†™äº‹åŠ¡ï¼›æœªæäº¤å†™äº‹åŠ¡ç¦æ­¢å…¶ä»–å†™äº‹åŠ¡ï¼ˆè¯»äº‹åŠ¡okï¼‰| æ›´æ–°ä¸¢å¤±| è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»| 
| RC(read committed) | æˆæƒè¯»ï¼Œè¯»äº‹åŠ¡å…è®¸å…¶ä»–è¯»å†™äº‹åŠ¡ï¼›æœªæäº¤å†™äº‹åŠ¡ï¼Œç¦æ­¢å…¶ä»–è¯»å†™äº‹åŠ¡| æ›´æ–°ä¸¢å¤±ï¼Œè„è¯» | ä¸å¯é‡å¤è¯»ï¼Œå¹»è¯» |
| RR(repeatable read) | å¯é‡å¤åº¦ï¼Œè¯»äº‹åŠ¡ç¦æ­¢å…¶ä»–å†™äº‹åŠ¡ï¼›æœªæäº¤å†™äº‹åŠ¡ï¼Œç¦æ­¢å…¶ä»–è¯»å†™äº‹åŠ¡| æ›´æ–°ä¸¢å¤±ï¼Œè„è¯»ï¼Œä¸å¯é‡å¤åº¦| <del>å¹»è¯»</del> |
| serializable | åºåˆ—åŒ–è¯»ï¼Œæ‰€æœ‰äº‹åŠ¡ä¾æ¬¡æ‰§è¡Œ | æ›´æ–°ä¸¢å¤±ï¼Œè„è¯»ï¼Œä¸å¯é‡å¤åº¦ï¼Œå¹»è¯» | - |

**è¯´æ˜ï¼Œä¸‹é¢å­˜ä¸ºä¸ªäººè§‚ç‚¹ï¼Œä¸ä»£è¡¨æƒå¨ï¼Œè°¨æ…ç†è§£å’Œå¼•ç”¨**

- æˆ‘ä¸ªäººçš„è§‚ç‚¹ï¼Œrrçº§åˆ«åœ¨mysqlçš„innodbå¼•æ“ä¸Šï¼Œé…åˆmvvc + gapé”ï¼Œå·²ç»è§£å†³äº†å¹»è¯»é—®é¢˜
- ä¸‹é¢è¿™ä¸ªcaseæ˜¯å¹»è¯»é—®é¢˜ä¹ˆï¼Ÿ
  - ä»é”çš„è§’åº¦æ¥çœ‹ï¼Œæ­¥éª¤1ã€2è™½ç„¶å¼€å¯äº‹åŠ¡ï¼Œä½†æ˜¯å±äºå¿«ç…§è¯»ï¼›è€Œ9å±äºå½“å‰è¯»ï¼›ä»–ä»¬è¯»å–çš„æºä¸åŒï¼Œåº”è¯¥ä¸ç®—åœ¨å¹»è¯»å®šä¹‰ä¸­çš„åŒä¸€æŸ¥è¯¢æ¡ä»¶ä¸­

![](/imgs/200120/00.jpg)

## II. é…ç½®

æ¥ä¸‹æ¥è¿›å…¥å®ä¾‹æ¼”ç¤ºç¯èŠ‚ï¼Œé¦–å…ˆéœ€è¦å‡†å¤‡ç¯å¢ƒï¼Œåˆ›å»ºæµ‹è¯•é¡¹ç›®

åˆ›å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º`2.2.1.RELEASE`ï¼Œä½¿ç”¨mysqlä½œä¸ºç›®æ ‡æ•°æ®åº“ï¼Œå­˜å‚¨å¼•æ“é€‰æ‹©`Innodb`ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºRR

### 1. é¡¹ç›®é…ç½®

åœ¨é¡¹ç›®`pom.xml`æ–‡ä»¶ä¸­ï¼ŒåŠ ä¸Š`spring-boot-starter-jdbc`ï¼Œä¼šæ³¨å…¥ä¸€ä¸ª`DataSourceTransactionManager`çš„beanï¼Œæä¾›äº†äº‹åŠ¡æ”¯æŒ

```xml
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
``` 

### 2. æ•°æ®åº“é…ç½®

è¿›å…¥springé…ç½®æ–‡ä»¶`application.properties`ï¼Œè®¾ç½®ä¸€ä¸‹dbç›¸å…³çš„ä¿¡æ¯

```properties
## DataSource
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/story?useUnicode=true&characterEncoding=UTF-8&useSSL=false
spring.datasource.username=root
spring.datasource.password=
```

### 3. æ•°æ®åº“

æ–°å»ºä¸€ä¸ªç®€å•çš„è¡¨ç»“æ„ï¼Œç”¨äºæµ‹è¯•

```sql
CREATE TABLE `money` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT 'ç”¨æˆ·å',
  `money` int(26) NOT NULL DEFAULT '0' COMMENT 'é’±',
  `is_deleted` tinyint(1) NOT NULL DEFAULT '0',
  `create_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `name` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
```

## III. å®ä¾‹æ¼”ç¤º

### 1. åˆå§‹åŒ–æ•°æ®

å‡†å¤‡ä¸€äº›ç”¨äºåç»­æ“ä½œçš„æ•°æ®

```java
@Component
public class DetailDemo {
    @Autowired
    private JdbcTemplate jdbcTemplate;

    @PostConstruct
    public void init() {
        String sql = "replace into money (id, name, money) values (320, 'åˆå§‹åŒ–', 200)," + "(330, 'åˆå§‹åŒ–', 200)," +
                "(340, 'åˆå§‹åŒ–', 200)," + "(350, 'åˆå§‹åŒ–', 200)";
        jdbcTemplate.execute(sql);
    }
}
```

æä¾›ä¸€äº›åŸºæœ¬çš„æŸ¥è¯¢å’Œä¿®æ”¹æ–¹æ³•

```java
private boolean updateName(int id) {
    String sql = "update money set `name`='æ›´æ–°' where id=" + id;
    jdbcTemplate.execute(sql);
    return true;
}

public void query(String tag, int id) {
    String sql = "select * from money where id=" + id;
    Map map = jdbcTemplate.queryForMap(sql);
    System.out.println(tag + " >>>> " + map);
}

private boolean updateMoney(int id) {
    String sql = "update money set `money`= `money` + 10 where id=" + id;
    jdbcTemplate.execute(sql);
    return false;
}
```

### 2. RUéš”ç¦»çº§åˆ«

æˆ‘ä»¬å…ˆæ¥æµ‹è¯•RUéš”ç¦»çº§åˆ«ï¼Œé€šè¿‡æŒ‡å®š`@Transactional`æ³¨è§£çš„`isolation`å±æ€§æ¥è®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«

é€šè¿‡å‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬çŸ¥é“RUä¼šæœ‰è„è¯»é—®é¢˜ï¼Œæ¥ä¸‹æ¥è®¾è®¡ä¸€ä¸ªcaseï¼Œè¿›è¡Œæ¼”ç¤º

äº‹åŠ¡ä¸€ï¼Œä¿®æ”¹æ•°æ®

```java
/**
 * ruéš”ç¦»çº§åˆ«çš„äº‹åŠ¡ï¼Œå¯èƒ½å‡ºç°è„è¯»ï¼Œä¸å¯é¿å…ä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»
 *
 * @param id
 */
@Transactional(isolation = Isolation.READ_UNCOMMITTED, rollbackFor = Exception.class)
public boolean ruTransaction(int id) throws InterruptedException {
    if (this.updateName(id)) {
        this.query("ru: after updateMoney name", id);
        Thread.sleep(2000);
        if (this.updateMoney(id)) {
            return true;
        }
    }
    this.query("ru: after updateMoney money", id);
    return false;
}
```

åªè¯»äº‹åŠ¡äºŒ(è®¾ç½®readOnlyä¸ºtrueï¼Œåˆ™äº‹åŠ¡ä¸ºåªè¯»)å¤šæ¬¡è¯»å–ç›¸åŒçš„æ•°æ®ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨äº‹åŠ¡äºŒçš„ç¬¬ä¸€æ¬¡è¯»å–ä¸­ï¼Œèƒ½è·å–åˆ°äº‹åŠ¡ä¸€çš„ä¸­é—´ä¿®æ”¹ç»“æœï¼ˆæ‰€ä»¥è¯·æ³¨æ„ä¸¤ä¸ªæ–¹æ³•ä¸­çš„sleepä½¿ç”¨ï¼‰

```java
@Transactional(readOnly = true, isolation = Isolation.READ_UNCOMMITTED, rollbackFor = Exception.class)
public boolean readRuTransaction(int id) throws InterruptedException {
    this.query("ru read only", id);
    Thread.sleep(1000);
    this.query("ru read only", id);
    return true;
}
```

æ¥ä¸‹æ¥å±äºæµ‹è¯•çš„caseï¼Œç”¨ä¸¤ä¸ªçº¿ç¨‹æ¥è°ƒç”¨åªè¯»äº‹åŠ¡ï¼Œå’Œè¯»å†™äº‹åŠ¡

```java
@Component
public class DetailTransactionalSample {
    @Autowired
    private DetailDemo detailDemo;

     /**
     * ru éš”ç¦»çº§åˆ«
     */
    public void testRuIsolation() throws InterruptedException {
        int id = 330;
        new Thread(new Runnable() {
            @Override
            public void run() {
                call("ru: åªè¯»äº‹åŠ¡ - read", id, detailDemo::readRuTransaction);
            }
        }).start();

        call("ru è¯»å†™äº‹åŠ¡", id, detailDemo::ruTransaction);
    }
}

private void call(String tag, int id, CallFunc<Integer, Boolean> func) {
    System.out.println("============ " + tag + " start ========== ");
    try {
        func.apply(id);
    } catch (Exception e) {
    }
    System.out.println("============ " + tag + " end ========== \n");
}


@FunctionalInterface
public interface CallFunc<T, R> {
    R apply(T t) throws Exception;
}
```

è¾“å‡ºç»“æœå¦‚ä¸‹

```
============ ru è¯»å†™äº‹åŠ¡ start ========== 
============ ru: åªè¯»äº‹åŠ¡ - read start ========== 
ru read only >>>> {id=330, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 11:37:51.0, update_at=2020-01-20 11:37:51.0}
ru: after updateMoney name >>>> {id=330, name=æ›´æ–°, money=200, is_deleted=false, create_at=2020-01-20 11:37:51.0, update_at=2020-01-20 11:37:52.0}
ru read only >>>> {id=330, name=æ›´æ–°, money=200, is_deleted=false, create_at=2020-01-20 11:37:51.0, update_at=2020-01-20 11:37:52.0}
============ ru: åªè¯»äº‹åŠ¡ - read end ========== 

ru: after updateMoney money >>>> {id=330, name=æ›´æ–°, money=210, is_deleted=false, create_at=2020-01-20 11:37:51.0, update_at=2020-01-20 11:37:54.0}
============ ru è¯»å†™äº‹åŠ¡ end ==========
```

å…³æ³¨ä¸€ä¸‹ä¸Šé¢ç»“æœä¸­`ru read only >>>>`å¼€å¤´çš„è®°å½•ï¼Œé¦–å…ˆä¸¤æ¬¡è¾“å‡ºç»“æœä¸ä¸€è‡´ï¼Œæ‰€ä»¥ä¸å¯é‡å¤è¯»é—®é¢˜æ˜¯å­˜åœ¨çš„

å…¶æ¬¡ï¼Œç¬¬äºŒæ¬¡è¯»å–çš„æ•°æ®ä¸è¯»å†™äº‹åŠ¡ä¸­çš„ä¸­é—´ç»“æœä¸€è‡´ï¼Œå³è¯»å–åˆ°äº†æœªæäº¤çš„ç»“æœï¼Œå³ä¸ºè„è¯»

### 3. RCäº‹åŠ¡éš”ç¦»çº§åˆ«

rcéš”ç¦»çº§åˆ«ï¼Œå¯ä»¥è§£å†³è„è¯»ï¼Œä½†æ˜¯ä¸å¯é‡å¤è¯»é—®é¢˜æ— æ³•é¿å…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªcaseï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦å¯ä»¥è¯»å–å¦å¤–ä¸€ä¸ªäº‹åŠ¡æäº¤åçš„ç»“æœ


åœ¨å‰é¢çš„æµ‹è¯•caseä¸Šï¼Œç¨å¾®æ”¹ä¸€æ”¹

```java
// ---------- rc äº‹ç‰©éš”ç¦»çº§åˆ«
// æµ‹è¯•ä¸å¯é‡å¤è¯»ï¼Œä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡è¯»å–çš„ç»“æœä¸ä¸€æ ·


@Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class)
public boolean readRcTransaction(int id) throws InterruptedException {
    this.query("rc read only", id);
    Thread.sleep(1000);
    this.query("rc read only", id);
    Thread.sleep(3000);
    this.query("rc read only", id);
    return true;
}

/**
 * rcéš”ç¦»çº§åˆ«äº‹åŠ¡ï¼Œæœªæäº¤çš„å†™äº‹åŠ¡ï¼Œä¼šæŒ‚èµ·å…¶ä»–çš„è¯»å†™äº‹åŠ¡ï¼›å¯é¿å…è„è¯»ï¼Œæ›´æ–°ä¸¢å¤±ï¼›ä½†ä¸èƒ½é˜²æ­¢ä¸å¯é‡å¤è¯»ã€å¹»è¯»
 *
 * @param id
 * @return
 */
@Transactional(isolation = Isolation.READ_COMMITTED, rollbackFor = Exception.class)
public boolean rcTranaction(int id) throws InterruptedException {
    if (this.updateName(id)) {
        this.query("rc: after updateMoney name", id);
        Thread.sleep(2000);
        if (this.updateMoney(id)) {
            return true;
        }
    }

    return false;
}
```

æµ‹è¯•ç”¨ä¾‹

```java
/**
 * rc éš”ç¦»çº§åˆ«
 */
private void testRcIsolation() throws InterruptedException {
    int id = 340;
    new Thread(new Runnable() {
        @Override
        public void run() {
            call("rc: åªè¯»äº‹åŠ¡ - read", id, detailDemo::readRcTransaction);
        }
    }).start();

    Thread.sleep(1000);

    call("rc è¯»å†™äº‹åŠ¡ - read", id, detailDemo::rcTranaction);
}
```

è¾“å‡ºç»“æœå¦‚ä¸‹

```
============ rc: åªè¯»äº‹åŠ¡ - read start ========== 
rc read only >>>> {id=340, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:17.0}
============ rc è¯»å†™äº‹åŠ¡ - read start ========== 
rc: after updateMoney name >>>> {id=340, name=æ›´æ–°, money=200, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:23.0}
rc read only >>>> {id=340, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:17.0}
============ rc è¯»å†™äº‹åŠ¡ - read end ========== 

rc read only >>>> {id=340, name=æ›´æ–°, money=210, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:25.0}
============ rc: åªè¯»äº‹åŠ¡ - read end ========== 
```

ä»ä¸Šé¢çš„è¾“å‡ºä¸­ï¼Œåœ¨åªè¯»äº‹åŠ¡ï¼Œå‰é¢ä¸¤æ¬¡æŸ¥è¯¢ï¼Œç»“æœä¸€è‡´ï¼Œè™½ç„¶ç¬¬äºŒæ¬¡æŸ¥è¯¢æ—¶ï¼Œè¯»å†™äº‹åŠ¡ä¿®æ”¹äº†è¿™ä¸ªè®°å½•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¯»å–åˆ°è¿™ä¸ªä¸­é—´è®°å½•çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰è„è¯»é—®é¢˜ï¼›

å½“è¯»å†™äº‹åŠ¡å®Œæ¯•ä¹‹åï¼Œåªè¯»äº‹åŠ¡çš„ç¬¬ä¸‰æ¬¡æŸ¥è¯¢ä¸­ï¼Œè¿”å›çš„æ˜¯è¯»å†™äº‹åŠ¡æäº¤ä¹‹åçš„ç»“æœï¼Œå¯¼è‡´äº†ä¸å¯é‡å¤è¯»

### 4. RRäº‹åŠ¡éš”ç¦»çº§åˆ«

é’ˆå¯¹rrï¼Œæˆ‘ä»¬ä¸»è¦æµ‹è¯•ä¸€ä¸‹ä¸å¯é‡å¤è¯»çš„è§£å†³æƒ…å†µï¼Œè®¾è®¡caseç›¸å¯¹ç®€å•

```java
/**
 * åªè¯»äº‹åŠ¡ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†éš”ç¦»å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹ï¼Œå¯¹æœ¬æ¬¡æ“ä½œçš„å½±å“ï¼›
 *
 * æ¯”å¦‚åœ¨æŸäº›è€—æ—¶çš„æ¶‰åŠå¤šæ¬¡è¡¨çš„è¯»å–æ“ä½œä¸­ï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™ä¸ªå°±æœ‰ç”¨äº†ï¼› å¼€å¯åªè¯»äº‹åŠ¡ä¹‹åï¼Œä¸æ”¯æŒä¿®æ”¹æ•°æ®
 */
@Transactional(readOnly = true, isolation = Isolation.REPEATABLE_READ, rollbackFor = Exception.class)
public boolean readRrTransaction(int id) throws InterruptedException {
    this.query("rr read only", id);
    Thread.sleep(3000);
    this.query("rr read only", id);
    return true;
}

/**
 * rréš”ç¦»çº§åˆ«äº‹åŠ¡ï¼Œè¯»äº‹åŠ¡ç¦æ­¢å…¶ä»–çš„å†™äº‹åŠ¡ï¼Œæœªæäº¤å†™äº‹åŠ¡ï¼Œä¼šæŒ‚èµ·å…¶ä»–è¯»å†™äº‹åŠ¡ï¼›å¯é¿å…è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œï¼ˆæˆ‘ä¸ªäººè®¤ä¸ºï¼Œinnodbå¼•æ“å¯é€šè¿‡mvvc+gapé”é¿å…å¹»è¯»ï¼‰
 *
 * @param id
 * @return
 */
@Transactional(isolation = Isolation.REPEATABLE_READ, rollbackFor = Exception.class)
public boolean rrTransaction(int id) {
    if (this.updateName(id)) {
        this.query("rr: after updateMoney name", id);
        if (this.updateMoney(id)) {
            return true;
        }
    }

    return false;
}
```

æˆ‘ä»¬å¸Œæœ›è¯»å†™äº‹åŠ¡çš„æ‰§è¡Œå‘¨æœŸåœ¨åªè¯»äº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¹‹å†…ï¼Œæ‰€æœ‰æµ‹è¯•ä»£ç å¦‚ä¸‹

```java
/**
 * rr
 * æµ‹è¯•åªè¯»äº‹åŠ¡
 */
private void testReadOnlyCase() throws InterruptedException {
    // å­çº¿ç¨‹å¼€å¯åªè¯»äº‹åŠ¡ï¼Œä¸»çº¿ç¨‹æ‰§è¡Œä¿®æ”¹
    int id = 320;
    new Thread(new Runnable() {
        @Override
        public void run() {
            call("rr åªè¯»äº‹åŠ¡ - read", id, detailDemo::readRrTransaction);
        }
    }).start();

    Thread.sleep(1000);

    call("rr è¯»å†™äº‹åŠ¡", id, detailDemo::rrTransaction);
}
```

è¾“å‡ºç»“æœ

```
============ rr åªè¯»äº‹åŠ¡ - read start ========== 
rr read only >>>> {id=320, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:17.0}
============ rr è¯»å†™äº‹åŠ¡ start ========== 
rr: after updateMoney name >>>> {id=320, name=æ›´æ–°, money=200, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:28.0}
============ rr è¯»å†™äº‹åŠ¡ end ========== 

rr read only >>>> {id=320, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 11:46:17.0, update_at=2020-01-20 11:46:17.0}
============ rr åªè¯»äº‹åŠ¡ - read end ========== 
```

ä¸¤æ¬¡åªè¯»äº‹åŠ¡çš„è¾“å‡ºä¸€è‡´ï¼Œå¹¶æ²¡æœ‰å‡ºç°ä¸Šé¢çš„ä¸å¯é‡å¤è¯»é—®é¢˜

**è¯´æ˜**

- `@Transactional`æ³¨è§£çš„é»˜è®¤éš”ç¦»çº§åˆ«ä¸º`Isolation#DEFAULT`ï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨æ•°æ®æºçš„éš”ç¦»çº§åˆ«ï¼Œmysql innodbå¼•æ“é»˜è®¤éš”ç¦»çº§åˆ«ä¸ºRRï¼ˆæ‰€æœ‰ä¸é¢å¤–æŒ‡å®šæ—¶ï¼Œç›¸å½“äºRRï¼‰

### 5. SERIALIZABLEäº‹åŠ¡éš”ç¦»çº§åˆ«

ä¸²è¡Œäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰çš„äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘æ²¡ç”¨è¿‡... ä¹Ÿä¸å¤ªèƒ½æƒ³åƒï¼Œä»€ä¹ˆåœºæ™¯ä¸‹éœ€è¦è¿™ç§

```java
@Transactional(readOnly = true, isolation = Isolation.SERIALIZABLE, rollbackFor = Exception.class)
public boolean readSerializeTransaction(int id) throws InterruptedException {
    this.query("serialize read only", id);
    Thread.sleep(3000);
    this.query("serialize read only", id);
    return true;
}

/**
 * serializeï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œfixæ‰€æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½ä½
 *
 * @param id
 * @return
 */
@Transactional(isolation = Isolation.SERIALIZABLE, rollbackFor = Exception.class)
public boolean serializeTransaction(int id) {
    if (this.updateName(id)) {
        this.query("serialize: after updateMoney name", id);
        if (this.updateMoney(id)) {
            return true;
        }
    }

    return false;
}
```

æµ‹è¯•case

```java
/**
 * Serialize éš”ç¦»çº§åˆ«
 */
private void testSerializeIsolation() throws InterruptedException {
    int id = 350;
    new Thread(new Runnable() {
        @Override
        public void run() {
            call("Serialize: åªè¯»äº‹åŠ¡ - read", id, detailDemo::readSerializeTransaction);
        }
    }).start();

    Thread.sleep(1000);

    call("Serialize è¯»å†™äº‹åŠ¡ - read", id, detailDemo::serializeTransaction);
}
```

è¾“å‡ºç»“æœå¦‚ä¸‹

```
============ Serialize: åªè¯»äº‹åŠ¡ - read start ========== 
serialize read only >>>> {id=350, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 12:10:23.0, update_at=2020-01-20 12:10:23.0}
============ Serialize è¯»å†™äº‹åŠ¡ - read start ========== 
serialize read only >>>> {id=350, name=åˆå§‹åŒ–, money=200, is_deleted=false, create_at=2020-01-20 12:10:23.0, update_at=2020-01-20 12:10:23.0}
============ Serialize: åªè¯»äº‹åŠ¡ - read end ========== 

serialize: after updateMoney name >>>> {id=350, name=æ›´æ–°, money=200, is_deleted=false, create_at=2020-01-20 12:10:23.0, update_at=2020-01-20 12:10:39.0}
============ Serialize è¯»å†™äº‹åŠ¡ - read end ========== 
```

åªè¯»äº‹åŠ¡çš„æŸ¥è¯¢è¾“å‡ºä¹‹åï¼Œæ‰è¾“å‡ºè¯»å†™äº‹åŠ¡çš„æ—¥å¿—ï¼Œç®€å•æ¥è®²å°±æ˜¯è¯»å†™äº‹åŠ¡ä¸­çš„æ“ä½œè¢«delayäº†

### 6. å°ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»äº†äº‹åŠ¡çš„å‡ ç§éš”ç¦»çº§åˆ«ï¼Œå·²ç»ä¸åŒå¹²çš„éš”ç¦»çº§åˆ«å¯¹åº”çš„åœºæ™¯ï¼Œå¯èƒ½å‡ºç°çš„é—®é¢˜ï¼›

**éš”ç¦»çº§åˆ«è¯´æ˜**

| çº§åˆ« | fix | not fix | 
| --- | --- | ---|
| RU | æ›´æ–°ä¸¢å¤±| è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»| 
| RC | æ›´æ–°ä¸¢å¤± è„è¯» |ä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»| 
| RR | æ›´æ–°ä¸¢ã€è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»| - |
| serialze | æ›´æ–°ä¸¢å¤±ã€ è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»| - |

**ä½¿ç”¨è¯´æ˜**

- mysql innodbå¼•æ“é»˜è®¤ä¸ºRRéš”ç¦»çº§åˆ«ï¼›`@Transactinoal`æ³¨è§£ä½¿ç”¨æ•°æ®åº“çš„éš”ç¦»çº§åˆ«ï¼Œå³RR
- é€šè¿‡æŒ‡å®š`Transactional#isolation`æ¥è®¾ç½®äº‹åŠ¡çš„äº‹åŠ¡çº§åˆ«

## IV. å…¶ä»–

### 0. ç³»åˆ—åšæ–‡&æºç 

**ç³»åˆ—åšæ–‡**

- [180926-SpringBooté«˜çº§ç¯‡DBä¹‹åŸºæœ¬ä½¿ç”¨](http://spring.hhui.top/spring-blog/2018/09/26/180926-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87DB%E4%B9%8B%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/)
- [190407-SpringBooté«˜çº§ç¯‡JdbcTemplateä¹‹æ•°æ®æ’å…¥ä½¿ç”¨å§¿åŠ¿è¯¦è§£](http://spring.hhui.blog/spring-blog/2019/04/07/190407-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF%E8%AF%A6%E8%A7%A3/)
- [190412-SpringBooté«˜çº§ç¯‡JdbcTemplateä¹‹æ•°æ®æŸ¥è¯¢ä¸Šç¯‡](http://spring.hhui.top/spring-blog/2019/04/12/190412-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%B8%8A%E7%AF%87/)
- [190417-SpringBooté«˜çº§ç¯‡JdbcTemplateä¹‹æ•°æ®æŸ¥è¯¢ä¸‹ç¯‡](http://spring.hhui.top/spring-blog/2019/04/17/190417-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2%E4%B8%8B%E7%AF%87/)
- [190418-SpringBooté«˜çº§ç¯‡JdbcTemplateä¹‹æ•°æ®æ›´æ–°ä¸åˆ é™¤](http://spring.hhui.top/spring-blog/2019/04/18/190418-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87JdbcTemplate%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E4%B8%8E%E5%88%A0%E9%99%A4/)
- [200119-SpringBootç³»åˆ—æ•™ç¨‹ä¹‹å£°æ˜å¼äº‹åŠ¡Transactional](http://spring.hhui.top/spring-blog/2020/01/19/200119-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E4%B9%8B%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1Transactional/)

**æºç **

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- å®ä¾‹æºç : [https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-boot/101-jdbctemplate-transaction](https://github.com/liuyueyi/spring-boot-demo/blob/master/spring-boot/101-jdbctemplate-transaction)

