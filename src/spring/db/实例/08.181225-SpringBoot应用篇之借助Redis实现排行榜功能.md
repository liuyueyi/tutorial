---
order: 3
title: 3.å€ŸåŠ©Rediså®ç°æ’è¡Œæ¦œåŠŸèƒ½ï¼ˆåº”ç”¨ç¯‡ï¼‰
tag: 
  - Redis
  - åº”ç”¨
category: 
  - SpringBoot
  - DBç³»åˆ—
  - Redis
  - åº”ç”¨ç¯‡
date: 2018-12-25 22:02:13
keywords: Redis,SpringBoot,æ’è¡Œæ¦œ
---

> æ›´å¤šSpringæ–‡ç« ï¼Œæ¬¢è¿ç‚¹å‡» [ä¸€ç°ç°Blog-Springä¸“é¢˜](http://spring.hhui.top)

åœ¨ä¸€äº›æ¸¸æˆå’Œæ´»åŠ¨ä¸­ï¼Œå½“æ¶‰åŠåˆ°ç¤¾äº¤å…ƒç´ çš„æ—¶å€™ï¼Œæ’è¡Œæ¦œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚åœºæ™¯äº†ï¼Œå°±æˆ‘ä»¬é€šå¸¸è§åˆ°çš„æ’è¡Œæ¦œè€Œè¨€ï¼Œä¼šæä¾›ä»¥ä¸‹åŸºæœ¬åŠŸèƒ½

- å…¨çƒæ¦œå•ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·æ ¹æ®ç§¯åˆ†è¿›è¡Œæ’åï¼Œå¹¶åœ¨æ¦œå•ä¸Šå±•ç¤ºå‰å¤šå°‘
- ä¸ªäººæ’åï¼Œç”¨æˆ·æŸ¥è¯¢è‡ªå·±æ‰€åœ¨æ¦œå•çš„ä½ç½®ï¼Œå¹¶è·çŸ¥å‘¨è¾¹å°ä¼™ä¼´çš„ç§¯åˆ†ï¼Œæ–¹ä¾¿è‡ªå·±æ¯”è¾ƒå’Œè¶…è¶Š
- å®æ—¶æ›´æ–°ï¼Œç”¨æˆ·çš„ç§¯åˆ†å®æ—¶æ›´æ”¹ï¼Œæ¦œå•ä¹Ÿéœ€è¦å®æ—¶æ›´æ–°

ä¸Šé¢å¯ä»¥è¯´æ˜¯ä¸€ä¸ªæ’è¡Œæ¦œéœ€è¦å®ç°çš„å‡ ä¸ªåŸºæœ¬è¦ç´ äº†ï¼Œæ­£å¥½æˆ‘ä»¬åˆšè®²åˆ°äº†redisè¿™ä¸€èŠ‚ï¼Œæœ¬ç¯‡åˆ™å¼€å§‹å®æˆ˜ï¼Œè¯¦ç»†æè¿°å¦‚ä½•å€ŸåŠ©redisæ¥å®ç°ä¸€ä»½å…¨çƒæ’è¡Œæ¦œ

<!-- more -->

## I. æ–¹æ¡ˆè®¾è®¡

åœ¨è¿›è¡Œæ–¹æ¡ˆè®¾è®¡ä¹‹å‰ï¼Œå…ˆæ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„åº”ç”¨åœºæ™¯ï¼Œç„¶åè¿›è¡Œè¾…åŠ©è®¾è®¡ä¸å®ç°

### 1. ä¸šåŠ¡åœºæ™¯è¯´æ˜

ä»¥å‰ä¸€æ®µæ—¶é—´ç‰¹åˆ«ğŸ”¥çš„è·³ä¸€è·³è¿™ä¸ªå°æ¸¸æˆè¿›è¡Œè¯´æ˜ï¼Œå‡è®¾æˆ‘ä»¬è¿™ä¸ªæ¸¸æˆç”¨æˆ·éå¸ƒå…¨çƒï¼Œå› æ­¤æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªå…¨çƒçš„æ¦œå•ï¼Œæ¯ä¸ªç©å®¶éƒ½ä¼šæ ¹æ®è‡ªå·±çš„æˆ˜ç»©åœ¨æ’è¡Œæ¦œä¸­è·å–ä¸€ä¸ªæ’åï¼Œæˆ‘ä»¬éœ€è¦æ”¯æŒå…¨çƒæ¦œå•çš„æŸ¥è¯¢ï¼Œè‡ªå·±æ’ä½çš„æŸ¥è¯¢è¿™ä¸¤ç§æœ€åŸºæœ¬çš„æŸ¥è¯¢åœºæ™¯ï¼›æ­¤å¤–å½“æˆ‘çš„åˆ†æ•°æ¯”ä¸Šä¸€æ¬¡çš„é«˜æ—¶ï¼Œæˆ‘éœ€è¦æ›´æ–°æˆ‘çš„ç§¯åˆ†ï¼Œé‡æ–°è·å¾—æˆ‘çš„æ’åï¼›

æ­¤å¤–ä¹Ÿä¼šæœ‰ä¸€äº›é«˜çº§çš„ç»Ÿè®¡ï¼Œæ¯”å¦‚å“ªä¸ªåˆ†æ®µçš„äººæ•°æœ€å¤šï¼Œä»€ä¹ˆåˆ†æ®µæ˜¯ç“¶é¢ˆç‚¹ï¼Œå†æ ¹æ®åœ°ç†ä½ç½®è®¡ç®—å¹³å‡åˆ†ç­‰ç­‰

æœ¬ç¯‡åšæ–‡ä¸»è¦å†…å®¹å°†æ”¾åœ¨æ’è¡Œæ¦œçš„è®¾è®¡ä¸å®ç°ä¸Šï¼›è‡³äºé«˜çº§çš„åŠŸèƒ½å®ç°ï¼Œåç»­æœ‰æœºä¼šå†è¯´

### 2. æ•°æ®ç»“æ„

å› ä¸ºæ’è¡Œæ¦œçš„åŠŸèƒ½æ¯”è¾ƒç®€å•äº†ï¼Œä¹Ÿä¸éœ€è¦ä»€ä¹ˆå¤æ‚çš„ç»“æ„è®¾è®¡ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„äº¤äº’ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¡®è®¤çš„æ— éå°±æ˜¯æ•°æ®ç»“æ„ + å­˜å‚¨å•å…ƒ

**å­˜å‚¨å•å…ƒ**

è¡¨ç¤ºæ’è¡Œæ¦œä¸­æ¯ä¸€ä½ä¸Šåº”è¯¥æŒæœ‰çš„ä¿¡æ¯ï¼Œä¸€ä¸ªæœ€ç®€å•çš„å¦‚ä¸‹

```java
// ç”¨æ¥è¡¨æ˜å…·ä½“çš„ç”¨æˆ·
long userId;
// ç”¨æˆ·åœ¨æ’è¡Œæ¦œä¸Šçš„æ’å
long rank;
// ç”¨æˆ·çš„å†å²æœ€é«˜ç§¯åˆ†ï¼Œä¹Ÿå°±æ˜¯æ’è¡Œæ¦œä¸Šçš„ç§¯åˆ†
long score;
```

**æ•°æ®ç»“æ„**

æ’è¡Œæ¦œï¼Œä¸€èˆ¬è€Œè¨€éƒ½æ˜¯è¿ç»­çš„ï¼Œå€Ÿæ­¤æˆ‘ä»¬å¯ä»¥è”æƒ³åˆ°ä¸€ä¸ªåˆé€‚çš„æ•°æ®ç»“æ„LinkedListï¼Œå¥½å¤„åœ¨äºæ’åå˜åŠ¨æ—¶ï¼Œä¸éœ€è¦æ•°ç»„çš„æ‹·è´

![arch](http://spring.hhui.top/spring-blog/imgs/181225/00.jpg)

ä¸Šå›¾æ¼”ç¤ºï¼Œå½“ä¸€ä¸ªç”¨æˆ·ç§¯åˆ†æ”¹å˜æ—¶ï¼Œéœ€è¦å‘å‰éå†æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œæ’å…¥å¹¶è·å–æ–°çš„æ’å, åœ¨æ›´æ–°å’Œæ’å…¥æ—¶ï¼Œç›¸æ¯”è¾ƒäºArrayListè¦å¥½å¾ˆå¤šï¼Œä½†ä¾ç„¶æœ‰ä»¥ä¸‹å‡ ä¸ªç¼ºé™·

**é—®é¢˜1ï¼šç”¨æˆ·å¦‚ä½•è·å–è‡ªå·±çš„æ’åï¼Ÿ**

ä½¿ç”¨`LinkedList`åœ¨æ›´æ–°æ’å…¥å’Œåˆ é™¤çš„å¸¦æ¥ä¼˜åŠ¿ä¹‹å¤–ï¼Œåœ¨éšæœºè·å–å…ƒç´ çš„æ”¯æŒä¼šå·®ä¸€ç‚¹ï¼Œæœ€å·®çš„æƒ…å†µå°±æ˜¯ä»å¤´åˆ°å°¾è¿›è¡Œæ‰«æ

**é—®é¢˜2ï¼šå¹¶å‘æ”¯æŒçš„é—®é¢˜ï¼Ÿ**

å½“æœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶æ›´æ–°scoreæ—¶ï¼Œå¹¶å‘çš„æ›´æ–°æ’åé—®é¢˜å°±æ¯”è¾ƒçªå‡ºäº†ï¼Œå½“ç„¶å¯ä»¥ä½¿ç”¨jdkä¸­ç±»ä¼¼å†™æ—¶æ‹·è´æ•°ç»„çš„æ–¹æ¡ˆ

ä¸Šé¢æ˜¯æˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™ä¸ªæ•°æ®ç»“æ„æ—¶ï¼Œä¼šé‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå½“ç„¶æˆ‘ä»¬çš„ä¸»é¢˜æ˜¯å€ŸåŠ©redisæ¥å®ç°æ’è¡Œæ¦œï¼Œä¸‹é¢åˆ™æ¥çœ‹ä¸‹ï¼Œåˆ©ç”¨rediså¯ä»¥æ€ä¹ˆç®€å•çš„æ”¯æŒæˆ‘ä»¬çš„éœ€æ±‚åœºæ™¯

### 3. redisä½¿ç”¨æ–¹æ¡ˆ

è¿™é‡Œä¸»è¦ä½¿ç”¨çš„æ˜¯redisçš„ZSETæ•°æ®ç»“æ„ï¼Œå¸¦æƒé‡çš„é›†åˆï¼Œä¸‹é¢åˆ†æä¸€ä¸‹å¯èƒ½æ€§

- set: é›†åˆç¡®ä¿é‡Œé¢å…ƒç´ çš„å”¯ä¸€æ€§
- æƒé‡ï¼šè¿™ä¸ªå¯ä»¥çœ‹åšæˆ‘ä»¬çš„scoreï¼Œè¿™æ ·æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªscoreï¼›
- zsetï¼šæ ¹æ®scoreè¿›è¡Œæ’åºçš„é›†åˆ

ä»zsetçš„ç‰¹æ€§æ¥çœ‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç”¨æˆ·çš„ç§¯åˆ†ï¼Œä¸¢åˆ°zsetä¸­ï¼Œå°±æ˜¯ä¸€ä¸ªå¸¦æƒé‡çš„å…ƒç´ ï¼Œè€Œä¸”æ˜¯å·²ç»æ’å¥½åºçš„äº†ï¼Œåªéœ€è¦è·å–å…ƒç´ å¯¹åº”çš„indexï¼Œå°±æ˜¯æˆ‘ä»¬é¢„æœŸçš„æ’å

## II. åŠŸèƒ½å®ç°

å†å…·ä½“çš„å®ç°ä¹‹å‰ï¼Œå¯ä»¥å…ˆæŸ¥çœ‹ä¸€ä¸‹redisä¸­zsetçš„ç›¸å…³æ–¹æ³•å’Œæ“ä½œå§¿åŠ¿ï¼š[SpringBooté«˜çº§ç¯‡Redisä¹‹ZSetæ•°æ®ç»“æ„ä½¿ç”¨å§¿åŠ¿](http://spring.hhui.top/spring-blog/2018/12/12/181212-SpringBoot%E9%AB%98%E7%BA%A7%E7%AF%87Redis%E4%B9%8BZSet%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF/)

æˆ‘ä»¬ä¸»è¦æ˜¯å€ŸåŠ©zsetæä¾›çš„ä¸€äº›æ–¹æ³•æ¥å®ç°æ’è¡Œæ¦œçš„éœ€æ±‚ï¼Œä¸‹é¢çš„å…·ä½“æ–¹æ³•è®¾è®¡ä¸­ï¼Œä¹Ÿä¼šæœ‰ç›¸å…³è¯´æ˜

### 0. å‰æå‡†å¤‡

é¦–å…ˆå‡†å¤‡å¥½redisç¯å¢ƒï¼Œspringé¡¹ç›®æ­å»ºå¥½ï¼Œç„¶åé…ç½®å¥½redisTemplate

```java
/**
 * Created by @author yihui in 15:05 18/11/8.
 */
public class DefaultSerializer implements RedisSerializer<Object> {
    private final Charset charset;

    public DefaultSerializer() {
        this(Charset.forName("UTF8"));
    }

    public DefaultSerializer(Charset charset) {
        Assert.notNull(charset, "Charset must not be null!");
        this.charset = charset;
    }


    @Override
    public byte[] serialize(Object o) throws SerializationException {
        return o == null ? null : String.valueOf(o).getBytes(charset);
    }

    @Override
    public Object deserialize(byte[] bytes) throws SerializationException {
        return bytes == null ? null : new String(bytes, charset);
    }
}


@Configuration
public class AutoConfig {

    @Bean(value = "selfRedisTemplate")
    public RedisTemplate<String, String> stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) {
        StringRedisTemplate redis = new StringRedisTemplate();
        redis.setConnectionFactory(redisConnectionFactory);

        // è®¾ç½®redisçš„String/Valueçš„é»˜è®¤åºåˆ—åŒ–æ–¹å¼
        DefaultSerializer stringRedisSerializer = new DefaultSerializer();
        redis.setKeySerializer(stringRedisSerializer);
        redis.setValueSerializer(stringRedisSerializer);
        redis.setHashKeySerializer(stringRedisSerializer);
        redis.setHashValueSerializer(stringRedisSerializer);

        redis.afterPropertiesSet();
        return redis;
    }
}
```

### 1. ç”¨æˆ·ä¸Šä¼ ç§¯åˆ†

ä¸Šä¼ ç”¨æˆ·ç§¯åˆ†ï¼Œç„¶è€Œzsetä¸­æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯å…¶æ’è¡Œæ˜¯æ ¹æ®scoreè¿›è¡Œå‡åºæ’åˆ—ï¼Œè¿™ä¸ªå°±å’Œæˆ‘ä»¬å®é™…çš„æƒ…å†µä¸å¤ªä¸€æ ·äº†ï¼›ä¸ºäº†å’Œå®é™…æƒ…å†µä¸€è‡´ï¼Œå¯ä»¥å°†scoreå–åï¼›å¦å¤–ä¸€ä¸ªå°±æ˜¯æ’è¡Œé»˜è®¤æ˜¯ä»0å¼€å§‹çš„ï¼Œè¿™ä¸ªä¸æˆ‘ä»¬çš„å®é™…ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œéœ€è¦+1

```java
/**
 * æ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼Œå¹¶è·å–æœ€æ–°çš„ä¸ªäººæ‰€åœ¨æ’è¡Œæ¦œä¿¡æ¯
 *
 * @param userId
 * @param score
 * @return
 */
public RankDO updateRank(Long userId, Float score) {
    // å› ä¸ºzseté»˜è®¤ç§¯åˆ†å°çš„åœ¨å‰é¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹scoreè¿›è¡Œå–åï¼Œè¿™æ ·ç”¨æˆ·çš„ç§¯åˆ†è¶Šå¤§ï¼Œå¯¹åº”çš„scoreè¶Šå°ï¼Œæ’åè¶Šé«˜
    redisComponent.add(RANK_PREFIX, String.valueOf(userId), -score);
    Long rank = redisComponent.rank(RANK_PREFIX, String.valueOf(userId));
    return new RankDO(rank + 1, score, userId);
}
```

ä¸Šé¢çš„å®ç°ï¼Œä¸»è¦åˆ©ç”¨äº†zsetçš„ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯æ·»åŠ å…ƒç´ ï¼Œä¸€ä¸ªæ˜¯æŸ¥è¯¢æ’åï¼Œå¯¹åº”çš„redisæ“ä½œæ–¹æ³•å¦‚ä¸‹ï¼Œ

```java
@Resource(name = "selfRedisTemplate")
private StringRedisTemplate redisTemplate;
    
/**
 * æ·»åŠ ä¸€ä¸ªå…ƒç´ , zsetä¸setæœ€å¤§çš„åŒºåˆ«å°±æ˜¯æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªscoreï¼Œå› æ­¤æœ‰ä¸ªæ’åºçš„è¾…åŠ©åŠŸèƒ½;  zadd
 *
 * @param key
 * @param value
 * @param score
 */
public void add(String key, String value, double score) {
    redisTemplate.opsForZSet().add(key, value, score);
}

    /**
 * åˆ¤æ–­valueåœ¨zsetä¸­çš„æ’å  zrank
 *
 * ç§¯åˆ†å°çš„åœ¨å‰é¢
 *
 * @param key
 * @param value
 * @return
 */
public Long rank(String key, String value) {
    return redisTemplate.opsForZSet().rank(key, value);
}
```

### 2. è·å–ä¸ªäººæ’å

è·å–ä¸ªäººæ’è¡Œä¿¡æ¯ï¼Œä¸»è¦å°±æ˜¯ä¸¤ä¸ªä¸€ä¸ªæ˜¯æ’åä¸€ä¸ªæ˜¯ç§¯åˆ†ï¼›éœ€è¦æ³¨æ„çš„æ˜¯å½“ç”¨æˆ·æ²¡æœ‰ç§¯åˆ†æ—¶ï¼ˆå³æ²¡æœ‰ä¸Šæ¦œæ—¶ï¼‰ï¼Œéœ€è¦é¢å¤–å¤„ç†

```java
/**
 * è·å–ç”¨æˆ·çš„æ’è¡Œæ¦œä½ç½®
 *
 * @param userId
 * @return
 */
public RankDO getRank(Long userId) {
    // è·å–æ’è¡Œï¼Œ å› ä¸ºé»˜è®¤æ˜¯0ä¸ºå¼€å¤´ï¼Œå› æ­¤å®é™…çš„æ’åéœ€è¦+1
    Long rank = redisComponent.rank(RANK_PREFIX, String.valueOf(userId));
    if (rank == null) {
        // æ²¡æœ‰æ’è¡Œæ—¶ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªé»˜è®¤çš„
        return new RankDO(-1L, 0F, userId);
    }

    // è·å–ç§¯åˆ†
    Double score = redisComponent.score(RANK_PREFIX, String.valueOf(userId));
    return new RankDO(rank + 1, Math.abs(score.floatValue()), userId);
}
```

ä¸Šé¢çš„å°è£…ä¸­ï¼Œé™¤äº†ä½¿ç”¨å‰é¢çš„è·å–ç”¨æˆ·æ’åä¹‹å¤–ï¼Œè¿˜æœ‰è·å–ç”¨æˆ·ç§¯åˆ†

```java
/**
 * æŸ¥è¯¢valueå¯¹åº”çš„score   zscore
 *
 * @param key
 * @param value
 * @return
 */
public Double score(String key, String value) {
    return redisTemplate.opsForZSet().score(key, value);
}
```

### 3. è·å–ä¸ªäººå‘¨è¾¹ç”¨æˆ·ç§¯åˆ†åŠæ’è¡Œä¿¡æ¯

æœ‰äº†å‰é¢çš„åŸºç¡€ä¹‹åï¼Œè¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œé¦–å…ˆè·å–ç”¨æˆ·çš„ä¸ªäººæ’åï¼Œç„¶åæŸ¥è¯¢å›ºå®šæ’åæ®µçš„æ•°æ®å³å¯

```java
private List<RankDO> buildRedisRankToBizDO(Set<ZSetOperations.TypedTuple<String>> result, long offset) {
    List<RankDO> rankList = new ArrayList<>(result.size());
    long rank = offset;
    for (ZSetOperations.TypedTuple<String> sub : result) {
        rankList.add(new RankDO(rank++, Math.abs(sub.getScore().floatValue()), Long.parseLong(sub.getValue())));
    }
    return rankList;
}

/**
 * è·å–ç”¨æˆ·æ‰€åœ¨æ’è¡Œæ¦œçš„ä½ç½®ï¼Œä»¥åŠæ’è¡Œæ¦œä¸­å…¶å‰ånä¸ªç”¨æˆ·çš„æ’è¡Œä¿¡æ¯
 *
 * @param userId
 * @param n
 * @return
 */
public List<RankDO> getRankAroundUser(Long userId, int n) {
    // é¦–å…ˆæ˜¯è·å–ç”¨æˆ·å¯¹åº”çš„æ’å
    RankDO rank = getRank(userId);
    if (rank.getRank() <= 0) {
        // fixme ç”¨æˆ·æ²¡æœ‰ä¸Šæ¦œæ—¶ï¼Œä¸è¿”å›
        return Collections.emptyList();
    }

    // å› ä¸ºå®é™…çš„æ’åæ˜¯ä»0å¼€å§‹çš„ï¼Œæ‰€ä»¥æŸ¥è¯¢å‘¨è¾¹æ’åæ—¶ï¼Œéœ€è¦å°†n-1
    Set<ZSetOperations.TypedTuple<String>> result =
            redisComponent.rangeWithScore(RANK_PREFIX, Math.max(0, rank.getRank() - n - 1), rank.getRank() + n - 1);
    return buildRedisRankToBizDO(result, rank.getRank() - n);
}
```

çœ‹ä¸‹ä¸Šé¢çš„å®ç°ï¼Œè·å–ç”¨æˆ·æ’åä¹‹åï¼Œå°±å¯ä»¥è®¡ç®—è¦æŸ¥è¯¢çš„æ’åèŒƒå›´`[Math.max(0, rank.getRank() - n - 1), rank.getRank() + n - 1]`

å…¶æ¬¡éœ€è¦æ³¨æ„çš„å¦‚ä½•å°†è¿”å›çš„ç»“æœè¿›è¡Œå°è£…ï¼Œä¸Šé¢å†™äº†ä¸ªè½¬æ¢ç±»ï¼Œä¸»è¦èµ·å§‹æ’è¡Œæ¦œä¿¡æ¯


### 4. è·å–topnæ’è¡Œæ¦œ

ä¸Šé¢çš„ç†è§£ä¹‹åï¼Œè¿™ä¸ªå°±å¾ˆç®€ç­”äº†

```java
/**
 * è·å–å‰nåçš„æ’è¡Œæ¦œæ•°æ®
 *
 * @param n
 * @return
 */
public List<RankDO> getTopNRanks(int n) {
    Set<ZSetOperations.TypedTuple<String>> result = redisComponent.rangeWithScore(RANK_PREFIX, 0, n - 1);
    return buildRedisRankToBizDO(result, 1);
}
```

## III. æµ‹è¯•å°ç»“

é¦–å…ˆå‡†å¤‡ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œæ‰¹é‡çš„æ’å…¥ä¸€ä¸‹ç§¯åˆ†ï¼Œç”¨äºåç»­çš„æŸ¥è¯¢æ›´æ–°ä½¿ç”¨

```java
public class RankInitTest {

    private Random random;
    private RestTemplate restTemplate;

    @Before
    public void init() {
        random = new Random();
        restTemplate = new RestTemplate();
    }

    private int genUserId() {
        return random.nextInt(1024);
    }

    private double genScore() {
        return random.nextDouble() * 100;
    }

    @Test
    public void testInitRank() {
        for (int i = 0; i < 30; i++) {
            restTemplate.getForObject("http://localhost:8080/update?userId=" + genUserId() + "&score=" + genScore(),
                    String.class);
        }
    }
}
```

### 1. æµ‹è¯•

ä¸Šé¢æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ’è¡Œæ¦œä¸­åº”è¯¥å°±æœ‰ä¸‰åæ¡æ•°æ®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹é€ä¸ªæ¥å£æµ‹è¯•ï¼Œé¦–å…ˆè·å–top10æ’è¡Œ

å¯¹åº”çš„restæ¥å£å¦‚ä¸‹

```java
@RestController
public class RankAction {
    @Autowired
    private RankListComponent rankListComponent;

    @GetMapping(path = "/topn")
    public List<RankDO> showTopN(int n) {
        return rankListComponent.getTopNRanks(n);
    }
}
```

![topn](http://spring.hhui.top/spring-blog/imgs/181225/00.gif)

æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘é€‰ç¬¬15åï¼Œè·å–å¯¹åº”çš„æ’è¡Œæ¦œä¿¡æ¯

```java
@GetMapping(path = "/rank")
public RankDO queryRank(long userId) {
    return rankListComponent.getRank(userId);
}
```

é¦–å…ˆæˆ‘ä»¬ä»redisä¸­è·å–ç¬¬15åçš„userIdï¼Œç„¶åå†æ¥æŸ¥è¯¢

![rank](http://spring.hhui.top/spring-blog/imgs/181225/01.gif)

ç„¶åå°è¯•ä¿®æ”¹ä¸‹ä»–çš„ç§¯åˆ†ï¼Œæ”¹å¤§ä¸€ç‚¹ï¼Œå°†scoreæ”¹æˆ80åˆ†ï¼Œåˆ™ä¼šæ’åˆ°ç¬¬äº”å

```java
@GetMapping(path = "/update")
public RankDO updateScore(long userId, float score) {
    return rankListComponent.updateRank(userId, score);
}
```

![update](http://spring.hhui.top/spring-blog/imgs/181225/02.gif)


æœ€åæˆ‘ä»¬æŸ¥è¯¢ä¸‹è¿™ä¸ªç”¨æˆ·å‘¨è¾¹2ä¸ªçš„æ’åä¿¡æ¯

```java
@GetMapping(path = "/around")
public List<RankDO> around(long userId, int n) {
    return rankListComponent.getRankAroundUser(userId, n);
}
```
![around](http://spring.hhui.top/spring-blog/imgs/181225/03.gif)


### 2. å°ç»“

ä¸Šé¢åˆ©ç”¨redisçš„zsetå®ç°äº†æ’è¡Œæ¦œçš„åŸºæœ¬åŠŸèƒ½ï¼Œä¸»è¦å€ŸåŠ©ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•

- range è·å–èŒƒå›´æ’è¡Œä¿¡æ¯
- score è·å–å¯¹åº”çš„score
- range è·å–å¯¹åº”çš„æ’å

è™½ç„¶å®ç°äº†åŸºæœ¬åŠŸèƒ½ï¼Œä½†æ˜¯é—®é¢˜è¿˜æ˜¯æœ‰ä¸å°‘çš„

- ä¸Šé¢çš„å®ç°ï¼Œredisçš„å¤åˆæ“ä½œï¼ŒåŸå­æ€§é—®é¢˜
- ç”±åŸå­æ€§é—®é¢˜å¯¼è‡´å¹¶å‘å®‰å…¨é—®é¢˜
- æ€§èƒ½æ€ä¹ˆæ ·éœ€è¦æµ‹è¯•

## III. å…¶ä»–

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- moduleæºç : [spring-case/120-redis-ranklist](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-case/120-redis-ranklist)

