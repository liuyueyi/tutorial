---
order: 5
title: 5.å€ŸåŠ©redisæ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ï¼ˆåº”ç”¨ç¯‡ï¼‰
tag: 
  - Redis
category: 
  - SpringBoot
  - DBç³»åˆ—
  - Redis
  - åº”ç”¨ç¯‡
date: 2021-08-05 08:35:41
keywords: redis å»¶æ—¶é˜Ÿåˆ— spring
---

å»¶æ—¶é˜Ÿåˆ—ï¼Œç›¸ä¿¡å„ä½å°ä¼™ä¼´å¹¶ä¸ä¼šé™Œç”Ÿï¼ŒjdkåŸç”Ÿæä¾›äº†å»¶æ—¶é˜Ÿåˆ—çš„ä½¿ç”¨ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œä»‹ç»çš„ä¸æ˜¯è¿™ç§ï¼›åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å»¶æ—¶é˜Ÿåˆ—çš„åœºæ™¯ï¼Œå¯ä»¥æ€æ ·å»å®ç°å‘¢

ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚ä¸‹å•15åˆ†é’Ÿå†…ï¼Œè‹¥æ²¡æœ‰æ”¯ä»˜ï¼Œåˆ™è‡ªåŠ¨å–æ¶ˆè®¢å•

æœ¬æ–‡å°†ä»‹ç»ä¸€ç§éå¸¸éå¸¸ç®€å•çš„å®ç°æ–¹å¼

<!-- more -->

## I. æ–¹æ¡ˆè®¾è®¡

è¦å®ç°15åˆ†é’Ÿåè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼Œè¿™ä¸ªä¹Ÿå¤ªç®€å•äº†ï¼Œæ¥ç»™å‡ºä¸€æ®µç¥çº§ä»£ç 

```java
new Thread(() -> {
  // ä¼‘çœ åäº”åˆ†é’Ÿï¼Œæ‰§è¡Œå–æ¶ˆè®¢å•
  Thread.sleep(15 * 60 * 1000);
  cancelOrder(); 
}).start();
```

å¥½çš„ï¼Œæœ¬æ–‡å°±æ­¤ç»“æŸï¼ˆå¼€ç©ç¬‘....ï¼‰

å¿½ç•¥ä¸Šé¢çš„æ®µå­ï¼Œæ¥ä¸‹æ¥æƒ³ä¸€æƒ³ï¼Œå¦‚æœè®©æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—ï¼Œå¯ä»¥æ€ä¹ˆæ•´ï¼Ÿ

- å•æœºï¼š
  - DelayQueue
  - å®šæ—¶ä»»åŠ¡
- åˆ†å¸ƒå¼: 
  - Quartzå®šæ—¶ä»»åŠ¡
  - rabbitmqå»¶æ—¶é˜Ÿåˆ—
  - redis zset
  - redis è¿‡æœŸå›è°ƒ
  - æ—¶é—´è½®

é¦–å…ˆæˆ‘ä»¬è¿™é‡Œæ’é™¤æ‰å•æœºç‰ˆï¼Œè‡³äºåŸå› ï¼Œç°åœ¨å•ä½“å•å®ä¾‹åº”ç”¨å®åœ¨ä¸å¤šè§äº†ï¼Œç›´æ¥æ¥çœ‹å¤šå®ä¾‹çš„æƒ…å†µå§

åœ¨ä¸Šé¢çš„å‡ ç§æ–¹æ¡ˆä¸­ï¼Œé‡å¿ƒæ”¾åœ¨redisä¸Šï¼Œä¸¤ç§caseï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸€ä¸‹

### 1. redisè¿‡æœŸæ—¶é—´

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä½¿ç”¨redisåšç¼“å­˜æ—¶ï¼Œå¯ä»¥è®¾ç½®å¤±æ•ˆæ—¶é—´ï¼Œå€ŸåŠ©redisçš„å¤±æ•ˆäº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¥å®ç°å»¶æ—¶é˜Ÿåˆ—çš„åœºæ™¯

æ¯”å¦‚ï¼Œç°åœ¨ä¸€ä¸ªè®¢å•ï¼Œæˆ‘ä»¬åœ¨redisä¸­æ–°åŠ å…¥ä¸€ä¸ªè®¢å•idï¼Œå¤±æ•ˆæ—¶é—´è®¾ç½®ä¸º15åˆ†é’Ÿï¼›å½“æ”¯ä»˜æˆåŠŸä¹‹åï¼Œä¸»åŠ¨åˆ é™¤è¿™ä¸ªç¼“å­˜ï¼›è‹¥ä¸€ç›´æ²¡æœ‰ä»˜é’±ï¼Œåˆ™15åˆ†é’Ÿåï¼Œè§¦å‘ä¸€ä¸ªè¿‡æœŸäº‹ä»¶ï¼Œç„¶åè®¢é˜…è¿™ä¸ªäº‹ä»¶ï¼Œæ¥æ‰§è¡Œå–æ¶ˆè®¢å•

ä¸Šé¢è¿™ç§å®ç°ï¼Œæœ‰ä¸¤ä¸ªé—®é¢˜

- keyå¤±æ•ˆç›‘å¬ï¼Œå¯èƒ½å­˜åœ¨å¤§é‡çš„æ— æ•ˆä¿¡æ¯
- å¹¿æ’­æ–¹å¼æ¶ˆè´¹äº‹ä»¶ï¼Œå¤šå®ä¾‹æ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œæ€ä¹ˆé˜²å¹¶å‘ï¼Ÿæˆ–è€…æ²¡æœ‰ä¸€ä¸ªå®ä¾‹æ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªå–æ¶ˆè®¢å•å°±ä¼šæ¼æ‰

æ˜¾ç„¶ä¸Šé¢çš„ç¬¬äºŒç‚¹ï¼Œæ¼æ¶ˆæ¯æ˜¯ä¸èƒ½æ¥å—çš„

### 2. redis zset

zsetå±äºredisæä¾›çš„å‡ ä¸ªåŸºæœ¬æ•°æ®ç»“æ„ä¸­çš„ä¸€ç§ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯æœ‰ `value + score`

å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨zsetæ‹‰å®ç°æ¼”ç¤ºé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¸€ä¸ªå¯é€‰çš„æ–¹æ¡ˆå°±æ˜¯å°†scoreè®¾ç½®ä¸ºè§¦å‘çš„æ—¶é—´æˆ³ï¼Œvalueä¸ºä¸šåŠ¡å€¼

ç„¶åå†™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¸æ–­çš„ä»zsetä¸­ï¼Œå–å‡ºscoreå°äºå½“å‰æ—¶é—´æˆ³çš„æ•°æ®ï¼Œä»»åŠ¡å®ƒä»¬éƒ½æ˜¯å·²ç»åˆ°æœŸå¯ä»¥æ‰§è¡Œçš„

å€ŸåŠ©è¿™ä¸ªæ–¹æ¡ˆï¼Œå¯ä»¥ç›¸å¯¹ç®€å•çš„å®ç°ä¸€ä¸ªæ¼”ç¤ºé˜Ÿåˆ—äº†

## II. redisæ¼”ç¤ºé˜Ÿåˆ—å®ç°

### 1. ç¯å¢ƒé…ç½®

æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»¥redisçš„zsetæ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ï¼Œæœ¬æ–‡å€ŸåŠ©SpringBootæ¥æ­å»ºä¸€ä¸ªæ¼”ç¤ºå·¥ç¨‹ï¼Œä½¿ç”¨çš„åŸºæœ¬é…ç½®å¦‚ä¸‹

æœ¬é¡¹ç›®å€ŸåŠ©`SpringBoot 2.2.1.RELEASE` + `maven 3.5.3` + `IDEA`è¿›è¡Œå¼€å‘

æ ¸å¿ƒä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<!-- ä¸‹é¢è¿™é‡Œä¸¤ä¸ªéå¿…é¡»ï¼Œä¸»è¦æ˜¯åé¢çš„å®ç°æ¼”ç¤ºä½¿ç”¨åˆ°äº† -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
</dependency>
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
</dependency>
```

redisä½¿ç”¨é»˜è®¤çš„é…ç½®ï¼Œæœ¬æœº `localhost + 6379`

### 2. æ ¸å¿ƒå®ç°

å€ŸåŠ©redis zsetæ¥å®ç°å»¶æ—¶é˜Ÿåˆ—ï¼Œå…·ä½“çš„å®ç°ä»£ç å°±å¾ˆç®€å•äº†ï¼Œæ— éæ˜¯ä»zsetä¸­å–å‡ºscoreå°äºå½“å‰æ—¶é—´æˆ³çš„æ•°æ®

```java
private static final Long DELETE_SUCCESS = 1L;
@Autowired
private StringRedisTemplate redisTemplate;

public String fetchOne(String key) {
    Set<String> sets = redisTemplate.opsForZSet().rangeByScore(key, 0, System.currentTimeMillis(), 0, 3);
    if (CollectionUtils.isEmpty(sets)) {
        return null;
    }

    for (String val : sets) {
        if (DELETE_SUCCESS.equals(redisTemplate.opsForZSet().remove(key, val))) {
            // åˆ é™¤æˆåŠŸï¼Œè¡¨ç¤ºæŠ¢å åˆ°
            return val;
        }
    }
    return null;
}
```

æ³¨æ„ä¸Šé¢çš„å®ç°ï¼Œæœ‰ä¸€ä¸ªç‚¹éœ€è¦è¯´ä¸€ä¸‹

zsetï¼šæ¯æ¬¡æŸ¥è¯¢æ—¶å–äº†ä¸‰ä¸ªæ•°æ®ï¼Œç„¶åéå†è·å–åˆ°çš„æ•°æ®ï¼Œä¾æ¬¡å°è¯•å»åˆ é™¤ï¼Œè‹¥åˆ é™¤æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰å®ä¾‹æŠ¢å åˆ°äº†è¿™ä¸ªæ¶ˆæ¯

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?**

è¿™é‡Œæœ‰ä¸¤ä¸ªç‚¹ï¼Œå…ˆè§£é‡Šç¬¬ä¸€ä¸ªï¼Œ**ä¸ºå•¥å…ˆæŸ¥ååˆ **

å¦‚æœæˆ‘ä»¬æŒ‰ç…§æ­£å¸¸çš„å®ç°æµç¨‹ï¼Œæ¯æ¬¡ä»zsetä¸­å–ä¸€ä¸ªï¼Œä½†æ˜¯æ— æ³•ä¿è¯è¿™ä¸ªæ—¶å€™å°±åªæœ‰æˆ‘ä¸€ä¸ªäººæ‹¿åˆ°äº†è¿™ä¸ªæ•°æ®ï¼Œåœ¨å¤šå®ä¾‹çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªå®ä¾‹åŒæ—¶æ‹¿åˆ°äº†å®ƒï¼Œé‚£ä¹ˆå¦‚ä½•æ‰èƒ½è¡¨ç¤ºåªæœ‰æˆ‘ä¸€ä¸ªäººéœ¸å äº†å¥¹å‘¢ï¼ˆå¿½ç„¶è¿›å…¥è¨€æƒ…çš„ä¸–ç•ŒğŸ˜“ï¼‰

å€ŸåŠ©redisçš„å•çº¿ç¨‹æœºåˆ¶ï¼Œåªå¯èƒ½æœ‰ä¸€ä¸ªå®ä¾‹ä¼šåˆ é™¤æˆåŠŸï¼Œæ‰€ä»¥æ‹¿åˆ°å¹¶åˆ é™¤æˆåŠŸçš„é‚£ä¸ªå°ä¼™ä¼´ï¼Œå°±æ˜¯æœ€ç»ˆçš„å¹¸è¿å„¿ï¼›

å› æ­¤å®ç°ç»†èŠ‚å°±æ˜¯å…ˆæŸ¥ï¼Œååˆ ï¼Œè‹¥åˆ é™¤æˆåŠŸï¼Œè¡¨ç¤ºè·å–æˆåŠŸï¼›å¦åˆ™è¡¨ç¤ºè¢«å…¶ä»–çš„å®ä¾‹æ·è¶³å…ˆç™»

æ¥ä¸‹æ¥å†çœ‹ç¬¬äºŒä¸ªï¼Œ**ä¸ºå•¥ä¸€æ¬¡æ‹¿ä¸‰ä¸ª**

ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæˆ‘ä¸€æ¬¡åªæ‹¿ä¸€ä¸ªï¼Œé‚£ä¹ˆæˆ‘æŠ¢å åˆ°çš„å‡ ç‡å¹¶ä¸å¤ªå¤§ï¼Œç‰¹åˆ«æ˜¯å½“å®ä¾‹æ¯”è¾ƒå¤šæ—¶ï¼Œå¯èƒ½ä¼šåšå¤šæ¬¡çš„æ— æ•ˆæ“ä½œï¼›ä¸ºäº†å‡å°‘è¿™ä¸ªå¯èƒ½æ€§ï¼Œæ‰€ä»¥æˆ‘ä¸€æ¬¡å¤šæ‹¿å‡ ä¸ªåšå¤‡é€‰ï¼Œè¿™æ ·æŠ¢å åˆ°çš„æ¦‚ç‡å°±ä¼šé«˜ä¸€äº›ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯3ï¼Œè¿™ä¸ªå°±çœ‹å®é™…çš„å®ä¾‹ä¸å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œé—´éš”äº†

### 3. å†™å…¥é˜Ÿåˆ—

ä¸Šé¢æ˜¯ä»é˜Ÿåˆ—ä¸­æ‹¿æ•°æ®ï¼Œæœ‰æ‹¿å½“ç„¶å¾—æœ‰å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•çš„å°è£…ä¸€ä¸‹å†™å…¥é˜Ÿåˆ—çš„case

```java
@Component
public class RedisDelayListWrapper implements ApplicationContextAware {
    private static final Long DELETE_SUCCESS = 1L;
 
    private Set<String> topic = new CopyOnWriteArraySet<>();

    public void publish(String key, Object val, long delayTime) {
        topic.add(key);
        String strVal = val instanceof String ? (String) val : JSONObject.toJSONString(val);

        redisTemplate.opsForZSet().add(key, strVal, System.currentTimeMillis() + delayTime);
    }
}
```

### 4. å®šæ—¶å–æ¼”ç¤ºé˜Ÿåˆ—æ¶ˆæ¯

æ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¸æ–­çš„è°ƒç”¨ä¸Šé¢çš„å®ç°ï¼Œä»zsetä¸­è·å–åˆ°æœŸçš„æ•°æ®

```java
@Scheduled(fixedRate = 10_000)
public void schedule() {
    for (String specialTopic : topic) {
        String cell = fetchOne(specialTopic);
        if (cell != null) {
            applicationContext.publishEvent(new DelayMsg(this, cell, specialTopic));
        }
    }
}

@ToString
public static class DelayMsg extends ApplicationEvent {
    @Getter
    private String msg;
    @Getter
    private String topic;

    public DelayMsg(Object source, String msg, String topic) {
        super(source);
        this.msg = msg;
        this.topic = topic;
    }
}
```

ä¸Šé¢çš„å®šæ—¶ä»»åŠ¡ï¼Œç›´æ¥å€ŸåŠ©Springçš„`@Schedule`æ¥å®ç°ï¼Œéå†æ‰€æœ‰çš„topicï¼Œæå‡ºæ•°æ®ä¹‹åï¼Œé€šè¿‡springçš„ `event/listener`äº‹ä»¶æœºåˆ¶æ¥å®ç°æ¶ˆæ¯å¤„ç†çš„è§£è€¦

### 5. æ¶ˆæ¯æ¶ˆè´¹

æœ€ç»ˆå°±æ˜¯æˆ‘ä»¬çš„æ¶ˆæ¯æ¶ˆè´¹é€»è¾‘äº†ï¼Œä¸»è¦å°±æ˜¯æ¶ˆè´¹å‰é¢æŠ›å‡ºçš„`DelayMsg`ï¼Œæˆ‘ä»¬è¿™é‡Œå€ŸåŠ©AOPæ¥å®ç°æ¶ˆæ¯è¿‡æ»¤

å®šä¹‰ä¸€ä¸ªæ³¨è§£`Consumer`ï¼Œç”¨æ¥æŒ‡å®šæ¶ˆè´¹å“ªä¸ªtopic

```java
@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@EventListener
public @interface Consumer {
    String topic();
}
```

æ³¨æ„è¿™ä¸ªæ³¨è§£ä¸Šé¢è¿˜æœ‰ `@EventListener`ï¼Œè¡¨æ˜å®ƒå¯ä»¥ç›‘å¬çš„springçš„äº‹ä»¶

aopæ‹¦æˆªé€»è¾‘ï¼Œæ ¹æ®topicè¿›è¡Œè¿‡æ»¤

```java
@Aspect
@Component
public class ConsumerAspect {

    @Around("@annotation(consumer)")
    public Object around(ProceedingJoinPoint joinPoint, Consumer consumer) throws Throwable {
        Object[] args = joinPoint.getArgs();
        boolean check = false;
        for (Object obj : args) {
            if (obj instanceof RedisDelayListWrapper.DelayMsg) {
                check = consumer.topic().equals(((RedisDelayListWrapper.DelayMsg) obj).getTopic());
            }
        }

        if (!check) {
            // ä¸æ»¡è¶³æ¡ä»¶ï¼Œç›´æ¥å¿½ç•¥
            return null;
        }

        // topicåŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œ
        return joinPoint.proceed();
    }
}
```

### 5. æµ‹è¯•demo

æœ€åå†™ä¸€ä¸ªæµ‹è¯•demoï¼ŒéªŒè¯ä¸‹ä¸Šé¢çš„å®ç°

```java
@EnableScheduling
@RestController
@SpringBootApplication
public class Application {
    private static final String TEST_DELAY_QUEUE = "test";
    private static final String DEMO_DELAY_QUEUE = "demo";
    @Autowired
    private RedisDelayListWrapper redisDelayListWrapper;

    private Random random = new Random();

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }

    @GetMapping(path = "publish")
    public String publish(String msg, Long delayTime) {
        if (delayTime == null) {
            delayTime = 10_000L;
        }

        String queue = random.nextBoolean() ? TEST_DELAY_QUEUE : DEMO_DELAY_QUEUE;
        msg = queue + "#" + msg + "#" + (System.currentTimeMillis() + delayTime);
        redisDelayListWrapper.publish(queue, msg, delayTime);
        System.out.println("å»¶æ—¶: " + delayTime + "msåæ¶ˆè´¹: " + msg + " now:" + LocalDateTime.now());
        return "success!";
    }


    @Consumer(topic = TEST_DELAY_QUEUE)
    public void consumer(RedisDelayListWrapper.DelayMsg delayMsg) {
        System.out.println("TESTæ¶ˆè´¹å»¶æ—¶æ¶ˆæ¯: " + delayMsg + " at:" + System.currentTimeMillis());
    }

    @Consumer(topic = DEMO_DELAY_QUEUE)
    public void consumerDemo(RedisDelayListWrapper.DelayMsg delayMsg) {
        System.out.println("DEMOæ¶ˆè´¹å»¶æ—¶æ¶ˆæ¯: " + delayMsg + " at:" + System.currentTimeMillis());
    }
}
```

![](/imgs/210805/00.jpg)

### 6. å°ç»“

æœ¬æ–‡å±äºä¸€ä¸ªå®æˆ˜å°æŠ€å·§ï¼Œå€ŸåŠ©redisçš„zsetæ¥çµæ´»çš„å®ç°ä¸€ä¸ªç®€å•çš„å»¶æ—¶é˜Ÿåˆ—ï¼Œå®ç°å€’æ˜¯æ²¡æœ‰å¤ªå¤§çš„éš¾åº¦ï¼Œå…¶ä¸­çš„ä¸€äº›å°ç»†èŠ‚è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œå¥½çš„ï¼Œä»Šå¤©åˆ†äº«åˆ°æ­¤overï¼Œæ¬¢è¿å„ä½è€é“æ¥æ’©ï¼Œå…¬ä¼—å· `ä¸€ç°ç°blog` ä½ å€¼å¾—æ‹¥æœ‰


## III. ä¸èƒ½é”™è¿‡çš„æºç å’Œç›¸å…³çŸ¥è¯†ç‚¹

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç ï¼š[https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-case/126-redis-delay-list](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-case/126-redis-delay-list)

### 1. å¾®ä¿¡å…¬ä¼—å·ï¼šä¸€ç°ç°Blog

å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œä»¥ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œéš¾å…æœ‰ç–æ¼å’Œé”™è¯¯ä¹‹å¤„ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œä¸åæ„Ÿæ¿€

ä¸‹é¢ä¸€ç°ç°çš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€›

- ä¸€ç°ç°Blogä¸ªäººåšå®¢ [https://blog.hhui.top](https://blog.hhui.top)
- ä¸€ç°ç°Blog-Springä¸“é¢˜åšå®¢ [http://spring.hhui.top](http://spring.hhui.top)


![ä¸€ç°ç°blog](https://spring.hhui.top/spring-blog/imgs/info/info.png)

