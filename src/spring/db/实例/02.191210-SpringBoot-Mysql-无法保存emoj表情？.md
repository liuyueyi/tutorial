---
order: 2
title: 2.SpringBoot+Mysql æ— æ³•ä¿å­˜emojè¡¨æƒ…
tag: 
  - MySql
  - DB
category: 
  - SpringBoot
  - DBç³»åˆ—
  - é‡‡å‘è®°å½•
date: 2019-12-10 18:03:41
keywords: SpringBoot emoj utf8mb4 mysql db
---

å°¤è®°å¾—å¾ˆä¹…ä»¥å‰ï¼Œæƒ³å­˜emojè¡¨æƒ…åˆ°mysqlä¸­ï¼Œéœ€è¦é¢å¤–çš„å°†emojè¡¨æƒ…è½¬ç ä¹‹åä¿å­˜ï¼Œæ¯æ¬¡è¯»å–æ—¶ï¼Œå†è§£ç è¿˜åŸæˆä¸€ä¸‹ï¼›æ¯æ¬¡è¿™ç§sbçš„æ“ä½œï¼ŒçœŸå¿ƒæ„Ÿè§‰å¿ƒå¡ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•ç›´æ¥å­˜å‘¢ï¼Ÿ

mysqlæœ¬èº«å¯ä»¥é€šè¿‡é€‰æ‹©ç¼–ç é›†ï¼ˆå¦‚utfbmb4ï¼‰æ¥æ”¯æŒemojè¡¨æƒ…ï¼Œç„¶è€Œä»Šå¤©é‡åˆ°äº†ä¸€ä¸ªç›¸å½“é¬¼ç•œçš„é—®é¢˜ï¼Œè¡¨ä¸­å¯ä»¥ç›´æ¥å†™å…¥emojè¡¨æƒ…ï¼Œä½†æ˜¯é€šè¿‡spring bootä»£ç å¡å…¥çš„emojæ—¶ï¼Œå´æŠ›å‡ºå¼‚å¸¸ï¼š

```bash
Caused by: java.sql.SQLException: Incorrect string value: '\xF0\x9F\x98\x9D\xE6\xB1...' for column 'nick' at row 1
	at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1084) ~[mysql-connector-java-5.1.30.jar:na]
	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4232) ~[mysql-connector-java-5.1.30.jar:na]
	at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4164) ~[mysql-connector-java-5.1.30.jar:na]
	at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2615) ~[mysql-connector-java-5.1.30.jar:na]
	at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2776) ~[mysql-connector-java-5.1.30.jar:na]
	at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2838) ~[mysql-connector-java-5.1.30.jar:na]
	at com.mysql.jdbc.PreparedStatement.executeInternal(PreparedStatement.java:2082) ~[mysql-connector-java-5.1.30.jar:na]
```

æ¥ä¸‹æ¥æ¼”ç¤ºä¸€ä¸‹æ­£ç¡®çš„ä½¿ç”¨å§¿åŠ¿ï¼Œä»¥åŠå¯¼è‡´ä¸Šé¢é—®é¢˜çš„é”™è¯¯caseï¼Œé¿å…å¤§å®¶é‡å¤é‡‡å‘

<!-- more -->

## I. Emojè¡¨æƒ…æ”¯æŒä¹‹æ—…

æ¥ä¸‹æ¥æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¯ä»¥ç›´æ¥å‘mysqlä¸­è¯»å–æˆ–å†™å…¥emojè¡¨æƒ…

### 1. è¡¨å­—ç¬¦é›†

é¦–å…ˆé’ˆå¯¹mysqlè¡¨ï¼Œéœ€è¦æŒ‡å®šå­—ç¬¦é›†ä¸º`utfbmb4`

```sql
CREATE TABLE `Subscribe` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `email` varchar(140) NOT NULL DEFAULT '',
  `nick` varchar(30) NOT NULL DEFAULT 'æ˜µç§°',
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '0 è®¢é˜…æœªæ¿€æ´»ï¼Œ 1 è®¢é˜…å·²æ¿€æ´» ï¼Œ 2 å–æ¶ˆè®¢é˜…',
  `created` int(13) NOT NULL DEFAULT '0' COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated` int(13) NOT NULL DEFAULT '0' COMMENT 'æ›´æ–°æ—¶é—´'
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
```

ä¸Šé¢ç›´æ¥è®¾ç½®è¡¨çš„å­—ç¬¦é›†ä¸º`utf8mb4`ï¼Œå¦‚æœæŸä¸ªè¡¨å·²ç»å­˜åœ¨ï¼Œä½†æ˜¯å­—ç¬¦é›†ä¸æ˜¯utf8mb4ï¼Œè¿™ç§caseä¸‹æˆ‘ä»¬ä¹Ÿå¯ä»¥å•ç‹¬çš„è®¾ç½®æŸä¸ªåˆ—çš„ç¼–ç å¦‚ä¸‹

```sql
ALTER TABLE `Subscribe` CHANGE `nick` `nick` VARCHAR(30)  CHARACTER SET utf8mb4 NOT NULL  DEFAULT '';
```

å¦‚ä¸Šè®¾ç½®ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªè¡¨ä¸­æ·»åŠ emoj

![](/imgs/191210/00.jpg)

### 2. SpringBootæ”¯æŒ

æ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜ï¼Œspringbooté¡¹ç›®ï¼Œå¦‚ä½•æ”¯æŒemojçš„æ’å…¥ï¼›é¦–å…ˆçœ‹ä¸€ä¸‹é¡¹ç›®ä¾èµ–

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.2.1.RELEASE</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>

<properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
    <java.version>1.8</java.version>
</properties>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-jdbc</artifactId>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
</dependencies>

<build>
    <pluginManagement>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </pluginManagement>
</build>
<repositories>
    <repository>
        <id>spring-snapshots</id>
        <name>Spring Snapshots</name>
        <url>https://repo.spring.io/libs-snapshot-local</url>
        <snapshots>
            <enabled>true</enabled>
        </snapshots>
    </repository>
    <repository>
        <id>spring-milestones</id>
        <name>Spring Milestones</name>
        <url>https://repo.spring.io/libs-milestone-local</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
    <repository>
        <id>spring-releases</id>
        <name>Spring Releases</name>
        <url>https://repo.spring.io/libs-release-local</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`2.2.1.RELEASE`ç‰ˆæœ¬ï¼Œè¯·ç¡®ä¿å¼•å…¥äº†ä¾èµ–`spring-boot-starter-jdbc` ä¸ `mysql-connector-java`

ç„¶åé…ç½®dbç›¸å…³å±æ€§, `application.properties`

```
## DataSource
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/story?useUnicode=true&characterEncoding=UTF-8&useSSL=false
spring.datasource.username=root
spring.datasource.password=
```

ç„¶åå°±å¯ä»¥æ„‰å¿«çš„è¿›è¡Œæµ‹è¯•äº†

```java
@Slf4j
@SpringBootApplication
public class Application {

    public Application(JdbcTemplate jdbcTemplate) {
        log.warn("application start!!!");

        // æ’å…¥emoj è¡¨æƒ…
        jdbcTemplate.update("insert into Subscribe (`email`, `nick`) values (?, ?)",
                UUID.randomUUID().toString() + "@t.com", "ğŸºç‹¼");

        List<Map<String, Object>> r = jdbcTemplate.queryForList("select * from Subscribe order by id desc limit 2");
        log.info("r: {}", r);
    }

    public static void main(String[] args) {
        SpringApplication.run(Application.class);
    }
}
```

å®æµ‹ç»“æœå¦‚ä¸‹

![](/imgs/191210/01.jpg)

è¿™ä¸ªä¸å·²ç»æ’å…¥æˆåŠŸäº†ä¹ˆï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæœ¬æ–‡å¼€å¤´çš„é‚£ä¸ªå¼‚å¸¸æ˜¯æ€ä¹ˆå›äº‹å‘¢


### 3. åœºæ™¯å¤ç°

å‡ºç°æ–‡ç« å¼€å¤´çš„é—®é¢˜ï¼Œä¸»è¦æ˜¯ç”±äº`mysql-connector-java`çš„ç‰ˆæœ¬é—®é¢˜å¯¼è‡´çš„ï¼Œæˆ‘ä»¬æ¥å¤ç°ä¸€ä¸‹ï¼Œé¦–å…ˆå°†ç‰ˆæœ¬æŒ‡å®šä¸º`5.1.30` (å› ä¸ºæˆ‘ä»¬å†…éƒ¨ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥é‡‡å‘äº†...)

```java
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.30</version>
</dependency>
```

å…¶æ¬¡éœ€è¦åœ¨ç¯å¢ƒé…ç½®ä¸­ï¼ŒæŒ‡å®šä¸€ä¸‹`driver-class-name`

```properties
spring.datasource.driver-class-name= com.mysql.jdbc.Driver
```

**æ³¨æ„**

è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨æ›´é«˜çš„`mysql-connector-java`ç‰ˆæœ¬ä¸­ï¼Œå·²ç»æ”¹æˆ`com.mysql.cj.jdbc.Driver`è¿™ä¸ªç±»äº†ï¼›å¦‚æœä¾æ—§é…ç½®ä¸Šé¢çš„Driverï¼Œåœ¨æ‰§è¡Œæ—¶ä¼šæœ‰ä¸€è¡Œæç¤º

![](/imgs/191210/02.jpg)

```
Loading class `com.mysql.jdbc.Driver'. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver'. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.
```

æœ€åå†æ¬¡æ‰§è¡Œå‰é¢çš„æµ‹è¯•ä»£ç ï¼Œå¼‚å¸¸å°±æ¥äº†

![](/imgs/191210/03.jpg)

### 4. å°ç»“

åœ¨mysqlä¸­å­˜å…¥emojè¡¨æƒ…çš„åœºæ™¯å¯ä»¥è¯´æ¯”è¾ƒå¤šäº†ï¼Œæ¯•ç«Ÿ21ä¸–çºªäº†ï¼Œä¸æ”¯æŒemojçš„åº”ç”¨æ˜¯æ²¡æœ‰å‰é€”çš„ï¼›é€šè¿‡å‰é¢çš„caseï¼Œå³ä»‹ç»äº†å¦‚ä½•æ­£ç¡®çš„è®©springbootåº”ç”¨æ”¯æŒemojè¡¨æƒ…ï¼Œä¹Ÿç»™å‡ºäº†ä¸€ä¸ªç”±äºç‰ˆæœ¬é—®é¢˜å¯¼è‡´çš„å‘

emojæ”¯æŒæ­¥éª¤

- é¦–å…ˆæ˜¯æºå¤´æ”¯æŒï¼Œéœ€è¦ä¿®æ”¹mysqlçš„è¡¨å­—ç¬¦é›†ï¼›æˆ–è€…ä¿®æ”¹æŸäº›åˆ—çš„å­—ç¬¦é›†ï¼Œè®¾ç½®ä¸ºutf8mb4
- æ³¨æ„å¼•å…¥çš„`mysql-connector-java`ç‰ˆæœ¬ï¼ŒåŠ¡å¿…é€‰æ‹©æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œ
  - å¦‚`springboot2.2.1.RELEASE`é»˜è®¤æä¾›çš„ç‰ˆæœ¬ä¸º`8.0.18`
  - è€Œæˆ‘ä»¬æ¼”ç¤ºä¸­çš„ `5.1.30` åˆ™ä¸æ”¯æŒemojæ’å…¥
- é©±åŠ¨ç±»ï¼Œæ–°ç‰ˆä¸­å·²ç»ä½¿ç”¨`com.mysql.cj.jdbc.Driver`æ›¿æ¢ä¹‹å‰çš„`com.mysql.jdbc.Driver`


## II. å…¶ä»–

### 0. é¡¹ç›®

- å·¥ç¨‹ï¼š[https://github.com/liuyueyi/spring-boot-demo](https://github.com/liuyueyi/spring-boot-demo)
- æºç æ¨¡å—: [https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/100-mysql](https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-boot/100-mysql)

