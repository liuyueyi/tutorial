---
title: 8.åƒç´ å›¾ç‰‡-GIFå›¾ç‰‡è½¬å­—ç¬¦åŠ¨å›¾
order: 9
tag:
  - QuickMedia
  - image-plugin
categorie: 
  - Quickç³»åˆ—
date: 2021-11-20 11:19:49
---


å‰é¢ä»‹ç»äº†ä¸¤ç¯‡åŸºäºjdkå®ç°å›¾ç‰‡ç°åº¦å¤„ç†ã€è½¬å­—ç¬¦å›¾ç‰‡çš„æ“ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨å°†ä¹‹å‰çš„èƒ½åŠ›æ‰©å±•ä¸€ä¸‹ï¼Œæ”¯æŒå°†ä¸€ä¸ªgifå›¾ç°åº¦åŒ–æˆ–è€…è½¬gifå­—ç¬¦å›¾

æœ¬æ–‡çš„å®ç°ä¸»è¦åœ¨å‰é¢ä¸¤ç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šæ¥å®ç°ï¼Œæ¨èæ²¡æœ‰çœ‹è¿‡çš„å°ä¼™ä¼´ä¹Ÿå¯ä»¥ç…ä¸€çœ¼

- [åƒç´ å›¾ç‰‡-å›¾ç‰‡ç°åº¦åŒ–](./06.å›¾ç‰‡ç°åº¦åŒ–.html)
- [åƒç´ å›¾ç‰‡-å›¾ç‰‡è½¬å­—ç¬¦å›¾](./07.å›¾ç‰‡è½¬å­—ç¬¦å›¾.html)

å•å¼ å›¾çš„ç°åº¦åŒ–ä¸è½¬å­—ç¬¦å®ç°ä¹‹åï¼Œgifå›¾çš„å®ç°å°±ç®€å•å¤šäº†ï¼›gifå›¾æ— éæ˜¯å¤šå¼ å›¾ç»„åˆè€Œæˆï¼Œå°†æ¯ä¸€å¼ å›¾è½¬æ¢ä¹‹åï¼Œå†é‡æ–°ç»„è£…æˆgifå›¾å°±å®Œäº‹äº†

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„gifå·¥å…·ç±»æ¥è‡ªäº [https://github.com/liuyueyi/quick-media/tree/master/plugins/base-plugin/src/main/java/com/github/hui/quick/plugin/base/gif](https://github.com/liuyueyi/quick-media/tree/master/plugins/base-plugin/src/main/java/com/github/hui/quick/plugin/base/gif)

æ ¸å¿ƒå…³é”®ç±»ä¸ºGifEncodeä¸GifDecodeï¼›å€ŸåŠ©å®ƒæ¥å®ç°gifå›¾çš„åŠ è½½ä¸ä¿å­˜

é¦–å…ˆæˆ‘ä»¬å°†ä¸Šç¯‡åšæ–‡ä¸­çš„è½¬å­—ç¬¦å›¾çš„æ–¹æ³•æŠ½å–ä¸€ä¸‹

```java
Color getAverage(BufferedImage image, int x, int y, int w, int h) {
    int red = 0;
    int green = 0;
    int blue = 0;

    int size = 0;
    for (int i = y; (i < h + y) && (i < image.getHeight()); i++) {
        for (int j = x; (j < w + x) && (j < image.getWidth()); j++) {
            int color = image.getRGB(j, i);
            red += ((color & 0xff0000) >> 16);
            green += ((color & 0xff00) >> 8);
            blue += (color & 0x0000ff);
            ++size;
        }
    }

    red = Math.round(red / (float) size);
    green = Math.round(green / (float) size);
    blue = Math.round(blue / (float) size);
    return new Color(red, green, blue);
}

private BufferedImage parseImg(BufferedImage img) {
    int w = img.getWidth(), h = img.getHeight();
    // åˆ›å»ºæ–°çš„ç°åº¦å›¾ç‰‡ç”»æ¿
    BufferedImage out = new BufferedImage(w, h, img.getType());
    Graphics2D g2d = out.createGraphics();
    g2d.setColor(null);
    g2d.fillRect(0, 0, w, h);

    int size = 12;
    Font font = new Font("å®‹ä½“", Font.BOLD, size);
    g2d.setFont(font);
    for (int x = 0; x < w; x += size) {
        for (int y = 0; y < h; y += size) {
            Color avgColor = getAverage(img, x, y, size, size);
            g2d.setColor(avgColor);
            g2d.drawString("ç°", x, y);
        }
    }
    g2d.dispose();
    return out;
}
```

æ¥ç€å°±æ˜¯Gifçš„æ“ä½œäº†

```java
@Test
public void testRender() throws IOException {
    String file = "https://c-ssl.duitang.com/uploads/item/201707/11/20170711194634_nTiK5.thumb.1000_0.gif";
    // ä»ç½‘ç»œä¸Šä¸‹è½½å›¾ç‰‡
    GifDecoder decoder = new GifDecoder();
    decoder.read(FileReadUtil.getStreamByFileName(file));

  // è¿™é‡Œæ˜¯æ ¸å¿ƒçš„è½¬æ¢é€»è¾‘
    List<ImmutablePair<BufferedImage, Integer>> frames = new ArrayList<>();
    for (int i = 0; i < decoder.getFrameCount(); i++) {
        BufferedImage img = decoder.getFrame(i);
        frames.add(ImmutablePair.of(parseImg(img), decoder.getDelay(i)));
    }

  // ä¸‹é¢æ˜¯ä¿å­˜gifå›¾
    File save = new File("/tmp/out2.gif");
    ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
    GifHelper.saveGif(frames, outputStream);
    FileOutputStream out = new FileOutputStream(save);
    out.write(outputStream.toByteArray());
    out.flush();
    out.close();
    System.out.printf("æ¸²æŸ“å®Œæˆ");
}
```

ä¸Šå›¾è½¬æ¢æˆåŠŸä¹‹åï¼Œè¾“å‡ºå¦‚ä¸‹

![](/imgs/211120/00.gif)


å¦‚æœå¸Œæœ›è¾“å‡ºå›¾ç‰‡æ›´åƒåŸå›¾ï¼Œå¯ä»¥ä¿®æ”¹ä¸Šé¢çš„fontSizeï¼Œæ¯”å¦‚ä¸Šé¢ç”¨çš„æ˜¯12ï¼Œå¯ä»¥è°ƒæ•´æˆ8ï¼Œ6ç­‰å€¼ï¼Œæ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©

æœ‰çš„å°ä¼™ä¼´å¯èƒ½ä¼šè¯´äº†ï¼ŒåŠ¨æ¼«çš„gifå›¾è½¬æ¢ä¹‹åç›¸ä¼¼åº¦è¿˜å¯ä»¥ï¼Œé‚£ä¹ˆçœŸå®äººç‰©å›¾è½¬æ¢ä¹‹åå‘¢ï¼Ÿ

æ¥ä¸‹æ¥æˆ‘ä»¬å€ŸåŠ©å¼€æºé¡¹ç›® https://github.com/liuyueyi/quick-media æ¥è¿…é€Ÿçš„å®ç°ä¸€ä¸ªgifå›¾è½¬æ¢

> ä¸‹å›¾æ¥è‡ªç½‘ç»œï¼Œæœ‰å…´è¶£çš„è‡ªå·±æ‰“å¼€æŸ¥çœ‹ï¼Œå°±ä¸è´´ä¸Šäº†ğŸ˜ï¼‰
http://n.sinaimg.cn/sinacn/w390h219/20171231/0ac1-fyqefvw5238474.gif


```java
@Test
public void testGif() throws Exception {
    String img = "http://n.sinaimg.cn/sinacn/w390h219/20171231/0ac1-fyqefvw5238474.gif";
    ImgPixelWrapper.build().setSourceImg(img)
            .setBlockSize(7)
            .setPixelType(PixelStyleEnum.CHAR_COLOR)
            // ç”Ÿæˆçš„gifå›¾æ”¾å¤§ä¸ºåŸæ¥çš„ä¸¤å€
            .setRate(2d)
            // æ”¯æŒè®¾ç½®å­—ä½“
            .setFontStyle(Font.BOLD)
            // è¿™é‡Œè®¾ç½®ç”Ÿæˆå­—ç¬¦å›¾ä¸­çš„å­—ç¬¦é›†
            .setChars("ç°")
            .build()
            .asFile(prefix + "/out3.gif");
    System.out.println("--------");
}
```

![](/imgs/211120/01.gif)


æœ€åæä¸ªå°é—®é¢˜ï¼Œgifå›¾éƒ½èƒ½ç”Ÿæˆå­—ç¬¦å›¾äº†ï¼Œé‚£ä¹ˆè§†é¢‘ä¹Ÿå¯ä»¥ç”Ÿæˆå­—ç¬¦è§†é¢‘ä¹ˆï¼Ÿ