---
order: 4
title: 4. åŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶ä¹‹ä»»åŠ¡åŠ¨æ€åŠ è½½
tag:
  - æŠ€æœ¯æ–¹æ¡ˆ
category:
  - Quickç³»åˆ—
  - QuickTask
date: 2018-07-29 17:06:59
keywords: Java,QuickTask,å¼€æºé¡¹ç›®,Groovy
---

# Quick-Task åŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶ä¹‹ä»»åŠ¡åŠ¨æ€åŠ è½½

å‰é¢å‡ ç¯‡åšæ–‡åˆ†åˆ«ä»‹ç»äº†æ•´ä¸ªé¡¹ç›®çš„åŸºæœ¬æ¶æ„ï¼Œä½¿ç”¨è¯´æ˜ï¼Œä»¥åŠæ•´ä½“æ¡†æ¶çš„è®¾è®¡ä¸å®ç°åˆç¨¿ï¼Œæ¥ä¸‹æ¥åˆ™è¿›å…¥æ›´ç»†èŠ‚çš„å®ç°ç¯‡ï¼Œå°†æ•´ä¸ªå·¥ç¨‹ä¸­æ ¸å¿ƒå®ç°æå‡ºæ¥ï¼Œä»ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡åˆ°æœ€ç»ˆçš„å®ç°ç»™äºˆè¯´æ˜

ç›¸å…³ç³»åˆ—åšæ–‡ï¼š

- [180702-QuickTaskåŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶æ•´ä½“ä»‹ç»ç¯‡](https://liuyueyi.github.io/hexblog/2018/07/02/180702-QuickTask%E5%8A%A8%E6%80%81%E8%84%9A%E6%9C%AC%E6%94%AF%E6%8C%81%E6%A1%86%E6%9E%B6%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D%E7%AF%87/)
- [180719-Quick-Task åŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶ä¹‹ä½¿ç”¨ä»‹ç»ç¯‡](https://liuyueyi.github.io/hexblog/2018/07/19/180719-Quick-Task-%E5%8A%A8%E6%80%81%E8%84%9A%E6%9C%AC%E6%94%AF%E6%8C%81%E6%A1%86%E6%9E%B6%E4%B9%8B%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%E7%AF%87/)
- [180723-Quick-Task åŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶ä¹‹ç»“æ„è®¾è®¡ç¯‡](https://liuyueyi.github.io/hexblog/2018/07/23/180723-Quick-Task-%E5%8A%A8%E6%80%81%E8%84%9A%E6%9C%AC%E6%94%AF%E6%8C%81%E6%A1%86%E6%9E%B6%E4%B9%8B%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E7%AF%87/)

<!-- more -->

## I. ä»»åŠ¡åŠ¨æ€åŠ è½½

è¿™ä¸ªåŠ¨æ€è„šæœ¬è°ƒåº¦æ¡†æ¶ï¼Œæœ€å¤§çš„ä¸€ä¸ªåŠŸèƒ½ç‚¹å°±æ˜¯æ”¯æŒçƒ­åŠ è½½äº†ï¼Œä½•ä¸ºçƒ­åŠ è½½ï¼Ÿ

ç®€å•æ¥è¯´å°±æ˜¯åœ¨ç¨‹åºä¸å®•æœºçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å¾€é‡Œé¢æ·»åŠ æ–°çš„ä»»åŠ¡ï¼Œåˆ é™¤æ—§çš„ä»»åŠ¡ï¼Œæ›´æ–°å·²æœ‰çš„ä»»åŠ¡ç­‰ç­‰ï¼Œå°±å¥½æ¯”é£æœºåœ¨å¤©ä¸Šé£çš„æ—¶å€™ç»™å®ƒåŠ æ²¹ï¼Œå°±è¿™ä¹ˆé«˜ç«¯çš„æ“ä½œï¼ˆğŸ˜Šï¼‰

ä¸ºäº†æ”¯æŒçƒ­åŠ è½½ï¼Œé¦–å…ˆé¢ä¸´çš„é—®é¢˜å°±æ˜¯å¦‚ä½•åˆ¤æ–­æœ‰ä»»åŠ¡çš„æ–°å¢/åˆ é™¤/ä¿®æ”¹ï¼Ÿ

### 1. ä»»åŠ¡ç›‘å¬çš„ä»0åˆ°1

è¦å®ç°ä»»åŠ¡å˜æ›´çš„ç›‘å¬ï¼Œè‡ªç„¶è€Œç„¶æƒ³åˆ°çš„ä¸€ä¸ªæ–¹æ¡ˆå°±æ˜¯èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸æ–­çš„è½®è¯¢ï¼ŒåŸºæœ¬çš„é€»è¾‘æ— éæ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ä»»åŠ¡çš„å˜æ›´å‘ç”Ÿè€Œå·²ï¼Œä¹Ÿå› æ­¤å…³æ³¨ç‚¹å°±è½åœ¨äº†å¦‚ä½•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æœ‰å˜æ›´äº†

æœ€ç®€å•ç²—æš´ç›´è§‚çš„æ–¹æ³•ï¼Œå°±æ˜¯è®°å½•ä¹‹å‰çš„æ‰€æœ‰çš„ä»»åŠ¡ï¼Œç„¶åæ¯æ¬¡è½®è¯¢æ—¶åˆ¤æ–­å½“å‰çš„æ‰€æœ‰ä»»åŠ¡ä¸ä¹‹å‰çš„æ‰€æœ‰ä»»åŠ¡æ˜¯å¦æœ‰åŒºåˆ«

å†è½åˆ°å…·ä½“çš„å®ç°ä¸Šï¼Œåˆ™ä¸ä»»åŠ¡çš„å…·ä½“å­˜å‚¨æœ‰å…³ç³»äº†ã€‚å¾ˆå®¹æ˜“æƒ³åˆ°äº†å‡ ç§ä»»åŠ¡å­˜å‚¨æ–¹å¼æœ‰

- æ–‡ä»¶
- æ•°æ®åº“ ï¼ˆå¦‚mysqlï¼‰
- ç¼“å­˜ ï¼ˆå¦‚redis)

#### a. æ•°æ®åº“å­˜å‚¨æ–¹å¼

è¿™ç§æ–¹æ³•æ¯”è¾ƒå¥½æƒ³åˆ°ï¼ŒåŒæ—¶ä¹Ÿå¥½å®ç°ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ç›´æ¥å­˜åœ¨DBçš„æŸå¼ è¡¨ä¸­ï¼›åªéœ€è¦ä¿è¯è¡¨ä¸­åŒ…å«ä»¥ä¸‹å‡ ä¸ªå­—æ®µå³å¯

- task: å…·ä½“çš„ä»»åŠ¡è„šæœ¬é€»è¾‘
- state: ä»»åŠ¡çš„çŠ¶æ€ï¼ˆè¡¨ç¤ºè¿è¡Œï¼Œæš‚åœç­‰ï¼‰
- update: ä»»åŠ¡çš„æ›´æ–°æ—¶é—´

åŸºäºä¸Šé¢çš„ä¸‰ä¸ªå±æ€§ï¼Œåˆ¤æ–­çš„é€»è¾‘å°±æ¸…æ™°äº†

- èµ·ä¸€ä¸ªcheckçº¿ç¨‹ï¼Œä¸æ–­çš„æ‰«è¡¨ï¼Œè·å–æ‰€æœ‰çš„ä»»åŠ¡
- å°†å½“å‰è·å–çš„ä»»åŠ¡ä¸ä¸Šä¸€æ¬¡è·å–çš„ä»»åŠ¡è¿›è¡Œå¯¹æ¯”
- æ ¹æ®æ¯”å¯¹çš„ç»“æœï¼Œå°è£…ä»»åŠ¡æ›´æ–°äº‹ä»¶ï¼ŒæŠ›ç»™ä¸‹æ¸¸å¤„ç†

å½“ç„¶åœ¨dbçš„åœºæ™¯ä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹å¼ï¼Œå€ŸåŠ©mysqlçš„dbeventäº‹ä»¶æ¥å¤„ç†ä»»åŠ¡çš„å˜æ›´

- é¦–å…ˆå¼€å¯mysqlçš„dbeventäº‹ä»¶ï¼Œå³dbä¸­è®°å½•çš„æ–°å¢åˆ é™¤å˜æ›´éƒ½ä¼šæŠ›å‡ºä¸€ä¸ªæ¶ˆæ¯
- ç›‘å¬dbeventï¼Œä»¥æ­¤å°è£…ä»»åŠ¡çš„æ›´æ–°äº‹ä»¶ï¼Œä¸¢ç»™ä¸‹ä¸€å±‚è¿›è¡Œå¤„ç†å³å¯

**è¯´æ˜ï¼š**

ä»ä¸ªäººçš„è§’åº¦å‡ºå‘ï¼Œåœ¨å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒåŸºäºDBçš„å­˜å‚¨æ–¹æ¡ˆæ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œç„¶è€Œæˆ‘å¹¶æ²¡æœ‰å»åšè¿™ä¸€ä¸ªï¼Œå› ä¸ºç›¸æ¯”äºæ–‡ä»¶çš„æ–¹å¼ï¼Œæœ‰ç‚¹é‡é‡çº§äº†ï¼› è€Œæˆ‘è‡ªå·±çš„å®é™…é¡¹ç›®ä¸­ï¼Œæ–‡ä»¶æ–¹å¼å·²ç»è¶³å¤Ÿè§£å†³æˆ‘çš„éœ€æ±‚äº†

#### b. æ–‡ä»¶å­˜å‚¨æ–¹å¼

è¿™ä¸ªå¯ä»¥è¯´æ˜¯æœ€å…ˆæƒ³åˆ°ï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“å®ç°çš„ä¸€ç§æ–¹å¼äº†ã€‚æˆ‘çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ”¾åœ¨æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œç„¶åç›‘å¬è¿™ä¸ªç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„å˜åŠ¨å³å¯

QuickTaské¡¹ç›®ä¸­ï¼Œé»˜è®¤çš„å®ç°æ–¹å¼ï¼Œå°±æ˜¯åŸºäºæ–‡ä»¶å­˜å‚¨çš„åŠ¨æ€ä»»åŠ¡ç›‘å¬ï¼Œå¥½å¤„æ˜¯ç®€å•ï¼Œå®ç°ç®€å•ï¼Œç†è§£ç®€å•ï¼Œç”¨èµ·æ¥ä¹Ÿç®€å•

#### c. ç¼“å­˜å­˜å‚¨æ–¹å¼

æ— éæ˜¯æ‹¿ç¼“å­˜åšdbå­˜å‚¨çš„æ€è·¯ï¼Œä¹Ÿæ²¡æœ‰å•¥å…¶ä»–çš„è®²ç©¶ï¼Œå½“ç„¶æˆ‘å¹¶æ²¡æœ‰æƒ³è¿‡çœŸçš„å»æ‹¿ç¼“å­˜æ¥å®ç°ï¼Œæ„Ÿè§‰è¿™ç§å®ç°æ–¹å¼æœ‰ç‚¹éä¸»æµï¼Œå½“ç„¶ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ˜æ˜¾çš„ä¼˜åŠ¿

### 2. ä»»åŠ¡ç›‘å¬çš„å®ç°

ä¸Šé¢æ˜¯åŸºæœ¬ä¸ŠæŠŠæˆ‘å¦‚ä½•å®ç°åŠ¨æ€ä»»åŠ¡ç›‘å¬çš„æƒ³æ³•éƒ½å†™å‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å…·ä½“çš„å®ç°äº†ï¼Œé‡‡ç”¨æœ¬åœ°æ–‡ä»¶æ¥å­˜å‚¨å…·ä½“çš„ä»»åŠ¡è„šæœ¬ï¼Œé‚£ä¹ˆä»»åŠ¡å˜åŒ–ç›‘å¬ï¼Œå°±è½¬æ¢ä¸ºäº†ç›®å½•ä¸‹æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬äº†

åˆ°äº†è¿™ä¸€æ­¥ï¼Œå…·ä½“çš„å®ç°æ–¹æ¡ˆå°±å‡ºæ¥äº†ï¼Œè¦å®ç°æ–‡ä»¶å˜åŠ¨ç›‘å¬ï¼Œjdk7å°±æä¾›äº†`WatchService`ï¼Œå½“ç„¶è¿˜æœ‰å¤§åé¼é¼çš„ `commons-io`ï¼Œä¸¤ä¸ªéƒ½å¯ä»¥å®ç°ï¼Œä¸‹é¢è´´å‡ºcommons-ioçš„å®ç°æ–¹å¼

```java
@Slf4j
public class TaskChangeWatcher {
    private static final String SCRIPT_TYPE = ".groovy";

    public static boolean registerWatcher(File file) {
        try {
            long period = TimeUnit.SECONDS.toMillis(1);

            // ä½¿ç”¨commons-ioçš„æ–‡ä»¶è§‚å¯Ÿå™¨ï¼Œå®ç°æ–‡ä»¶åŠ¨æ€å˜åŠ¨çš„ç›‘å¬
            FileAlterationObserver observer =
                    new FileAlterationObserver(file, FileFilterUtils.and(FileFilterUtils.fileFileFilter()));

            observer.addListener(new TaskChangeListener());
            FileAlterationMonitor monitor = new FileAlterationMonitor(period, observer);
            monitor.start();

            return true;
        } catch (Exception e) {
            log.error("register watcher for script task change error! file: {} e:{}", file.getAbsolutePath(), e);
            return false;
        }
    }

    static final class TaskChangeListener extends FileAlterationListenerAdaptor {
        private boolean ignore(File file) {
            return !file.getName().endsWith(SCRIPT_TYPE);
        }

        private void addTask(File file) {
            ITask script = ScriptLoadUtil.loadScript(file);
            if (script == null) {
                return;
            }

            // æ›´æ–°contextä¸­ç¼“å­˜ï¼Œå¹¶å¯åŠ¨ä»»åŠ¡
            ScriptTaskDecorate task = new ScriptTaskDecorate(script);
            TaskContainer.registerTask(file.getAbsolutePath(), task);
        }

        @Override
        public void onFileCreate(File file) {
            if (ignore(file)) {
                return;
            }
            addTask(file);
            // åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œtask
            log.info("add task : {}", file.getAbsolutePath());
        }

        @Override
        public void onFileChange(File file) {
            if (ignore(file)) {
                return;
            }
            addTask(file);
            // åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œtask
            log.info("task changed : {}", file.getName());
        }

        @Override
        public void onFileDelete(File file) {
            if (ignore(file)) {
                return;
            }

            // æ–‡ä»¶åˆ é™¤ï¼Œè¡¨ç¤ºéœ€è¦å¸è½½æ—§çš„task
            TaskContainer.removeTask(file.getAbsolutePath());
            log.info("task delete: {}", file.getName());
        }
    }
}
```

ä¸Šé¢çš„å®ç°ï¼Œæ ¸å¿ƒå°±æ˜¯æ³¨å†Œç›®å½•å˜åŠ¨çš„ç›‘å¬ï¼Œå½“å‡ºç°æ–‡ä»¶çš„å˜åŒ–æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºgroovyè„šæœ¬ï¼Œç„¶ååŠ è½½ä»»åŠ¡ï¼Œå¹¶ä¸¢ç»™ä»»åŠ¡å®¹å™¨è¿›è¡Œè°ƒåº¦æ‰§è¡Œ

å¯¹äºæ–‡ä»¶å˜åŠ¨çš„ç›‘å¬çš„å…·ä½“æ–¹æ¡ˆå’Œè®²è§£ï¼Œå¦‚æœ‰ç–‘é—®å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€ç¯‡åšæ–‡:

- [Javaå¯ä»¥å¦‚ä½•å®ç°æ–‡ä»¶å˜åŠ¨çš„ç›‘å¬](https://liuyueyi.github.io/hexblog/2018/02/08/Java%E5%8F%AF%E4%BB%A5%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%8F%98%E5%8A%A8%E7%9A%84%E7%9B%91%E5%90%AC/)



## II. å…¶ä»–

### 0. ç›¸å…³

**åšæ–‡ï¼š**

- [180628-åŠ¨æ€ä»»åŠ¡æ‰§è¡Œæ¡†æ¶æƒ³æ³•ç¯‡](https://liuyueyi.github.io/hexblog/2018/06/28/180628-%E5%8A%A8%E6%80%81%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%A1%86%E6%9E%B6%E6%83%B3%E6%B3%95%E7%AF%87/)
- [180702-QuickTaskåŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶æ•´ä½“ä»‹ç»ç¯‡](https://blog.hhui.top/hexblog/2018/07/02/180702-QuickTask%E5%8A%A8%E6%80%81%E8%84%9A%E6%9C%AC%E6%94%AF%E6%8C%81%E6%A1%86%E6%9E%B6%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D%E7%AF%87/)
- [180723-Quick-Task åŠ¨æ€è„šæœ¬æ”¯æŒæ¡†æ¶ä¹‹ç»“æ„è®¾è®¡ç¯‡](https://liuyueyi.github.io/hexblog/2018/07/23/180723-Quick-Task-%E5%8A%A8%E6%80%81%E8%84%9A%E6%9C%AC%E6%94%AF%E6%8C%81%E6%A1%86%E6%9E%B6%E4%B9%8B%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1%E7%AF%87/)

**é¡¹ç›®ï¼š**

- [https://github.com/liuyueyi/quick-task](https://github.com/liuyueyi/quick-task)

### 1. [ä¸€ç°ç°Blog](https://liuyueyi.github.io/hexblog)ï¼š https://liuyueyi.github.io/hexblog

ä¸€ç°ç°çš„ä¸ªäººåšå®¢ï¼Œè®°å½•æ‰€æœ‰å­¦ä¹ å’Œå·¥ä½œä¸­çš„åšæ–‡ï¼Œæ¬¢è¿å¤§å®¶å‰å»é€›é€›


### 2. å£°æ˜

å°½ä¿¡ä¹¦åˆ™ä¸å¦‚ï¼Œå·²ä¸Šå†…å®¹ï¼Œçº¯å±ä¸€å®¶ä¹‹è¨€ï¼Œå› ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œéš¾å…æœ‰ç–æ¼å’Œé”™è¯¯ä¹‹å¤„ï¼Œå¦‚å‘ç°bugæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œä¸åæ„Ÿæ¿€

- å¾®åšåœ°å€: [å°ç°ç°Blog](https://weibo.com/p/1005052169825577/home)
- QQï¼š ä¸€ç°ç°/3302797840

### 3. æ‰«æå…³æ³¨

**ä¸€ç°ç°blog**

![QrCode](https://raw.githubusercontent.com/liuyueyi/Source/master/img/info/blogInfoV2.png)

**çŸ¥è¯†æ˜Ÿçƒ**

![goals](https://raw.githubusercontent.com/liuyueyi/Source/master/img/info/goals.png)

