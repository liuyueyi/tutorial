import{_ as c,V as l,W as i,Z as n,a1 as s,$ as a,a0 as u,Y as o,F as p}from"./framework-b1bd8911.js";const k="/tutorial/imgs/column/springai/05-1.webp",r="/tutorial/imgs/column/springai/05-2.webp",d={},m=o('<h1 id="_05-è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥" tabindex="-1"><a class="header-anchor" href="#_05-è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥" aria-hidden="true">#</a> 05.è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥</h1><p>SpringAIå·²ç»é›†æˆäº†å¾ˆå¤šä¸»æµå¤§æ¨¡å‹çš„äº¤äº’ï¼Œå°è£…æˆstarterä¾›æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ï¼›æ¯”å¦‚å‰é¢å‡ ç¯‡çš„demoä½¿ç”¨çš„æ™ºæ™®å¤§æ¨¡å‹ï¼Œå°±æ˜¯ç›´æ¥åˆ©ç”¨<code>spring-ai-starter-model-zhipuai</code>æ¥è¿›è¡Œå¤§æ¨¡å‹çš„äº¤äº’</p><p>ä½†æ€»æœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚æ˜Ÿç«çš„å…è´¹æ¨¡å‹Spark Lite(éå…è´¹çš„ä¹Ÿæ²¡æœ‰ğŸ˜‚)ï¼Œåœ¨å®˜æ–¹çš„æ•™ç¨‹ä¸­æˆ‘ä»¬å°±æ²¡æœ‰æ‰¾åˆ°å¯ä»¥ç›´æ¥ä½¿ç”¨çš„starter</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼ŒåŸºäºSpringAIï¼Œå¦‚æœæˆ‘ä»¬è¦æ¥å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„å¤§æ¨¡å‹ï¼Œå¯ä»¥æ€ä¹ˆå¤„ç†</p><h2 id="ä¸€ã€å¤§æ¨¡å‹æ¥å…¥ç”³è¯·" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å¤§æ¨¡å‹æ¥å…¥ç”³è¯·" aria-hidden="true">#</a> ä¸€ã€å¤§æ¨¡å‹æ¥å…¥ç”³è¯·</h2><p>é¦–å…ˆæ˜¯å‡†å¤‡å¥½å¤§æ¨¡å‹éœ€è¦çš„ä¿¡æ¯(æ ¸å¿ƒå°±æ˜¯apiKey)</p><h3 id="_1-æ˜Ÿç«apikeyç”³è¯·" tabindex="-1"><a class="header-anchor" href="#_1-æ˜Ÿç«apikeyç”³è¯·" aria-hidden="true">#</a> 1. æ˜Ÿç«ApiKeyç”³è¯·</h3><p>æ³¨å†Œã€ç™»å½•è´¦å·ç›¸å…³æµç¨‹çœç•¥ï¼Œè¯·ç›´æ¥åœ¨å®˜ç½‘è‡ªåŠ©å®Œæˆ</p>',8),v={href:"https://console.xfyun.cn/services/cbm",target:"_blank",rel:"noopener noreferrer"},b=n("figure",null,[n("img",{src:k,alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),g=n("p",null,[s("é€‰æ‹© Spark Lite æ¨¡å‹ï¼Œä¸Šå›¾ä¸­å› ä¸ºæˆ‘å·²ç»å¼€é€šäº†ï¼›å¯¹äºæ²¡æœ‰å¼€é€šçš„åœºæ™¯ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šå›¾ä¸­ "),n("code",null,"é¢†å–æ— é™é‡"),s(" è¿™ä¸ªæŒ‰é’®æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œç‚¹å‡»ä¹‹åå¯¹äºå·²è®¤è¯è´¦å·å³å¯è·å–äº†ï¼ˆæœªè®¤è¯çš„ï¼Œç›´æ¥è·³è½¬åˆ°è®¤è´¦è´¦å·è¿›è¡Œè®¤è¯ï¼Œæ”¯æŒä¸ªäºº/ä¼ä¸šè®¤è¯ï¼‰")],-1),h=n("p",null,"é¢†å–ä¹‹åï¼Œåœ¨å³è¾¹çš„ç¼±ç»»ä¿¡æ¯ä¸­ï¼Œå°† ApiPassword å¤åˆ¶å‡ºæ¥å¾…ç”¨",-1),f=n("h3",{id:"_2-é˜…è¯»å®˜æ–¹æ¥å£æ–‡æ¡£",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-é˜…è¯»å®˜æ–¹æ¥å£æ–‡æ¡£","aria-hidden":"true"},"#"),s(" 2. é˜…è¯»å®˜æ–¹æ¥å£æ–‡æ¡£")],-1),y=n("p",null,"ç”±äºå¹¶ä¸æ˜¯æ‰€æœ‰çš„å¤§æ¨¡å‹çš„è§„èŒƒéƒ½ä¸€æ ·ï¼Œæ— æ³•ç¡®ä¿å®ƒä»¬éƒ½èƒ½ç›´æ¥é€‚é…SpringAIçš„ä¼ å…¥/ä¼ å‡ºï¼Œå› æ­¤åœ¨åç»­çš„æ¥å…¥éœ€è¦é‡ç‚¹é˜…è¯»å®˜æ–¹æ¥å£æ–‡æ¡£ï¼Œå¯¹å¤§æ¨¡å‹çš„äº¤äº’è¿›è¡Œé€‚é…",-1),w={href:"https://www.xfyun.cn/doc/spark/HTTP%E8%B0%83%E7%94%A8%E6%96%87%E6%A1%A3.html",target:"_blank",rel:"noopener noreferrer"},q=n("h2",{id:"äºŒã€é¡¹ç›®åˆ›å»º",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#äºŒã€é¡¹ç›®åˆ›å»º","aria-hidden":"true"},"#"),s(" äºŒã€é¡¹ç›®åˆ›å»º")],-1),C=o(`<h3 id="_1-ä¾èµ–é…ç½®" tabindex="-1"><a class="header-anchor" href="#_1-ä¾èµ–é…ç½®" aria-hidden="true">#</a> 1. ä¾èµ–é…ç½®</h3><p>ç”±äºæˆ‘ä»¬ä¸ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„starter, å› æ­¤éœ€è¦ä¸»åŠ¨ä¾èµ–SpringAIçš„ä¸€äº›æ ¸å¿ƒåŒ…</p><p>åœ¨pomé…ç½®æ–‡ä»¶ä¸­æ·»åŠ </p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-ai-model<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-ai-client-chat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-é…ç½®å‚æ•°" tabindex="-1"><a class="header-anchor" href="#_2-é…ç½®å‚æ•°" aria-hidden="true">#</a> 2. é…ç½®å‚æ•°</h3><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤§æ¨¡å‹çš„ä¸€äº›å‚æ•°ï¼Œç»Ÿä¸€ç»´æŠ¤åœ¨<code>application.yml</code>é…ç½®æ–‡ä»¶ä¸­ï¼Œå…³é”®çš„ä¿¡æ¯ä¸º <code>api-key</code></p><p>å…³äºé…ç½®çš„ç»´æŠ¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å‚è€ƒå®˜æ–¹æä¾›çš„starterçš„å®ç°ï¼ˆæ¯”å¦‚æ™ºæ™®çš„starterï¼‰</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">ai</span><span class="token punctuation">:</span>
    <span class="token key atrule">spark</span><span class="token punctuation">:</span>
      <span class="token key atrule">api-key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>api<span class="token punctuation">-</span>key<span class="token punctuation">}</span>
      <span class="token key atrule">base-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//spark<span class="token punctuation">-</span>api<span class="token punctuation">-</span>open.xf<span class="token punctuation">-</span>yun.com/v1/chat/completions
      <span class="token key atrule">chat</span><span class="token punctuation">:</span>
        <span class="token key atrule">options</span><span class="token punctuation">:</span>
          <span class="token key atrule">model</span><span class="token punctuation">:</span> lite
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šæœ¬æ–‡ä»¥å®ç°ä¸€ä¸ªæœ€åŸºç¡€çš„å¤§æ¨¡å‹äº¤äº’ä¸ºä¾‹ï¼Œå› æ­¤æ›´å¤šçš„å‚æ•°ç›¸å…³ç»„ç»‡é…ç½®ï¼Œå°†ç•™å¾…åç»­çš„æ–‡ç« è¿›è¡Œæ‰©å……å®ç°ï¼›è¿™é‡Œåªä»‹ç»æœ€æ ¸å¿ƒçš„å‚æ•°</p><h3 id="_3-å®ç°å¤§æ¨¡å‹æ¥å£" tabindex="-1"><a class="header-anchor" href="#_3-å®ç°å¤§æ¨¡å‹æ¥å£" aria-hidden="true">#</a> 3. å®ç°å¤§æ¨¡å‹æ¥å£</h3><p>å¯¹äºè‡ªå®šä¹‰çš„å¤§æ¨¡å‹çš„æ¥å£å®ç°ï¼Œæœ€æœ€æ ¸å¿ƒçš„ï¼Œå°±æ˜¯å®ç°<code>ChatModel</code>æ¥å£ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰äº†æ¨¡å‹äº¤äº’çš„å‚æ•°ï¼Œä»¥åŠæ¨¡å‹äº¤äº’çš„è¿”å›ç»“æœ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SparkLiteModel</span> <span class="token keyword">implements</span> <span class="token class-name">ChatModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SparkLiteModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">URL</span> <span class="token operator">=</span> <span class="token string">&quot;https://spark-api-open.xf-yun.com/v1/chat/completions&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RestClient</span> restClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.ai.spark.api-key:}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> apiKey<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.ai.spark.chat.options.model:lite}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> model<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">&gt;</span></span> authHeaders <span class="token operator">=</span> <span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            h<span class="token punctuation">.</span><span class="token function">setBearerAuth</span><span class="token punctuation">(</span>apiKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            h<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defaultHeaders</span><span class="token punctuation">(</span>authHeaders<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * é…ç½®é»˜è®¤çš„æŸ¥è¯¢æ¡ä»¶
     *
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatOptions</span> <span class="token function">getDefaultOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ChatOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è¿™é‡Œå®ç°äº†ä¸€ä¸ªåŸºæœ¬çš„æ¨¡å‹è°ƒç”¨é€»è¾‘
     *  todo: function toolçš„èƒ½åŠ›æ”¯æŒ
     *  todo: å¤šè½®å¯¹è¯ï¼Œä¸Šä¸‹æ–‡çš„æ”¯æŒ
     *
     * <span class="token keyword">@param</span> <span class="token parameter">prompt</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatResponse</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Prompt</span> prompt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> reqTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> model <span class="token operator">=</span> <span class="token punctuation">(</span>prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">:</span> prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> res <span class="token operator">=</span> restClient<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">POJOConvert</span><span class="token punctuation">.</span><span class="token function">toReq</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SparkPOJO<span class="token punctuation">.</span>ChatCompletionChunk</span> chatCompletionChunk <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">fromStr</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token class-name">SparkPOJO<span class="token punctuation">.</span>ChatCompletionChunk</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Generation</span><span class="token punctuation">&gt;</span></span> generations <span class="token operator">=</span> <span class="token class-name">POJOConvert</span><span class="token punctuation">.</span><span class="token function">generationList</span><span class="token punctuation">(</span>chatCompletionChunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChatResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatResponse</span><span class="token punctuation">(</span>generations<span class="token punctuation">,</span> <span class="token class-name">POJOConvert</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>reqTime<span class="token punctuation">,</span> model<span class="token punctuation">,</span> chatCompletionChunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºè¿™ä¸ª<code>ChatModel</code>çš„å®ç°ï¼Œå…³é”®åœ¨äº <code>public ChatResponse call(Prompt prompt)</code> è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œå…¶ä»–çš„éƒ½éå¿…é¡»</p><p>å¯¹äº<code>call(Prompt prompt)</code>æ–¹æ³•ï¼Œå†…éƒ¨éœ€è¦å®ç°çš„å°±æ˜¯å’Œå¤§æ¨¡å‹çš„äº¤äº’ï¼Œä»¥åŒæ­¥çš„httpåè®®çš„æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦å¹²çš„äº‹æƒ…ï¼Œå°±ä¸‰ä¸ª</p><ul><li>å°† <code>prompt</code> è½¬æ¢ä¸ºå¤§æ¨¡å‹çš„ä¼ å…¥å‚æ•°</li><li>å‘èµ·<code>http</code>è¯·æ±‚</li><li>å°†å¤§æ¨¡å‹çš„è¿”å›å¯¹è±¡å°è£…ä¸º <code>ChatResponse</code> å¯¹è±¡</li></ul><p>åœ¨ä¸Šé¢çš„å…·ä½“å®ç°ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨Springçš„<code>restClient</code>ä½œä¸ºhttpäº¤äº’çš„å·¥å…·(å¯¹äºéœ€è¦æµå¼å¼‚æ­¥äº¤äº’çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘WebClient)ï¼Œéº»çƒ¦çš„ç‚¹(æˆ–è€…è¯´è„æ´»ç´¯æ´»)å°±æ˜¯è¯·æ±‚è¿”å›çš„è§£ææ˜ å°„</p><p>å¯¹äºæ­¤ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code>SparkPOJO</code>æ¥ä¿å­˜è®¯é£å¤§æ¨¡å‹çš„è¿”å›ç»“æœï¼›</p><p>å¦‚ä¸‹é¢è¿™ä¸ªjsonä¸ºå¤§æ¨¡å‹çš„çœŸå®è¿”å›ç»“æœ</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Success&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cha000b180a@dx1982ba483e7b8f2532&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;choices&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;assistant&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;æˆ‘ä¹ƒæç™½ï¼Œå­—å¤ªç™½ï¼Œå·é’è²å±…å£«ã€‚ç”Ÿäºå”æœï¼Œè‡ªå¹¼å¥½å­¦ï¼Œæ‰æƒ…å‡ºä¼—ã€‚è¯—ä»™ä¹‹åï¼Œéæˆ‘è«å±ã€‚æˆ‘æ¸¸å†å››æ–¹ï¼Œé¥®é…’ä½œè¯—ï¼Œä»¥æŠ’èƒ¸ä¸­è±ªæƒ…å£®å¿—ã€‚æˆ‘è¡ŒåŸäºå±±æ°´ä¹‹é—´ï¼ŒæŒ¥æ´’è‡ªå¦‚ï¼Œè¯—ç¯‡æµä¼ åƒå¤ï¼Œè¢«åäººä¼ é¢‚ã€‚&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;usage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;prompt_tokens&quot;</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token property">&quot;completion_tokens&quot;</span><span class="token operator">:</span> <span class="token number">72</span><span class="token punctuation">,</span>
        <span class="token property">&quot;total_tokens&quot;</span><span class="token operator">:</span> <span class="token number">88</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºäºä¸Šé¢çš„jsonï¼Œæˆ‘ä»¬ä½ å®šä¹‰çš„POJOï¼Œå¯ä»¥åˆ†ä¸º</p><ul><li><code>ChatCompletionChunk</code>å¯¹åº”å®Œæ•´çš„è¿”å›</li><li><code>Choice</code> å¯¹åº”å¤§æ¨¡å‹è¿”å›ç»“æœä¸­çš„<code>choices</code>æ•°ç»„ï¼Œ<code>SparkMsg</code>å¯¹åº”choicesæ•°ç»„ä¸­çš„messageå…ƒç´ ï¼›</li><li><code>Usage</code> å¯¹åº”å¤§æ¨¡å‹è¿”å›ç»“æœä¸­çš„<code>usage</code>å…ƒç´ </li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SparkPOJO</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span><span class="token constant">NON_NULL</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>ignoreUnknown <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">ChatCompletionChunk</span><span class="token punctuation">(</span>
            <span class="token comment">// é”™è¯¯ç  0 æˆåŠŸ</span>
            <span class="token class-name">Integer</span> code<span class="token punctuation">,</span>
            <span class="token comment">// é”™è¯¯ç çš„æè¿°ä¿¡æ¯</span>
            <span class="token class-name">String</span> message<span class="token punctuation">,</span>
            <span class="token comment">// æœ¬æ¬¡è¯·æ±‚çš„å”¯ä¸€id</span>
            <span class="token class-name">String</span> sid<span class="token punctuation">,</span>
            <span class="token comment">// å¤§æ¨¡å‹è¿”å›ç»“æœ</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Choice</span><span class="token punctuation">&gt;</span></span> choices<span class="token punctuation">,</span>
            <span class="token comment">// æœ¬æ¬¡è¯·æ±‚çš„æ¶ˆè€—ä¿¡æ¯</span>
            <span class="token class-name">Usage</span> usage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">Choice</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> index<span class="token punctuation">,</span> <span class="token class-name">SparkMsg</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">SparkMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span><span class="token constant">NON_NULL</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>
            ignoreUnknown <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">Usage</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> completionTokens<span class="token punctuation">,</span> <span class="token class-name">Integer</span> promptTokens<span class="token punctuation">,</span>
                        <span class="token class-name">Integer</span> totalTokens<span class="token punctuation">)</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ai<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span></span>Usage</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">Usage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;completion_tokens&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> completionTokens<span class="token punctuation">,</span> <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;prompt_tokens&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> promptTokens<span class="token punctuation">,</span> <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;total_tokens&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> totalTokens<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>completionTokens <span class="token operator">=</span> completionTokens<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>promptTokens <span class="token operator">=</span> promptTokens<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>totalTokens <span class="token operator">=</span> totalTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;completion_tokens&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">completionTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>completionTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;prompt_tokens&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">promptTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>promptTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;total_tokens&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">totalTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getPromptTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> promptTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCompletionTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> completionTokens<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getNativeUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> usage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            usage<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;promptTokens&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">promptTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            usage<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;completionTokens&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">completionTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            usage<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalTokens&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">totalTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> usage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®šä¹‰ <code>POJOConvert</code> æ¥å®ç°è¯·æ±‚è¿”å›çš„å¯¹è±¡è½¬æ¢ä¸º <code>ChatResponse</code></p><ul><li><code>List&lt;Generation&gt;</code> ç”Ÿæˆçš„ç»“æœ <ul><li>ChatGenerationMetadataï¼š è¿”å›çš„å…ƒæ•°æ®</li><li>AssistantMessageï¼šåŒ…å«å…·ä½“è¿”å›çš„æ–‡æœ¬</li></ul></li><li><code>ChatResponseMetadata</code>: è¿”å›çš„å…ƒæ•°æ®</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">POJOConvert</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Generation</span><span class="token punctuation">&gt;</span></span> <span class="token function">generationList</span><span class="token punctuation">(</span><span class="token class-name">SparkPOJO<span class="token punctuation">.</span>ChatCompletionChunk</span> completionChunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> completionChunk<span class="token punctuation">.</span><span class="token function">choices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>choice <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> metadata <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> completionChunk<span class="token punctuation">.</span><span class="token function">sid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> choice<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">role</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> choice<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;finishReason&quot;</span><span class="token punctuation">,</span> completionChunk<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;over&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">buildGeneration</span><span class="token punctuation">(</span>choice<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Generation</span> <span class="token function">buildGeneration</span><span class="token punctuation">(</span><span class="token class-name">SparkPOJO<span class="token punctuation">.</span>Choice</span> choice<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AssistantMessage</span> assistantMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AssistantMessage</span><span class="token punctuation">(</span>choice<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChatGenerationMetadata</span> generationMetadata <span class="token operator">=</span> <span class="token class-name">ChatGenerationMetadata</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finishReason</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> metadata<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;finishReason&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Generation</span><span class="token punctuation">(</span>assistantMessage<span class="token punctuation">,</span> generationMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ChatResponseMetadata</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Long</span> reqTime<span class="token punctuation">,</span> <span class="token class-name">String</span> model<span class="token punctuation">,</span> <span class="token class-name">SparkPOJO<span class="token punctuation">.</span>ChatCompletionChunk</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&quot;SparkLite ChatCompletionResult must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ChatResponseMetadata</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">sid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> result<span class="token punctuation">.</span><span class="token function">sid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Usage</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> result<span class="token punctuation">.</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">EmptyUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyValue</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span> reqTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">toReq</span><span class="token punctuation">(</span><span class="token class-name">Prompt</span> prompt<span class="token punctuation">,</span> <span class="token class-name">String</span> defaultModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> defaultModel <span class="token operator">:</span> prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;stream&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChatOptions</span> options <span class="token operator">=</span> prompt<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å–å€¼èŒƒå›´[0, 2] é»˜è®¤å€¼1.0	æ ¸é‡‡æ ·é˜ˆå€¼</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;temperature&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å–å€¼èŒƒå›´(0, 1] é»˜è®¤å€¼1	ç”Ÿæˆè¿‡ç¨‹ä¸­æ ¸é‡‡æ ·æ–¹æ³•æ¦‚ç‡é˜ˆå€¼ï¼Œä¾‹å¦‚ï¼Œå–å€¼ä¸º0.8æ—¶ï¼Œä»…ä¿ç•™æ¦‚ç‡åŠ èµ·æ¥å¤§äºç­‰äº0.8çš„æœ€å¯èƒ½tokençš„æœ€å°é›†åˆä½œä¸ºå€™é€‰é›†ã€‚å–å€¼è¶Šå¤§ï¼Œç”Ÿæˆçš„éšæœºæ€§è¶Šé«˜ï¼›å–å€¼è¶Šä½ï¼Œç”Ÿæˆçš„ç¡®å®šæ€§è¶Šé«˜ã€‚</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;top_p&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">getTopP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å–å€¼èŒƒå›´[1, 6] é»˜è®¤å€¼4	ä»kä¸ªä¸­éšæœºé€‰æ‹©ä¸€ä¸ª(éç­‰æ¦‚</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;top_k&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">getTopK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 	å–å€¼èŒƒå›´[-2.0,2.0] é»˜è®¤0	é‡å¤è¯çš„æƒ©ç½šå€¼</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;presence_penalty&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">getPresencePenalty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å–å€¼èŒƒå›´[-2.0,2.0] é»˜è®¤0	é¢‘ç‡æƒ©ç½šå€¼</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;frequency_penalty&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">getFrequencyPenalty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æœ€å¤§é•¿åº¦</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;max_tokens&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">getMaxTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// todo ç­‰å¾…è¡¥é½çš„äº‹ function tool</span>
        <span class="token punctuation">}</span>


        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> msgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">:</span> prompt<span class="token punctuation">.</span><span class="token function">getInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span> msg <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> body<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-å¤§æ¨¡å‹ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_4-å¤§æ¨¡å‹ä½¿ç”¨ç¤ºä¾‹" aria-hidden="true">#</a> 4. å¤§æ¨¡å‹ä½¿ç”¨ç¤ºä¾‹</h3><p>ä¸Šé¢å®Œæˆäº†è‡ªå®šä¹‰å¤§æ¨¡å‹çš„äº¤äº’ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯•è¯•æ•ˆæœï¼›ä½¿ç”¨æ–¹æ³•åŸºæœ¬ä¸Šå’Œå‰é¢ä»‹ç»çš„æ²¡æœ‰ä»»ä½•åŒºåˆ«</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">ChatController</span><span class="token punctuation">(</span><span class="token class-name">ChatModel</span> chatModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> <span class="token class-name">ChatClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>chatModel<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultSystem</span><span class="token punctuation">(</span><span class="token string">&quot;ä½ ç°åœ¨æ˜¯ç‹‚æ”¾ä¸ç¾çš„è¯—ä»™æç™½ï¼Œæˆ‘ä»¬ç°åœ¨å¼€å§‹å¯¹è¯&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultAdvisors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleLoggerAdvisor</span><span class="token punctuation">(</span><span class="token class-name">ModelOptionsUtils</span><span class="token operator">::</span><span class="token function">toJsonStringPrettyPrinter</span><span class="token punctuation">,</span> <span class="token class-name">ModelOptionsUtils</span><span class="token operator">::</span><span class="token function">toJsonStringPrettyPrinter</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * åŸºäºChatClientå®ç°è¿”å›ç»“æœçš„ç»“æ„åŒ–æ˜ å°„
     *
     * <span class="token keyword">@param</span> <span class="token parameter">msg</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ai/generate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;ä½ å¥½&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> chatClient<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="ä¸‰ã€å°ç»“" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€å°ç»“" aria-hidden="true">#</a> ä¸‰ã€å°ç»“</h2><p>æœ¬æ–‡é€šè¿‡éå®˜æ–¹æä¾›çš„startï¼Œå®ç°äº†ä¸€ä¸ªè‡ªå®šä¹‰å¤§æ¨¡å‹çš„æ¥å…¥è¿‡ç¨‹ï¼Œå…¶æ ¸å¿ƒå…³é”®åœ¨äº <code>ChatModel</code> æ¥å£çš„å®ç°ï¼Œå°ç»“ä¸€ä¸‹è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥çš„å…³é”®ç‚¹</p><ul><li>ç»§æ‰¿ <code>ChatModel</code> æ¥å£ï¼Œå®ç° <code>ChatModel</code> æ¥å£çš„ <code>call</code> æ–¹æ³•ï¼Œè¿”å› <code>ChatResponse</code> å¯¹è±¡</li><li>å®ç°SpringAIå®šä¹‰çš„<code>Prompt</code>å¯¹è±¡è½¬å¤§æ¨¡å‹ä¼ å‚</li><li>å®ç°å¤§æ¨¡å‹çš„è¿”å›ç»“æœè½¬ <code>ChatResponse</code></li></ul><p>æœ¬æ–‡ä»…ä½œä¸ºå‚è€ƒï¼Œç›®å‰åªå®ç°äº†åŸºç¡€çš„å¤§æ¨¡å‹èŠå¤©é—®ç­”ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»‹ç»äº†SpringAIçš„æ›´å¤šé«˜çº§åŠŸèƒ½ï¼ˆæ¯”å¦‚Function toolå·¥å…·è°ƒç”¨, å¤šæ¨¡æ€, MCP, RAGç­‰ï¼‰ï¼›</p><p>åŒæ—¶ä¹Ÿä¼šåœ¨ä»‹ç»è¿™äº›é«˜çº§åŠŸèƒ½æ—¶ ï¼Œç»™å‡ºè‡ªå®šä¹‰çš„å¤§æ¨¡å‹æ¥å…¥çš„ç›¸å…³èƒ½åŠ›æ‰©å±•ï¼Œè¾…åŠ©åŠ æ·±ç†è§£ã€‚</p>',34),_={href:"https://github.com/liuyueyi/spring-ai-demo/tree/master/S05-self-model",target:"_blank",rel:"noopener noreferrer"};function S(O,M){const t=p("ExternalLinkIcon"),e=p("RouterLink");return l(),i("div",null,[m,n("p",null,[s("è¿›å…¥å¼€æ”¾å¹³å°: "),n("a",v,[s("https://console.xfyun.cn/services/cbm"),a(t)])]),b,g,h,f,y,n("p",null,[s("æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä»¥æ˜Ÿç«æ¨¡å‹ä¸ºä¾‹ï¼Œé˜…è¯»å®˜æ–¹æ¥å£æ–‡æ¡£ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Spark Liteæ¨¡å‹ï¼Œæ–‡æ¡£åœ°å€ä¸ºï¼š"),n("a",w,[s("https://www.xfyun.cn/doc/spark/HTTPè°ƒç”¨æ–‡æ¡£.html"),a(t)])]),q,n("p",null,[s("é¡¹ç›®åˆ›å»ºæ–¹å¼ä¸ä¹‹å‰å¹¶æ— å·®åˆ«ï¼Œåˆ›å»ºä¸€ä¸ªSpringBooté¡¹ç›®ï¼Œå¹¶å¼•å…¥SpringAIçš„ä¾èµ–ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å‚è€ƒ "),a(e,{to:"/spring/springai/%E5%9F%BA%E7%A1%80%E7%AF%87/01.%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASpringAI-Demo%E5%B7%A5%E7%A8%8B.html"},{default:u(()=>[s("åˆ›å»ºä¸€ä¸ªSpringAI-Demoå·¥ç¨‹")]),_:1})]),C,n("p",null,[s("æ–‡ä¸­æ‰€æœ‰æ¶‰åŠåˆ°çš„ä»£ç ï¼Œå¯ä»¥åˆ°é¡¹ç›®ä¸­è·å– "),n("a",_,[s("https://github.com/liuyueyi/spring-ai-demo"),a(t)])])])}const I=c(d,[["render",S],["__file","05.è‡ªå®šä¹‰å¤§æ¨¡å‹æ¥å…¥.html.vue"]]);export{I as default};
