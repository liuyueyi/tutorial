import{_ as e,V as p,W as t,X as a,Y as s,Z as l,a1 as o,a0 as r,F as i}from"./framework-23f3cf9b.js";const c={},d=a("h1",{id:"influxdb-备份与恢复",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#influxdb-备份与恢复","aria-hidden":"true"},"#"),s(" influxdb 备份与恢复")],-1),b={href:"https://docs.influxdata.com/influxdb/v1.6/administration/backup_and_restore",target:"_blank",rel:"noopener noreferrer"},u=a("p",null,"环境:",-1),m=a("ul",null,[a("li",null,"influxdb v1.6.0"),a("li",null,"使用influx自动的控制台进行")],-1),v=r(`<h2 id="i-备份" tabindex="-1"><a class="header-anchor" href="#i-备份" aria-hidden="true">#</a> I. 备份</h2><p>备份命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>influxd backup
    <span class="token punctuation">[</span> <span class="token parameter variable">-database</span> <span class="token operator">&lt;</span>db_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span>  --<span class="token operator">&gt;</span> 指定需要备份的数据库名
    <span class="token punctuation">[</span> <span class="token parameter variable">-portable</span> <span class="token punctuation">]</span>            --<span class="token operator">&gt;</span> 表示在线备份
    <span class="token punctuation">[</span> <span class="token parameter variable">-host</span> <span class="token operator">&lt;</span>host:port<span class="token operator">&gt;</span> <span class="token punctuation">]</span>    --<span class="token operator">&gt;</span> influxdb服务所在的机器，端口号默认为8088
    <span class="token punctuation">[</span> <span class="token parameter variable">-retention</span> <span class="token operator">&lt;</span>rp_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token punctuation">[</span> <span class="token parameter variable">-shard</span> <span class="token operator">&lt;</span>shard_ID<span class="token operator">&gt;</span> <span class="token parameter variable">-retention</span> <span class="token operator">&lt;</span>rp_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span>  --<span class="token operator">&gt;</span> 备份的保留策略，注意shard是挂在rp下的；我们需要备份的就是shard中的数据
    <span class="token punctuation">[</span> <span class="token parameter variable">-start</span> <span class="token operator">&lt;</span>timestamp<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token parameter variable">-end</span> <span class="token operator">&lt;</span>timestamp<span class="token operator">&gt;</span> <span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token parameter variable">-since</span> <span class="token operator">&lt;</span>timestamp<span class="token operator">&gt;</span> <span class="token punctuation">]</span>   --<span class="token operator">&gt;</span> 备份指定时间段的数据
    <span class="token operator">&lt;</span>path-to-backup<span class="token operator">&gt;</span>   --<span class="token operator">&gt;</span> 备份文件的输出地址
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-实例演示" tabindex="-1"><a class="header-anchor" href="#_1-实例演示" aria-hidden="true">#</a> 1. 实例演示</h3><p>首先创建一个数据库 yhhblog， 里面包含两个measurement，对应的数据如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> show databases
name: databases
name
----
_internal
yhhblog

<span class="token operator">&gt;</span> use yhhblog
Using database yhhblog
<span class="token operator">&gt;</span> show measurements
name: measurements
name
----
netLoad
serviceLoad

<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from netLoad
name: netLoad
<span class="token function">time</span>                <span class="token function">host</span>      netIn netOut <span class="token function">service</span>
----                ----      ----- ------ -------
<span class="token number">1532658769048100401</span> <span class="token number">127.0</span>.0.1 13m   521K   app.service.about

<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from serviceLoad
name: serviceLoad
<span class="token function">time</span>                cpu   <span class="token function">host</span>      load mem   qps  rt   <span class="token function">service</span>
----                ---   ----      ---- ---   ---  --   -------
<span class="token number">1532658713805369067</span> <span class="token number">45.23</span> <span class="token number">127.0</span>.0.2 <span class="token number">1.21</span> 4145m <span class="token number">1341</span> <span class="token number">1312</span> app.service.about
<span class="token number">1532658718726259226</span> <span class="token number">45.23</span> <span class="token number">127.0</span>.0.1 <span class="token number">1.21</span> 4145m <span class="token number">1341</span> <span class="token number">1312</span> app.service.about
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="a-备份所有的数据库" tabindex="-1"><a class="header-anchor" href="#a-备份所有的数据库" aria-hidden="true">#</a> a. 备份所有的数据库</h4><p>将influxdb中的所有的数据库都备份下来，不加任何的参数</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>influxd backup <span class="token parameter variable">-portable</span> /tmp/data/total
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="b-备份指定数据库" tabindex="-1"><a class="header-anchor" href="#b-备份指定数据库" aria-hidden="true">#</a> b. 备份指定数据库</h4><p>如果只想要备份上面的yhhblog数据库, 添加 <code>-database</code> 参数指定即可</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># influxd backup -portable -database yhhblog /tmp/data/yhhblog</span>

<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 backing up metastore to /tmp/data/yhhblog/meta.00
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 backing up <span class="token assign-left variable">db</span><span class="token operator">=</span>yhhblog
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 backing up <span class="token assign-left variable">db</span><span class="token operator">=</span>yhhblog <span class="token assign-left variable">rp</span><span class="token operator">=</span>autogen <span class="token assign-left variable">shard</span><span class="token operator">=</span><span class="token number">10</span> to /tmp/data/yhhblog/yhhblog.autogen.00010.00 since 0001-01-01T00:00:00Z
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 backup complete:
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 	/tmp/data/yhhblog/20180727T023815Z.meta
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 	/tmp/data/yhhblog/20180727T023815Z.s10.tar.gz
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:38:15 	/tmp/data/yhhblog/20180727T023815Z.manifest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="c-备份数据库中指定时间段的数据" tabindex="-1"><a class="header-anchor" href="#c-备份数据库中指定时间段的数据" aria-hidden="true">#</a> c. 备份数据库中指定时间段的数据</h4><p>对上面的数据，只备份部分时间满足要求的数据，可以添加start/end参数</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># influxd backup -portable -database yhhblog -start 2018-07-27T2:31:57Z -end 2018-07-27T2:32:59Z  /tmp/data/yhhblog_per</span>

<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 backing up metastore to /tmp/data/yhhblog_per/meta.00
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 backing up <span class="token assign-left variable">db</span><span class="token operator">=</span>yhhblog
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 backing up <span class="token assign-left variable">db</span><span class="token operator">=</span>yhhblog <span class="token assign-left variable">rp</span><span class="token operator">=</span>autogen <span class="token assign-left variable">shard</span><span class="token operator">=</span><span class="token number">10</span> to /tmp/data/yhhblog_per/yhhblog.autogen.00010.00 with boundaries <span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token number">2018</span>-07-27T02:31:57Z, <span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token number">2018</span>-07-27T02:32:59Z
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 backup complete:
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 	/tmp/data/yhhblog_per/20180727T024214Z.meta
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 	/tmp/data/yhhblog_per/20180727T024214Z.s10.tar.gz
<span class="token number">2018</span>/07/27 <span class="token number">10</span>:42:14 	/tmp/data/yhhblog_per/20180727T024214Z.manifest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在备份ok了，问题就是如何确认备份的问题有没有问题呢，备份后的数据如何恢复呢？</p><h2 id="ii-恢复" tabindex="-1"><a class="header-anchor" href="#ii-恢复" aria-hidden="true">#</a> II. 恢复</h2><p>命令如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>influxd restore 
    <span class="token punctuation">[</span> <span class="token parameter variable">-db</span> <span class="token operator">&lt;</span>db_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span>       --<span class="token operator">&gt;</span> 待恢复的数据库<span class="token punctuation">(</span>备份中的数据库名<span class="token punctuation">)</span>
    <span class="token parameter variable">-portable</span> <span class="token operator">|</span> <span class="token parameter variable">-online</span>
    <span class="token punctuation">[</span> <span class="token parameter variable">-host</span> <span class="token operator">&lt;</span>host:port<span class="token operator">&gt;</span> <span class="token punctuation">]</span>    --<span class="token operator">&gt;</span> influxdb 的服务器
    <span class="token punctuation">[</span> <span class="token parameter variable">-newdb</span> <span class="token operator">&lt;</span>newdb_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span>  --<span class="token operator">&gt;</span> 恢复到influxdb中的数据库名
    <span class="token punctuation">[</span> <span class="token parameter variable">-rp</span> <span class="token operator">&lt;</span>rp_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span>        --<span class="token operator">&gt;</span> 备份中的保留策略
    <span class="token punctuation">[</span> <span class="token parameter variable">-newrp</span> <span class="token operator">&lt;</span>newrp_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span>  --<span class="token operator">&gt;</span> 恢复的保留策略
    <span class="token punctuation">[</span> <span class="token parameter variable">-shard</span> <span class="token operator">&lt;</span>shard_ID<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
    <span class="token operator">&lt;</span>path-to-backup-files<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先拿简单的方式来演示恢复策略，并查看下上面的备份数据是否有问题</p><h3 id="_1-恢复到不存在的database" tabindex="-1"><a class="header-anchor" href="#_1-恢复到不存在的database" aria-hidden="true">#</a> 1. 恢复到不存在的database</h3><p>下面演示下将前面的导出的备份，恢复到一个新的数据库 yhhblog_bk上，执行命令如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>influxd restore <span class="token parameter variable">-portable</span> <span class="token parameter variable">-db</span> yhhblog <span class="token parameter variable">-newdb</span> yhhblog_bk yhhblog_per
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>顺带验证下上面备份的数据是否有问题，注意到我们恢复的是时间片段的数据备份，因此恢复的数据，应该会排除掉不再上面日期内的数据</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">databases</span>
name: <span class="token keyword">databases</span>
name
<span class="token comment">----</span>
_internal
yhhblog
yhhblog_bk
<span class="token operator">&gt;</span> <span class="token keyword">use</span> yhhblog_bk
<span class="token keyword">Using</span> <span class="token keyword">database</span> yhhblog_bk
<span class="token operator">&gt;</span> <span class="token keyword">show</span> measurements
name: measurements
name
<span class="token comment">----</span>
netLoad
serviceLoad
<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> netLoad
name: netLoad
<span class="token keyword">time</span>                host      netIn netOut service
<span class="token comment">----                ----      ----- ------ -------</span>
<span class="token number">1532658769048100401</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">13</span>m   <span class="token number">521</span>K   app<span class="token punctuation">.</span>service<span class="token punctuation">.</span>about
<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> serviceLoad
name: serviceLoad
<span class="token keyword">time</span>                cpu   host      <span class="token keyword">load</span> mem   qps  rt   service
<span class="token comment">----                ---   ----      ---- ---   ---  --   -------</span>
<span class="token number">1532658718726259226</span> <span class="token number">45.23</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">1.21</span> <span class="token number">4145</span>m <span class="token number">1341</span> <span class="token number">1312</span> app<span class="token punctuation">.</span>service<span class="token punctuation">.</span>about
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意看前面serviceLoad里面只有一条数据, 即表明我们按照时间进行备份没啥问题</p><h3 id="_2-恢复到存在的db" tabindex="-1"><a class="header-anchor" href="#_2-恢复到存在的db" aria-hidden="true">#</a> 2. 恢复到存在的DB</h3><p>看官网恢复的文档中，如果想将备份恢复到一个已经存在的database中时，并不是上面那么简单的就可以了，这里采用的一个策略是西安备份到一个临时的db中；然后将临时DB中的数据写入已存在的db中</p><p>具体的演示步骤如下 （注意本小结的执行可以直接依赖前面恢复的备份数据库中）</p><p>将备份恢复到已经存在的数据库 yhhblogNew 中</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 首先是将备份恢复到一个不存在的数据库 yhhblog_bk 中</span>
influxd restore <span class="token parameter variable">-portable</span> <span class="token parameter variable">-db</span> yhhblog <span class="token parameter variable">-newdb</span> yhhblog_bk yhhblog_per
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>进入 influx 控制台，执行拷贝和删除临时数据库</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 准备 yhhblogNew 数据库</span>
<span class="token operator">&gt;</span> create database yhhblogNew

<span class="token comment"># 将临时数据库中的数据导入已存在的数据库中</span>
<span class="token operator">&gt;</span> use yhhblog_bk
<span class="token operator">&gt;</span> SELECT * INTO yhhblogNew<span class="token punctuation">..</span>:MEASUREMENT FROM /.*/ GROUP BY *
<span class="token operator">&gt;</span> drop yhhblog_bk
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-保留策略已存在时-恢复" tabindex="-1"><a class="header-anchor" href="#_3-保留策略已存在时-恢复" aria-hidden="true">#</a> 3. 保留策略已存在时，恢复</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>influxd restore <span class="token parameter variable">-portable</span> <span class="token parameter variable">-db</span> yhhblog <span class="token parameter variable">-newdb</span> yhhblog_tmp <span class="token parameter variable">-rp</span> autogen <span class="token parameter variable">-newrp</span> autogen_tmp  yhhblog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>进入influx控制台，执行拷贝</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token operator">&gt;</span> <span class="token keyword">user</span> yhhblog_tmp
<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">INTO</span> yhhblogNew<span class="token punctuation">.</span>autogen<span class="token punctuation">.</span>:MEASUREMENT <span class="token keyword">FROM</span> <span class="token operator">/</span>yhhblog_tmp<span class="token punctuation">.</span>autogen_tmp<span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">/</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token operator">*</span>
<span class="token operator">&gt;</span> <span class="token keyword">drop</span> <span class="token keyword">database</span> yhhblog_tmp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-其他" tabindex="-1"><a class="header-anchor" href="#_4-其他" aria-hidden="true">#</a> 4. 其他</h3><p>官方还写了其他两种恢复方式，一个被废弃，一个离线的会导致数据丢失，也不推荐使用，而现在大部分的博文中备份和恢复都是这种过时的方案，不太友好，这里不详细叙述</p>`,39);function k(h,g){const n=i("ExternalLinkIcon");return p(),t("div",null,[d,a("p",null,[s("参考： "),a("a",b,[s("influxdb backup and restore"),l(n)])]),u,m,o(" more "),v])}const y=e(c,[["render",k],["__file","03.180727-时序数据库InfluxDB之备份和恢复策略.html.vue"]]);export{y as default};
